

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sitara Builders | Enterprise Recovery CRM</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
/* ========== GLOBAL RESET & TYPOGRAPHY ========== */
:root {
  --primary: #1a56db;
  --primary-dark: #1e429f;
  --primary-light: #3f83f8;
  --secondary: #047857;
  --secondary-dark: #065f46;
  --danger: #dc2626;
  --danger-dark: #991b1b;
  --warning: #f59e0b;
  --warning-dark: #d97706;
  --success: #10b981;
  --success-dark: #059669;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --gray-900: #111827;
  
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  
  --radius-sm: 0.25rem;
  --radius: 0.5rem;
  --radius-md: 0.75rem;
  --radius-lg: 1rem;
  --radius-xl: 1.5rem;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--gray-50);
  color: var(--gray-900);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ========== NOTIFICATION SYSTEM ========== */
.notification-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-width: 400px;
}

.notification {
  padding: 16px 20px;
  border-radius: var(--radius-md);
  background: white;
  box-shadow: var(--shadow-xl);
  border-left: 4px solid var(--primary);
  transform: translateX(120%);
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  gap: 12px;
}

.notification.show {
  transform: translateX(0);
  opacity: 1;
}

.notification.success {
  border-left-color: var(--success);
}

.notification.error {
  border-left-color: var(--danger);
}

.notification.warning {
  border-left-color: var(--warning);
}

.notification-icon {
  font-size: 20px;
}

.notification-content {
  flex: 1;
}

.notification-title {
  font-weight: 600;
  font-size: 0.875rem;
  color: var(--gray-900);
  margin-bottom: 4px;
}

.notification-message {
  font-size: 0.875rem;
  color: var(--gray-600);
}

.notification-close {
  background: none;
  border: none;
  color: var(--gray-400);
  cursor: pointer;
  padding: 4px;
  font-size: 18px;
  transition: color 0.2s;
}

.notification-close:hover {
  color: var(--gray-600);
}

/* ========== HEADER ========== */
.header {
  background: linear-gradient(135deg, var(--gray-900) 0%, var(--gray-800) 100%);
  color: white;
  padding: 20px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: var(--shadow-lg);
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  position: sticky;
  top: 0;
  z-index: 1000;
}

.logo {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo-icon {
  font-size: 28px;
  color: var(--primary-light);
}

.logo-text {
  display: flex;
  flex-direction: column;
}

.logo-title {
  font-size: 1.5rem;
  font-weight: 700;
  letter-spacing: -0.01em;
  background: linear-gradient(90deg, #fff 0%, var(--primary-light) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.logo-subtitle {
  font-size: 0.75rem;
  color: var(--gray-400);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.nav {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 8px;
}

.nav-btn {
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.12);
  color: var(--gray-200);
  padding: 10px 20px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 0.95rem;
  font-weight: 500;
  transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
}

.nav-btn:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.nav-btn.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
}

.header-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

/* ========== MAIN CONTAINER ========== */
.container {
  max-width: 1600px;
  margin: 32px auto;
  padding: 0 24px;
  min-height: calc(100vh - 200px);
}

/* ========== SECTIONS ========== */
.section {
  display: none;
  opacity: 0;
  transform: translateY(10px);
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.section.active {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

/* ========== CARDS ========== */
.card {
  background: white;
  border-radius: var(--radius-lg);
  padding: 28px;
  box-shadow: var(--shadow-md);
  margin-bottom: 24px;
  border: 1px solid var(--gray-200);
  transition: all 0.25s ease;
}

.card:hover {
  box-shadow: var(--shadow-lg);
}

/* ========== TYPOGRAPHY ========== */
h1, h2, h3, h4, h5, h6 {
  color: var(--gray-900);
  font-weight: 700;
  line-height: 1.2;
}

h1 {
  font-size: 2rem;
  margin-bottom: 1.5rem;
}

h2 {
  font-size: 1.5rem;
  margin-bottom: 1rem;
}

h3 {
  font-size: 1.25rem;
  margin-bottom: 0.75rem;
}

/* ========== FORMS ========== */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--gray-700);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.form-control {
  padding: 12px 16px;
  border-radius: var(--radius);
  border: 2px solid var(--gray-300);
  font-size: 0.95rem;
  background: white;
  transition: all 0.2s;
  font-family: inherit;
  width: 100%;
}

.form-control:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-control:disabled {
  background: var(--gray-100);
  color: var(--gray-500);
  cursor: not-allowed;
}

textarea.form-control {
  min-height: 100px;
  resize: vertical;
}

/* ========== BUTTONS ========== */
.btn {
  padding: 12px 24px;
  border-radius: var(--radius);
  border: none;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.95rem;
  transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  line-height: 1;
  white-space: nowrap;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.btn-secondary {
  background: linear-gradient(135deg, var(--gray-500), var(--gray-600));
  color: white;
}

.btn-success {
  background: linear-gradient(135deg, var(--success), var(--success-dark));
  color: white;
}

.btn-danger {
  background: linear-gradient(135deg, var(--danger), var(--danger-dark));
  color: white;
}

.btn-warning {
  background: linear-gradient(135deg, var(--warning), var(--warning-dark));
  color: white;
}

.btn-sm {
  padding: 8px 16px;
  font-size: 0.85rem;
}

.btn-icon {
  padding: 10px;
  width: 40px;
  height: 40px;
}

.btn-group {
  display: flex;
  gap: 8px;
}

.action-btn {
  padding: 6px 12px;
  border-radius: var(--radius-sm);
  border: none;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 600;
  transition: all 0.2s;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.btn-edit {
  background: var(--primary);
  color: white;
}

.btn-delete {
  background: var(--danger);
  color: white;
}

.btn-view {
  background: var(--success);
  color: white;
}

/* ========== TABLES ========== */
.table-container {
  overflow-x: auto;
  border-radius: var(--radius);
  border: 1px solid var(--gray-200);
  background: white;
}

.table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 0.9rem;
}

.table th {
  padding: 16px;
  background: var(--gray-50);
  border-bottom: 2px solid var(--gray-200);
  text-align: left;
  font-weight: 700;
  color: var(--gray-700);
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  white-space: nowrap;
  position: sticky;
  top: 0;
}

.table td {
  padding: 16px;
  border-bottom: 1px solid var(--gray-100);
  vertical-align: middle;
}

.table tbody tr {
  transition: all 0.2s;
}

.table tbody tr:hover {
  background: var(--gray-50);
}

.table tbody tr:last-child td {
  border-bottom: none;
}

/* ========== STATS CARDS ========== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}

.stat-card {
  background: white;
  padding: 24px;
  border-radius: var(--radius);
  box-shadow: var(--shadow-md);
  border: 1px solid var(--gray-200);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(to bottom, var(--primary), var(--primary-light));
}

.stat-label {
  font-size: 0.875rem;
  color: var(--gray-600);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 8px;
}

.stat-value {
  font-weight: 800;
  font-size: 2rem;
  color: var(--gray-900);
  line-height: 1;
}

.stat-change {
  font-size: 0.75rem;
  margin-top: 8px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.stat-change.positive {
  color: var(--success);
}

.stat-change.negative {
  color: var(--danger);
}

/* ========== BADGES ========== */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 4px 12px;
  border-radius: 20px;
  font-weight: 600;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.badge-primary {
  background: linear-gradient(135deg, var(--primary-light), var(--primary));
  color: white;
}

.badge-success {
  background: linear-gradient(135deg, var(--success), var(--success-dark));
  color: white;
}

.badge-warning {
  background: linear-gradient(135deg, var(--warning), var(--warning-dark));
  color: white;
}

.badge-danger {
  background: linear-gradient(135deg, var(--danger), var(--danger-dark));
  color: white;
}

.badge-info {
  background: linear-gradient(135deg, var(--gray-400), var(--gray-500));
  color: white;
}

/* ========== MODALS ========== */
.modal {
  position: fixed;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(15, 23, 42, 0.9);
  z-index: 2000;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.modal.show {
  display: flex;
  opacity: 1;
}

.modal-content {
  width: min(1200px, 96%);
  max-height: 90vh;
  overflow: hidden;
  background: white;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl);
  display: flex;
  flex-direction: column;
  transform: translateY(-20px);
  transition: transform 0.3s ease;
}

.modal.show .modal-content {
  transform: translateY(0);
}

.modal-header {
  padding: 24px;
  border-bottom: 1px solid var(--gray-200);
  background: var(--gray-50);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--gray-900);
  margin: 0;
}

.modal-body {
  padding: 24px;
  overflow-y: auto;
  flex: 1;
}

.modal-footer {
  padding: 24px;
  border-top: 1px solid var(--gray-200);
  background: var(--gray-50);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

/* ========== TABS ========== */
.tabs {
  display: flex;
  border-bottom: 2px solid var(--gray-200);
  margin-bottom: 24px;
}

.tab {
  padding: 12px 24px;
  background: none;
  border: none;
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--gray-600);
  cursor: pointer;
  position: relative;
  transition: all 0.2s;
}

.tab:hover {
  color: var(--primary);
}

.tab.active {
  color: var(--primary);
}

.tab.active::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  width: 100%;
  height: 2px;
  background: var(--primary);
}

/* ========== FOLLOW-UP CARDS ========== */
.followup-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.followup-card {
  background: white;
  border-radius: var(--radius);
  padding: 20px;
  border: 1px solid var(--gray-200);
  box-shadow: var(--shadow-sm);
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.followup-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
}

.followup-card.urgent::before {
  background: linear-gradient(to bottom, var(--danger), var(--danger-dark));
}

.followup-card.high::before {
  background: linear-gradient(to bottom, var(--warning), var(--warning-dark));
}

.followup-card.medium::before {
  background: linear-gradient(to bottom, var(--primary), var(--primary-light));
}

.followup-card.low::before {
  background: linear-gradient(to bottom, var(--success), var(--success-dark));
}

.followup-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* ========== ALERTS ========== */
.alert {
  padding: 16px;
  border-radius: var(--radius);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.alert-success {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
  border: 1px solid var(--success);
  color: var(--success-dark);
}

.alert-warning {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1));
  border: 1px solid var(--warning);
  color: var(--warning-dark);
}

.alert-danger {
  background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(153, 27, 27, 0.1));
  border: 1px solid var(--danger);
  color: var(--danger-dark);
}

.alert-info {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(30, 66, 159, 0.1));
  border: 1px solid var(--primary);
  color: var(--primary-dark);
}

/* ========== UTILITY CLASSES ========== */
.text-primary { color: var(--primary); }
.text-success { color: var(--success); }
.text-danger { color: var(--danger); }
.text-warning { color: var(--warning); }
.text-muted { color: var(--gray-500); }

.bg-primary { background: var(--primary); }
.bg-success { background: var(--success); }
.bg-danger { background: var(--danger); }
.bg-warning { background: var(--warning); }

.font-bold { font-weight: 700; }
.font-semibold { font-weight: 600; }

.text-sm { font-size: 0.875rem; }
.text-xs { font-size: 0.75rem; }

.mb-1 { margin-bottom: 0.5rem; }
.mb-2 { margin-bottom: 1rem; }
.mb-3 { margin-bottom: 1.5rem; }
.mb-4 { margin-bottom: 2rem; }

.mt-1 { margin-top: 0.5rem; }
.mt-2 { margin-top: 1rem; }
.mt-3 { margin-top: 1.5rem; }
.mt-4 { margin-top: 2rem; }

.d-flex { display: flex; }
.align-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-1 { gap: 0.5rem; }
.gap-2 { gap: 1rem; }
.gap-3 { gap: 1.5rem; }

.w-100 { width: 100%; }

.cursor-pointer { cursor: pointer; }

/* ========== SEARCH & FILTERS ========== */
.search-box {
  position: relative;
  max-width: 300px;
}

.search-input {
  width: 100%;
  padding: 12px 16px 12px 44px;
  border-radius: var(--radius);
  border: 2px solid var(--gray-300);
  font-size: 0.95rem;
  transition: all 0.2s;
}

.search-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.search-icon {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gray-400);
  pointer-events: none;
}

.filter-group {
  display: flex;
  gap: 12px;
  align-items: center;
}

.filter-select {
  padding: 10px 16px;
  border-radius: var(--radius);
  border: 2px solid var(--gray-300);
  background: white;
  font-size: 0.95rem;
  min-width: 160px;
}

/* ========== LOADING STATES ========== */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid var(--gray-300);
  border-radius: 50%;
  border-top-color: var(--primary);
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ========== RESPONSIVE DESIGN ========== */
@media (max-width: 1200px) {
  .container {
    padding: 0 20px;
  }
  
  .form-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 992px) {
  .header {
    flex-direction: column;
    gap: 16px;
    padding: 16px;
  }
  
  .nav {
    justify-content: center;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .modal-content {
    width: 95%;
    margin: 16px;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .followup-grid {
    grid-template-columns: 1fr;
  }
  
  .btn-group {
    flex-wrap: wrap;
  }
}

@media (max-width: 576px) {
  .container {
    padding: 0 16px;
  }
  
  .card {
    padding: 20px;
  }
  
  .modal-header,
  .modal-body,
  .modal-footer {
    padding: 20px;
  }
  
  .table th,
  .table td {
    padding: 12px;
  }
}
</style>
</head>
<body>

<!-- Notification Container -->
<div id="notificationContainer" class="notification-container"></div>

<!-- HEADER -->
<div class="header">
  <div class="logo">
    <div class="logo-icon">üè¢</div>
    <div class="logo-text">
      <div class="logo-title">Sitara Builders</div>
      <div class="logo-subtitle">Enterprise Recovery CRM</div>
    </div>
  </div>
  
  <div class="nav">
    <button class="nav-btn active" data-section="dashboard" onclick="showSection('dashboard')">
      üìä Dashboard
    </button>
    <button class="nav-btn" data-section="customers" onclick="showSection('customers')">
      üë• Customers
    </button>
    <button class="nav-btn" data-section="projects" onclick="showSection('projects')">
      üèó Projects
    </button>

    <button class="nav-btn" data-section="inventory" onclick="showSection('inventory')">
    üì¶ Inventory
  </button>
    <button class="nav-btn" data-section="interactions" onclick="showSection('interactions')">
      üí¨ Interactions
    </button>
    <button class="nav-btn" data-section="receipts" onclick="showSection('receipts')">
      üí∞ Receipts
    </button>
    <button class="nav-btn" data-section="reports" onclick="showSection('reports')">
      üìà Reports
    </button>
  </div>
  
  <div class="header-actions">
    <button class="nav-btn" onclick="exportAllData()" title="Export All Data">
      üì§ Export
    </button>
    <button class="nav-btn" onclick="openBackupModal()" title="Backup & Restore">
      üíæ Backup
    </button>
    <input id="importFile" type="file" accept=".json" style="display: none;" onchange="handleImport(event)">
    <button class="nav-btn" onclick="document.getElementById('importFile').click()" title="Import Data">
      üì• Import
    </button>
  </div>
</div>



<!-- Add Inventory Modal -->
<div id="addInventoryModal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h3 class="modal-title">üì¶ Add Inventory Item</h3>
      <button class="btn btn-sm btn-secondary" onclick="closeAddInventoryModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="inventoryForm" class="form-grid">
        <div class="form-group">
          <label class="form-label">Master Project *</label>
          <select name="projectName" id="invProjectName" class="form-control" required
                  onchange="updateUnitNumber()">
            <option value="">Select Project</option>
            <!-- Will be populated -->
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Unit/Shop Number *</label>
          <input type="text" name="unit" id="invUnit" class="form-control" required>
        </div>
        <div class="form-group">
          <label class="form-label">Unit Type *</label>
          <select name="unitType" class="form-control" required>
            <option value="shop">Shop</option>
            <option value="office">Office</option>
            <option value="apartment">Apartment</option>
            <option value="plot">Plot</option>
            <option value="warehouse">Warehouse</option>
            <option value="showroom">Showroom</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Marlas *</label>
          <input type="number" step="0.01" name="marlas" id="invMarlas" 
                 class="form-control" required oninput="calculateInventoryValue()">
        </div>
        <div class="form-group">
          <label class="form-label">Rate per Marla *</label>
          <input type="number" step="0.01" name="rate" id="invRate" 
                 class="form-control" required oninput="calculateInventoryValue()">
        </div>
        <div class="form-group">
          <label class="form-label">Sale Value</label>
          <input type="number" step="0.01" name="saleValue" id="invSaleValue" 
                 class="form-control" readonly style="background: var(--gray-100);">
        </div>
        <div class="form-group">
          <label class="form-label">Status *</label>
          <select name="status" class="form-control" required>
            <option value="available">Available</option>
            <option value="reserved">Reserved</option>
            <option value="blocked">Blocked</option>
            <option value="sold">Sold</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea name="notes" class="form-control" rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeAddInventoryModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitInventoryForm()">Add to Inventory</button>
    </div>
  </div>
</div>




<!-- MAIN CONTAINER -->
<div class="container">
  
  <!-- DASHBOARD SECTION -->
  <div id="dashboard" class="section active">
    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Customers</div>
        <div id="totalCustomers" class="stat-value">0</div>
        <div id="customersChange" class="stat-change"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Active Projects</div>
        <div id="totalProjects" class="stat-value">0</div>
        <div id="projectsChange" class="stat-change"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Sale Value</div>
        <div id="totalSaleValue" class="stat-value">‚Ç®0</div>
        <div id="saleValueChange" class="stat-change"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Received</div>
        <div id="totalReceived" class="stat-value">‚Ç®0</div>
        <div id="receivedChange" class="stat-change"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Receivable</div>
        <div id="totalReceivable" class="stat-value">‚Ç®0</div>
        <div id="receivableChange" class="stat-change"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Overdue</div>
        <div id="totalOverdue" class="stat-value" style="color: var(--danger);">‚Ç®0</div>
        <div id="overdueChange" class="stat-change"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Future Receivable</div>
        <div id="totalFuture" class="stat-value" style="color: var(--primary);">‚Ç®0</div>
        <div id="futureChange" class="stat-change"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Brokers</div>
        <div id="totalBrokers" class="stat-value">0</div>
        <div id="brokersChange" class="stat-change"></div>
      </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="card mb-4">
      <h2 class="mb-3">‚ö° Quick Actions</h2>
      <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-primary" onclick="openAddCustomerModal()">
          üë§ Add Customer
        </button>
        <button class="btn btn-primary" onclick="openAddProjectModal()">
          üèó Add Project
        </button>
        <button class="btn btn-primary" onclick="openAddInteractionModal()">
          üí¨ Log Interaction
        </button>
        <button class="btn btn-primary" onclick="openAddReceiptModal()">
          üí∞ Add Receipt
        </button>
        <button class="btn btn-success" onclick="showSection('reports')">
          üìä Generate Report
        </button>
      </div>
    </div>
    
    <!-- Follow-up Required -->
    <div class="card mb-4">
      <div class="d-flex justify-between align-center mb-3">
        <h2>üîî Follow-up Required</h2>
        <div class="d-flex align-center gap-2">
          <span id="followupStats" class="text-muted">0 follow-ups</span>
          <button class="btn btn-sm btn-primary" onclick="showSection('interactions')">
            View All
          </button>
        </div>
      </div>
      
      <div class="followup-grid" id="followupLeads">
        <!-- Follow-up cards will be populated dynamically -->
      </div>
    </div>
    
    <!-- Recent Activities -->
    <div class="card">
      <h2 class="mb-3">üìã Recent Activities</h2>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Description</th>
              <th>Contact</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="recentActivities">
            <!-- Recent activities will be populated dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- CUSTOMERS SECTION -->
  <div id="customers" class="section">
    <div class="card">
      <div class="d-flex justify-between align-center mb-4">
        <h2>üë• Customer Management</h2>
        <button class="btn btn-primary" onclick="openAddCustomerModal()">
          üë§ Add New Customer
        </button>
      </div>
      
      <!-- Filters -->
      <div class="d-flex justify-between align-center mb-4">
        <div class="search-box">
          <input type="text" id="customerSearch" class="search-input" 
                 placeholder="Search customers..." oninput="filterCustomersTable()">
          <span class="search-icon">üîç</span>
        </div>
        
        <div class="filter-group">
          <select id="customerTypeFilter" class="filter-select" onchange="filterCustomersTable()">
            <option value="all">All Types</option>
            <option value="customer">Customers</option>
            <option value="broker">Brokers</option>
            <option value="both">Both</option>
          </select>
          
          <select id="customerStatusFilter" class="filter-select" onchange="filterCustomersTable()">
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
          
          <button class="btn btn-success" onclick="exportTable('customersTable', 'Customers')">
            üì§ Export
          </button>
        </div>
      </div>
      
      <!-- Customers Table -->
      <div class="table-container">
        <table id="customersTable" class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Phone</th>
              <th>CNIC</th>
              <th>Type</th>
              <th>Projects</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Customers will be populated dynamically -->
          </tbody>
        </table>
      </div>
      
      <div id="customerPagination" class="d-flex justify-center align-center mt-3">
        <!-- Pagination will be populated dynamically -->
      </div>
    </div>
  </div>
  
  <!-- PROJECTS SECTION -->
  <div id="projects" class="section">
    <div class="card">
      <div class="d-flex justify-between align-center mb-4">
        <h2>üèó Project Management</h2>
        <button class="btn btn-primary" onclick="openAddProjectModal()">
          üèó Add New Project
        </button>
      </div>
      
      <!-- Filters -->
      <div class="d-flex justify-between align-center mb-4">
        <div class="search-box">
          <input type="text" id="projectSearch" class="search-input" 
                 placeholder="Search projects..." oninput="filterProjectsTable()">
          <span class="search-icon">üîç</span>
        </div>
        
        <div class="filter-group">
          <select id="projectStatusFilter" class="filter-select" onchange="filterProjectsTable()">
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
          
          <button class="btn btn-success" onclick="exportTable('projectsTable', 'Projects')">
            üì§ Export
          </button>
        </div>
      </div>
      
      <!-- Projects Table -->
      <div class="table-container">
        <table id="projectsTable" class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Customer</th>
              <th>Broker</th>
              <th>Project</th>
              <th>Unit</th>
              <th>Sale Value</th>
              <th>Received</th>
              <th>Balance</th>
              <th>Overdue</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Projects will be populated dynamically -->
          </tbody>
        </table>
      </div>
      
      <div id="projectPagination" class="d-flex justify-center align-center mt-3">
        <!-- Pagination will be populated dynamically -->
      </div>
    </div>
  </div>
  
  <!-- INTERACTIONS SECTION -->
  <div id="interactions" class="section">
  <div class="card">
    <!-- Lead Tracking Dashboard -->
    <div class="mb-4">
      <h3 style="margin-bottom: 16px;">üìä Lead Tracking Dashboard</h3>
      <div id="leadsDashboard"></div>
    </div>
    
    <!-- Separator -->
    <hr style="margin: 32px 0; border: none; border-top: 2px solid #e0e0e0;">
    
    <!-- Interaction Tracking Section -->
    <div class="d-flex justify-between align-center mb-4">
      <h2 style="margin: 0;">üí¨ Interaction Tracking</h2>
      <button class="btn btn-primary" onclick="openAddInteractionModal()">
        üí¨ Log New Interaction
      </button>
    </div>
    
    <!-- Filters -->
    <div class="d-flex justify-between align-center mb-4" style="gap: 16px; flex-wrap: wrap;">
      <div class="search-box" style="flex: 1; min-width: 250px;">
        <input type="text" id="interactionSearch" class="search-input" 
               placeholder="Search interactions..." oninput="filterInteractionsTable()">
        <span class="search-icon">üîç</span>
      </div>
      
      <div class="filter-group" style="display: flex; gap: 12px; flex-wrap: wrap;">
        <select id="interactionTypeFilter" class="filter-select" onchange="filterInteractionsTable()">
          <option value="all">All Types</option>
          <option value="call">Phone Call</option>
          <option value="whatsapp">WhatsApp</option>
          <option value="sms">SMS</option>
          <option value="email">Email</option>
          <option value="meeting">Meeting</option>
          <option value="site_visit">Site Visit</option>
        </select>
        
        <select id="interactionStatusFilter" class="filter-select" onchange="filterInteractionsTable()">
          <option value="all">All Status</option>
          <option value="follow_up">Follow Up</option>
          <option value="no_follow_up">No Follow Up</option>
          <option value="resolved">Resolved</option>
        </select>
        
        <button class="btn btn-success" onclick="exportTable('interactionsTable', 'Interactions')">
          üì§ Export
        </button>
      </div>
    </div>
    
    <!-- Interactions Table -->
    <div class="table-container">
      <table id="interactionsTable" class="table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Contact</th>
            <th>Type</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Interactions will be populated dynamically -->
        </tbody>
      </table>
    </div>
    
    <div id="interactionPagination" class="d-flex justify-center align-center mt-3">
      <!-- Pagination will be populated dynamically -->
    </div>
  </div>
</div>
  
  <!-- RECEIPTS SECTION -->
  <div id="receipts" class="section">
    <div class="card">
      <div class="d-flex justify-between align-center mb-4">
        <h2>üí∞ Receipt Management</h2>
        <button class="btn btn-primary" onclick="openAddReceiptModal()">
          üí∞ Add New Receipt
        </button>
      </div>
      
      <!-- Filters -->
      <div class="d-flex justify-between align-center mb-4">
        <div class="search-box">
          <input type="text" id="receiptSearch" class="search-input" 
                 placeholder="Search receipts..." oninput="filterReceiptsTable()">
          <span class="search-icon">üîç</span>
        </div>
        
        <div class="filter-group">
          <select id="receiptMethodFilter" class="filter-select" onchange="filterReceiptsTable()">
            <option value="all">All Methods</option>
            <option value="cash">Cash</option>
            <option value="bank_transfer">Bank Transfer</option>
            <option value="cheque">Cheque</option>
            <option value="online">Online</option>
          </select>
          
          <input type="date" id="receiptDateFilter" class="filter-select" 
                 onchange="filterReceiptsTable()" style="min-width: 160px;">
          
          <button class="btn btn-success" onclick="exportTable('receiptsTable', 'Receipts')">
            üì§ Export
          </button>
        </div>
      </div>
      
      <!-- Receipts Table -->
      <div class="table-container">
        <table id="receiptsTable" class="table">
          <thead>
            <tr>
              <th>Receipt #</th>
              <th>Date</th>
              <th>Customer</th>
              <th>Project</th>
              <th>Amount</th>
              <th>Method</th>
              <th>Reference</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Receipts will be populated dynamically -->
          </tbody>
        </table>
      </div>
      
      <div id="receiptPagination" class="d-flex justify-center align-center mt-3">
        <!-- Pagination will be populated dynamically -->
      </div>
    </div>
  </div>









  <!-- INVENTORY SECTION -->
<div id="inventory" class="section">
  <div class="card">
    <div class="d-flex justify-between align-center mb-4">
      <h2>üì¶ Inventory Management</h2>
      <button class="btn btn-primary" onclick="openAddInventoryModal()">
        üì¶ Add Inventory Item
      </button>
    </div>
    
    <!-- Filters -->
    <div class="d-flex justify-between align-center mb-4">
      <div class="search-box">
        <input type="text" id="inventorySearch" class="search-input" 
               placeholder="Search inventory..." oninput="filterInventoryTable()">
        <span class="search-icon">üîç</span>
      </div>
      
      <div class="filter-group">
        <select id="inventoryProjectFilter" class="filter-select" onchange="filterInventoryTable()">
          <option value="all">All Projects</option>
          <!-- Project options will be populated dynamically -->
        </select>
        
        <select id="inventoryStatusFilter" class="filter-select" onchange="filterInventoryTable()">
          <option value="all">All Status</option>
          <option value="available">Available</option>
          <option value="sold">Sold</option>
          <option value="reserved">Reserved</option>
          <option value="blocked">Blocked</option>
        </select>
        
        <button class="btn btn-success" onclick="exportTable('inventoryTable', 'Inventory')">
          üì§ Export
        </button>
      </div>
    </div>
    
    <!-- Inventory Table -->
    <div class="table-container">
      <table id="inventoryTable" class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Project</th>
            <th>Unit</th>
            <th>Type</th>
            <th>Marlas</th>
            <th>Rate</th>
            <th>Sale Value</th>
            <th>Status</th>
            <th>Customer</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Inventory will be populated dynamically -->
        </tbody>
      </table>
    </div>
    
    <div id="inventoryPagination" class="d-flex justify-center align-center mt-3">
      <!-- Pagination will be populated dynamically -->
    </div>
  </div>
</div>














  
  <!-- REPORTS SECTION -->
  <div id="reports" class="section">
    <div class="card">
      <h2 class="mb-4">üìà Reports & Analytics</h2>
      
      <!-- Financial Overview -->
      <div class="mb-4">
        <h3 class="mb-3">Financial Overview</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Sale Value</div>
            <div id="reportTotalSale" class="stat-value">‚Ç®0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Received</div>
            <div id="reportTotalReceived" class="stat-value">‚Ç®0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Receivable</div>
            <div id="reportTotalReceivable" class="stat-value">‚Ç®0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Overdue</div>
            <div id="reportTotalOverdue" class="stat-value" style="color: var(--danger);">‚Ç®0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Future Receivable</div>
            <div id="reportTotalFuture" class="stat-value" style="color: var(--primary);">‚Ç®0</div>
          </div>
        </div>
      </div>
      
      <!-- Report Generator -->
      <div class="mb-4">
        <h3 class="mb-3">Generate Reports</h3>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Customer Report</label>
            <select id="customerReportSelect" class="form-control">
              <option value="">Select Customer</option>
            </select>
            <button class="btn btn-primary w-100 mt-2" onclick="generateCustomerReport()">
              üìÑ Generate PDF
            </button>
          </div>
          
          <div class="form-group">
            <label class="form-label">Broker Report</label>
            <select id="brokerReportSelect" class="form-control">
              <option value="">Select Broker</option>
            </select>
            <button class="btn btn-primary w-100 mt-2" onclick="generateBrokerReport()">
              ü§ù Generate PDF
            </button>
          </div>
          
          <div class="form-group">
            <label class="form-label">Project Report</label>
            <select id="projectReportSelect" class="form-control">
              <option value="">Select Project</option>
            </select>
            <button class="btn btn-primary w-100 mt-2" onclick="generateProjectReport()">
              üèó Generate PDF
            </button>
          </div>
          
          <div class="form-group">
            <label class="form-label">Consolidated Report</label>
            <select id="consolidatedReportType" class="form-control">
              <option value="all">All Data</option>
              <option value="overdue">Overdue Only</option>
              <option value="follow_up">Follow-up Required</option>
              <option value="receivables">All Receivables</option>
            </select>
            <button class="btn btn-primary w-100 mt-2" onclick="generateConsolidatedReport()">
              üìä Generate PDF
            </button>
          
            <!-- Add this button in the Reports section -->
<button class="btn btn-warning" onclick="debugCurrentData()">
  üêõ Debug Data
</button>
            
            
            </div>
        </div>
      </div>
      
      <!-- Export Options -->
      <div>
        <h3 class="mb-3">Data Export</h3>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-success" onclick="exportAllData()">
            üíæ Export All Data (JSON)
          </button>
          <button class="btn btn-success" onclick="exportFinancialSummary()">
            üìà Export Financial Summary (Excel)
          </button>
          <button class="btn btn-success" onclick="exportFollowUpReport()">
            üîî Export Follow-up Report (PDF)
          </button>
          <button class="btn btn-success" onclick="exportOverdueReport()">
            ‚ö†Ô∏è Export Overdue Report (PDF)
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->
<!-- Add Customer Modal -->
<div id="addCustomerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">üë§ Add New Customer/Broker</h3>
      <button class="btn btn-sm btn-secondary" onclick="closeAddCustomerModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="customerForm" class="form-grid">
        <div class="form-group">
          <label class="form-label">Full Name *</label>
          <input type="text" name="name" class="form-control" required>
        </div>
        <div class="form-group">
          <label class="form-label">CNIC *</label>
          <input type="text" name="cnic" class="form-control" >
        </div>
        <div class="form-group">
          <label class="form-label">Phone *</label>
          <input type="tel" name="phone" class="form-control" >
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" name="email" class="form-control">
        </div>
        <div class="form-group">
          <label class="form-label">Company</label>
          <input type="text" name="company" class="form-control">
        </div>
        <div class="form-group">
          <label class="form-label">Address</label>
          <textarea name="address" class="form-control" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Type *</label>
          <select name="type" class="form-control" required>
            <option value="customer">Customer</option>
            <option value="broker">Broker</option>
            <option value="both">Both (Customer & Broker)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select name="status" class="form-control">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeAddCustomerModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitCustomerForm()">Save Customer</button>
    </div>
  </div>
</div>

<!-- Edit Customer Modal -->
<div id="editCustomerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">‚úèÔ∏è Edit Customer</h3>
      <button class="btn btn-sm btn-secondary" onclick="closeEditCustomerModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="editCustomerForm" class="form-grid">
        <input type="hidden" name="id" id="editCustomerId">
        <div class="form-group">
          <label class="form-label">Full Name *</label>
          <input type="text" name="name" id="editCustomerName" class="form-control" required>
        </div>
        <div class="form-group">
          <label class="form-label">CNIC *</label>
          <input type="text" name="cnic" id="editCustomerCnic" class="form-control" >
        </div>
        <div class="form-group">
          <label class="form-label">Phone *</label>
          <input type="tel" name="phone" id="editCustomerPhone" class="form-control" >
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" name="email" id="editCustomerEmail" class="form-control">
        </div>
        <div class="form-group">
          <label class="form-label">Company</label>
          <input type="text" name="company" id="editCustomerCompany" class="form-control">
        </div>
        <div class="form-group">
          <label class="form-label">Address</label>
          <textarea name="address" id="editCustomerAddress" class="form-control" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Type *</label>
          <select name="type" id="editCustomerType" class="form-control" required>
            <option value="customer">Customer</option>
            <option value="broker">Broker</option>
            <option value="both">Both</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select name="status" id="editCustomerStatus" class="form-control">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeEditCustomerModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveCustomerEdit()">Save Changes</button>
    </div>
  </div>
</div>




<div id="editBrokerModal" class="modal">
  <div class="modal-content" style="max-width: 1000px;">
    <div class="modal-header">
      <h3 class="modal-title">ü§ù Edit Broker & Projects</h3>
      <button class="btn btn-sm btn-secondary" onclick="closeEditBrokerModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <!-- Left: Broker Info -->
        <div>
          <h4 style="margin-bottom: 16px;">Broker Information</h4>
          <form id="editBrokerForm" class="form-grid">
            <input type="hidden" name="id" id="editBrokerId">
            <div class="form-group">
              <label class="form-label">Full Name *</label>
              <input type="text" name="name" id="editBrokerName" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label">Phone *</label>
              <input type="tel" name="phone" id="editBrokerPhone" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label">CNIC</label>
              <input type="text" name="cnic" id="editBrokerCnic" class="form-control">
            </div>
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" name="email" id="editBrokerEmail" class="form-control">
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select name="status" id="editBrokerStatus" class="form-control">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
          </form>
          <button class="btn btn-primary w-100 mt-3" onclick="saveBrokerEdit()">
            üíæ Save Broker Info
          </button>
        </div>
        
        <!-- Right: Assigned Projects -->
        <div>
          <h4 style="margin-bottom: 16px;">Assigned Projects</h4>
          <div id="brokerProjectsList" style="max-height: 300px; overflow-y: auto;">
            <!-- Projects will be loaded here -->
          </div>
          <div class="mt-3">
            <button class="btn btn-sm btn-outline-primary w-100" onclick="assignNewProjectToBroker()">
              Ôºã Assign New Project
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>








<!-- Add Project Modal -->
<div id="addProjectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">üèó Add New Project</h3>
      <button class="btn btn-sm btn-secondary" onclick="closeAddProjectModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="projectForm" class="form-grid">
        <div class="form-group">
          <label class="form-label">Customer *</label>
          <select name="customerId" id="projCust" class="form-control" required></select>
        </div>
        <div class="form-group">
          <label class="form-label">Broker (Optional)</label>
          <select name="brokerId" id="projBroker" class="form-control">
            <option value="">Select Broker</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Project Name *</label>
          <input type="text" name="project" class="form-control" required>
        </div>
        <div class="form-group">
          <label class="form-label">Unit/Shop # *</label>
          <input type="text" name="unit" class="form-control" required>
        </div>
        <div class="form-group">
          <label class="form-label">Marlas *</label>
          <input type="number" step="0.01" name="marlas" id="marlas" 
                 class="form-control" oninput="recalcSale()" required>
        </div>
        <div class="form-group">
          <label class="form-label">Rate per Marla *</label>
          <input type="number" step="0.01" name="rate" id="rate" 
                 class="form-control" oninput="recalcSale()" required>
        </div>
        <div class="form-group">
          <label class="form-label">Sale Value</label>
          <input type="number" step="0.01" name="sale" id="sale" 
                 class="form-control" readonly style="background: var(--gray-100);">
        </div>
        <div class="form-group">
          <label class="form-label">Installments *</label>
          <input type="number" name="installments" class="form-control" 
                 value="2" min="1" max="36" required>
        </div>
        <div class="form-group">
          <label class="form-label">Payment Cycle</label>
          <select name="cycle" class="form-control">
            <option value="monthly">Monthly</option>
            <option value="quarterly">Quarterly (3 months)</option>
            <option value="bi_annual">Bi-Annual (6 months)</option>
            <option value="annual">Annual (12 months)</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">First Due Date *</label>
          <input type="date" name="firstDue" class="form-control" required>
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select name="status" class="form-control">
            <option value="active">Active</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea name="notes" class="form-control" rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeAddProjectModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitProjectForm()">Save Project</button>
    </div>
  </div>
</div>

<!-- Add Interaction Modal -->
<div id="addInteractionModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">üí¨ Log New Interaction</h3>
      <button class="btn btn-sm btn-secondary" onclick="closeAddInteractionModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="interactionForm" class="form-grid">
        <div class="form-group">
          <label class="form-label">Contact Type *</label>
          <select id="intContactType" name="contactType" class="form-control" required 
                  onchange="toggleContactSelection()">
            <option value="customer">Customer</option>
            <option value="broker">Broker</option>
          </select>
        </div>
        <div class="form-group" id="customerSelectGroup">
          <label class="form-label">Customer *</label>
          <select name="customerId" id="intCust" class="form-control"></select>
        </div>
        <div class="form-group" id="brokerSelectGroup" style="display: none;">
          <label class="form-label">Broker *</label>
          <select name="brokerId" id="intBroker" class="form-control"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Interaction Type *</label>
          <select name="type" class="form-control" required>
            <option value="call">Phone Call</option>
            <option value="whatsapp">WhatsApp</option>
            <option value="sms">SMS</option>
            <option value="email">Email</option>
            <option value="meeting">Meeting</option>
            <option value="site_visit">Site Visit</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Status *</label>
          <select name="status" class="form-control" required>
            <option value="follow_up">Follow Up Required</option>
            <option value="no_follow_up">No Follow Up</option>
            <option value="do_not_contact">Do Not Contact</option>
            <option value="resolved">Resolved</option>
            <option value="pending">Pending</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Date & Time *</label>
          <input type="datetime-local" name="date" class="form-control" required>
        </div>
        <div class="form-group">
          <label class="form-label">Priority</label>
          <select name="priority" class="form-control">
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label class="form-label">Notes</label>
          <textarea name="notes" class="form-control" rows="4" 
                    placeholder="Detailed notes about the interaction..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Next Follow-up Date</label>
          <input type="date" name="nextFollowUp" class="form-control">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeAddInteractionModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitInteractionForm()">Log Interaction</button>
    </div>
  </div>
</div>

<!-- Add Receipt Modal -->
<div id="addReceiptModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">üí∞ Add New Receipt</h3>
      <button class="btn btn-sm btn-secondary" onclick="closeAddReceiptModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="receiptForm" class="form-grid">
        <div class="form-group">
          <label class="form-label">Customer *</label>
          <select name="customerId" id="recCust" class="form-control" required 
                  onchange="loadProjectsForReceipt()"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Project *</label>
          <select name="projectId" id="recProj" class="form-control" required></select>
        </div>
        <div class="form-group">
          <label class="form-label">Amount *</label>
          <input type="number" step="0.01" name="amount" class="form-control" required>
        </div>
        <div class="form-group">
          <label class="form-label">Date *</label>
          <input type="date" name="date" class="form-control" required>
        </div>
        <div class="form-group">
          <label class="form-label">Payment Method</label>
          <select name="method" class="form-control">
            <option value="cash">Cash</option>
            <option value="bank_transfer">Bank Transfer</option>
            <option value="cheque">Cheque</option>
            <option value="online">Online Payment</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Reference Number</label>
          <input type="text" name="ref" class="form-control" 
                 placeholder="Check #, Transaction ID, etc.">
        </div>
        <div class="form-group">
          <label class="form-label">Allocate to Installment</label>
          <select name="installmentId" id="installmentSelect" class="form-control">
            <option value="">Auto-allocate</option>
          </select>
        </div>
        <div class="form-group" style="grid-column: 1 / -1;">
          <label class="form-label">Notes</label>
          <textarea name="notes" class="form-control" rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeAddReceiptModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitReceiptForm()">Save Receipt</button>
    </div>
  </div>
</div>

<!-- View Customer Details Modal -->
<div id="viewCustomerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="viewCustomerTitle">Customer Details</h3>
      <button class="btn btn-sm btn-secondary" onclick="closeViewCustomerModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="viewCustomerContent">
        <!-- Customer details will be loaded here -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeViewCustomerModal()">Close</button>
      <button class="btn btn-primary" onclick="editCustomerFromView()">Edit</button>
    </div>
  </div>
</div>

<!-- Backup/Restore Modal -->
<div id="backupModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">üíæ Backup & Restore</h3>
      <button class="btn btn-sm btn-secondary" onclick="closeBackupModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="backupContent">
        <!-- Backup content will be loaded here -->
      </div>
    </div>
  </div>
</div>

<script>
// ===========================================
// SITARA BUILDERS CRM - ENTERPRISE EDITION
// Version 3.0 - Complete Financial CRM System
// ===========================================

// Database Configuration
const STORAGE_KEY = 'sitara_crm_v3';
const BACKUP_KEY = 'sitara_crm_backups_v3';
const MAX_BACKUPS = 50;

// Core Database Structure
// Core Database Structure
let db = {
  version: '3.1', // Update version
  customers: [],
  projects: [],
  interactions: [],
  receipts: [],
  inventory: [],
  masterProjects: [], // Add this line - for projects without customers
  settings: {
    currency: 'PKR',
    defaultCycle: 'bi_annual',
    followUpDays: [1, 3, 7, 14, 30],
    commissionRate: 1
  },
  lastUpdated: null
};



// Pagination Configuration
const ITEMS_PER_PAGE = 15;

// State Management
let currentPage = {
  customers: 1,
  projects: 1,
  interactions: 1,
  receipts: 1,
  inventory: 1
};

// Utility Functions
function generateId(prefix = 'id') {
  return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}

function formatCurrency(amount) {
  const num = Number(amount) || 0;
  return `PKR ${num.toLocaleString('en-PK', {
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  })}`;
}

function formatNumber(num) {
  return Number(num || 0).toLocaleString('en-PK');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;

}




function openCustomer(customerId) {
  console.log('Opening customer from lead card:', customerId);
  
  try {
    // Simply call the existing working function
    openCustomerModal(customerId);
  } catch (error) {
    console.error('Error in openCustomer:', error);
    showNotification('error', 'Error', 'Could not open customer details.');
  }
}




function getDateString(date = new Date()) {
  try {
    // Handle various date inputs
    let d;
    if (date instanceof Date) {
      d = date;
    } else if (typeof date === 'string' || typeof date === 'number') {
      d = new Date(date);
    } else {
      d = new Date();
    }
    
    // Ensure it's a valid date
    if (isNaN(d.getTime())) {
      d = new Date();
    }
    
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  } catch (error) {
    console.error('Error in getDateString:', error);
    // Return today's date as fallback
    const d = new Date();
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }
}

function getDateTimeString(date = new Date()) {
  const d = date instanceof Date ? date : new Date(date);
  // Ensure we return a string in YYYY-MM-DDTHH:MM format
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  const hours = String(d.getHours()).padStart(2, '0');
  const minutes = String(d.getMinutes()).padStart(2, '0');
  return `${year}-${month}-${day}T${hours}:${minutes}`;
}

function formatDate(dateStr) {
  try {
    if (!dateStr) return 'N/A';
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return 'Invalid Date';
    return date.toLocaleDateString('en-PK', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  } catch (error) {
    console.error('Error formatting date:', error);
    return 'Error';
  }
}

function formatDateTime(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleString('en-PK', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function showNotification(type, title, message, duration = 3000) {
  const container = document.getElementById('notificationContainer');
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  
  const icons = {
    success: '‚úÖ',
    error: '‚ùå',
    warning: '‚ö†Ô∏è',
    info: '‚ÑπÔ∏è'
  };
  
  notification.innerHTML = `
    <div class="notification-icon">${icons[type] || '‚ÑπÔ∏è'}</div>
    <div class="notification-content">
      <div class="notification-title">${title}</div>
      <div class="notification-message">${message}</div>
    </div>
    <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
  `;
  
  container.appendChild(notification);
  
  // Trigger animation
  setTimeout(() => notification.classList.add('show'), 10);
  
  // Auto remove
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, duration);
}









function editBroker(customerId) {
  const broker = db.customers.find(c => c.id === customerId);
  if (!broker) return;
  
  // Populate edit form
  document.getElementById('editCustomerId').value = broker.id;
  document.getElementById('editCustomerName').value = broker.name;
  document.getElementById('editCustomerCnic').value = broker.cnic;
  document.getElementById('editCustomerPhone').value = broker.phone;
  document.getElementById('editCustomerEmail').value = broker.email || '';
  document.getElementById('editCustomerCompany').value = broker.company || '';
  document.getElementById('editCustomerAddress').value = broker.address || '';
  document.getElementById('editCustomerType').value = broker.type;
  document.getElementById('editCustomerStatus').value = broker.status;
  
  document.getElementById('editCustomerModal').classList.add('show');
}







function validateEmail(email) {
  if (!email) return true; // Email is optional
  const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return regex.test(email);
}

function calculateDaysBetween(date1, date2) {
  const d1 = new Date(date1);
  const d2 = new Date(date2);
  const diffTime = Math.abs(d2 - d1);
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}


// Data Persistence
function saveToStorage() {
  try {
    db.lastUpdated = new Date().toISOString();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    createBackup();
    return true;
  } catch (e) {
    console.error('Save failed:', e);
    showNotification('error', 'Save Failed', 'Could not save data to browser storage.');
    return false;
  }
}

function loadFromStorage() {
  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      const data = JSON.parse(stored);
      
      // Merge with current structure
      Object.assign(db, data);
      
      // Ensure arrays exist
      db.customers = db.customers || [];
      db.projects = db.projects || [];
      db.interactions = db.interactions || [];
      db.receipts = db.receipts || [];
      db.settings = db.settings || {
        currency: 'PKR',
        defaultCycle: 'bi_annual',
        followUpDays: [1, 7, 14, 30],
        commissionRate: 1
      };
      
      showNotification('success', 'Data Loaded', 'CRM data loaded successfully');
    } else {
      // Initialize with empty arrays
      db = {
        version: '3.0',
        customers: [],
        projects: [],
        interactions: [],
        receipts: [],
        settings: {
          currency: 'PKR',
          defaultCycle: 'bi_annual',
          followUpDays: [1, 7, 14, 30],
          commissionRate: 1
        },
        lastUpdated: new Date().toISOString()
      };
      saveToStorage();
    }
  } catch (e) {
    console.error('Load failed:', e);
    showNotification('error', 'Load Failed', 'Could not load data from storage.');
    // Initialize with empty arrays
    db = {
      version: '3.0',
      customers: [],
      projects: [],
      interactions: [],
      receipts: [],
      settings: {
        currency: 'PKR',
        defaultCycle: 'bi_annual',
        followUpDays: [1, 7, 14, 30],
        commissionRate: 1
      },
      lastUpdated: new Date().toISOString()
    };
  }
}


// ========== MASTER PROJECT MANAGEMENT ==========

function initializeMasterProjects() {
  // Extract unique project names from existing inventory and projects
  const allProjectNames = new Set();
  
  // Get from inventory
  db.inventory.forEach(item => {
    if (item.projectName) {
      allProjectNames.add(item.projectName);
    }
  });
  
  // Get from projects
  db.projects.forEach(project => {
    if (project.name) {
      allProjectNames.add(project.name);
    }
  });
  
  // Create master projects if they don't exist
  allProjectNames.forEach(projectName => {
    const existingMaster = db.masterProjects.find(mp => mp.name === projectName);
    if (!existingMaster) {
      db.masterProjects.push({
        id: generateId('mproj'),
        name: projectName,
        description: '',
        location: '',
        totalUnits: db.inventory.filter(item => item.projectName === projectName).length,
        availableUnits: db.inventory.filter(item => 
          item.projectName === projectName && item.status === 'available'
        ).length,
        soldUnits: db.inventory.filter(item => 
          item.projectName === projectName && item.status === 'sold'
        ).length,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });
    }
  });
}

function createMasterProject(name, description = '', location = '') {
  // Check if master project already exists
  const existingMaster = db.masterProjects.find(mp => mp.name === name);
  if (existingMaster) return existingMaster;
  
  const masterProject = {
    id: generateId('mproj'),
    name: name,
    description: description,
    location: location,
    totalUnits: 0,
    availableUnits: 0,
    soldUnits: 0,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  
  db.masterProjects.push(masterProject);
  saveToStorage();
  return masterProject;
}

function updateMasterProjectStats(projectName) {
  const masterProject = db.masterProjects.find(mp => mp.name === projectName);
  if (!masterProject) return;
  
  // Count units from inventory
  const projectInventory = db.inventory.filter(item => item.projectName === projectName);
  
  masterProject.totalUnits = projectInventory.length;
  masterProject.availableUnits = projectInventory.filter(item => item.status === 'available').length;
  masterProject.soldUnits = projectInventory.filter(item => item.status === 'sold').length;
  masterProject.updatedAt = new Date().toISOString();
  
  saveToStorage();
}










function createBackup() {
  try {
    const backups = JSON.parse(localStorage.getItem(BACKUP_KEY) || '[]');
    
    backups.unshift({
      timestamp: new Date().toISOString(),
      data: JSON.parse(JSON.stringify(db)),
      version: db.version,
      summary: {
        customers: db.customers.length,
        projects: db.projects.length,
        interactions: db.interactions.length,
        receipts: db.receipts.length
      }
    });
    
    // Keep only MAX_BACKUPS backups
    if (backups.length > MAX_BACKUPS) {
      backups.length = MAX_BACKUPS;
    }
    
    localStorage.setItem(BACKUP_KEY, JSON.stringify(backups));
    return true;
  } catch (e) {
    console.warn('Backup creation failed:', e);
    return false;
  }
}















// Financial Calculations
function calculateProjectFinancials(project) {
  if (!project) return {
    totalSale: 0,
    totalReceived: 0,
    totalReceivable: 0,
    totalOverdue: 0,
    totalFuture: 0,
    percentagePaid: 0
  };
  
  // DEBUG: Log project details
  console.log('Calculating financials for project:', project.name, project.unit, {
    sale: project.sale,
    received: project.received,
    installments: project.installments?.length
  });
  
  const totalSale = Number(project.sale) || 0;
  const totalReceived = Number(project.received) || 0;
  const totalReceivable = Math.max(0, totalSale - totalReceived);
  
  let totalOverdue = 0;
  let totalFuture = 0;
  const today = getDateString();
  const todayDate = new Date(today);
  todayDate.setHours(0, 0, 0, 0);
  
  // Calculate installment-based financials
  if (project.installments && project.installments.length > 0) {
    project.installments.forEach(installment => {
      const remaining = Number(installment.amount) - (Number(installment.partialPaid) || 0);
      
      if (!installment.paid && remaining > 0) {
        const dueDate = new Date(installment.dueDate);
        dueDate.setHours(0, 0, 0, 0);
        
        if (dueDate <= todayDate) {
          totalOverdue += remaining;
        } else {
          totalFuture += remaining;
        }
      }
    });
  }
  
  // DEBUG: Log calculated values
  console.log('Financials calculated:', {
    totalSale,
    totalReceived,
    totalReceivable,
    totalOverdue,
    totalFuture,
    percentagePaid: totalSale > 0 ? ((totalReceived / totalSale) * 100) : 0
  });
  
  return {
    totalSale,
    totalReceived,
    totalReceivable,
    totalOverdue,
    totalFuture,
    percentagePaid: totalSale > 0 ? ((totalReceived / totalSale) * 100) : 0
  };
}




function calculateCustomerFinancials(customerId) {
  const masterProjects = getCustomerMasterProjects(customerId);
  
  let totalSale = 0;
  let totalReceived = 0;
  let totalReceivable = 0;
  let totalOverdue = 0;
  let totalFuture = 0;
  
  masterProjects.forEach(master => {
    totalSale += master.totalSale;
    totalReceived += master.totalReceived;
    totalReceivable += master.totalReceivable;
    totalOverdue += master.totalOverdue;
    totalFuture += master.totalFuture;
  });
  
  return {
    totalSale,
    totalReceived,
    totalReceivable,
    totalOverdue,
    totalFuture,
    percentagePaid: totalSale > 0 ? ((totalReceived / totalSale) * 100) : 0,
    masterProjects: masterProjects.length,
    totalUnits: masterProjects.reduce((sum, master) => sum + master.units.length, 0)
  };
}




// Master Project Functions
function getMasterProjects() {
  const masterProjects = {};
  
  db.projects.forEach(project => {
    const masterName = project.name;
    if (!masterProjects[masterName]) {
      masterProjects[masterName] = {
        name: masterName,
        units: [],
        totalSale: 0,
        totalReceived: 0,
        totalReceivable: 0,
        totalOverdue: 0,
        totalFuture: 0
      };
    }
    
    const financials = calculateProjectFinancials(project);
    const master = masterProjects[masterName];
    
    master.units.push({
      id: project.id,
      unit: project.unit,
      customerId: project.customerId,
      sale: financials.totalSale,
      received: financials.totalReceived,
      receivable: financials.totalReceivable,
      overdue: financials.totalOverdue,
      future: financials.totalFuture,
      installments: project.installments || []
    });
    
    master.totalSale += financials.totalSale;
    master.totalReceived += financials.totalReceived;
    master.totalReceivable += financials.totalReceivable;
    master.totalOverdue += financials.totalOverdue;
    master.totalFuture += financials.totalFuture;
  });
  
  return Object.values(masterProjects);
}

function getCustomerMasterProjects(customerId) {
  const customerProjects = db.projects.filter(p => p.customerId === customerId);
  const masterProjects = {};
  
  customerProjects.forEach(project => {
    const masterName = project.name;
    if (!masterProjects[masterName]) {
      masterProjects[masterName] = {
        name: masterName,
        units: [],
        totalSale: 0,
        totalReceived: 0,
        totalReceivable: 0,
        totalOverdue: 0,
        totalFuture: 0
      };
    }
    
    const financials = calculateProjectFinancials(project);
    const master = masterProjects[masterName];
    
    master.units.push({
      id: project.id,
      unit: project.unit || 'Unknown',
      sale: financials.totalSale,
      received: financials.totalReceived,
      receivable: financials.totalReceivable,
      overdue: financials.totalOverdue,
      future: financials.totalFuture,
      installments: project.installments || []
    });
    
    master.totalSale += financials.totalSale;
    master.totalReceived += financials.totalReceived;
    master.totalReceivable += financials.totalReceivable;
    master.totalOverdue += financials.totalOverdue;
    master.totalFuture += financials.totalFuture;
  });
  
  return Object.values(masterProjects);
}

function getMasterProjectInstallments(masterProject) {
  const allInstallments = [];

  const projectId = masterProject.id || masterProject.projectId || 'UNKNOWN_PROJECT';
  const projectName = masterProject.name || masterProject.project || 'Unknown Project';

  masterProject.units.forEach(unit => {
    if (unit.installments && unit.installments.length > 0) {
      unit.installments.forEach(inst => {
        allInstallments.push({
          ...inst,

          // üîπ Project context (CRITICAL for correct sorting)
          projectId,
          projectName,

          // üîπ Unit context
          unit: unit.unit || unit.unitNo || 'Unknown',
          unitId: unit.id || '',

          // üîπ Normalized fields
          amount: Number(inst.amount) || 0,
          partialPaid: Number(inst.partialPaid) || 0,
          number: Number(inst.number) || 0,
          dueDate: inst.dueDate || '',
          paid: Boolean(inst.paid)
        });
      });
    }
  });

  /*
    SORT ORDER:
    1Ô∏è‚É£ Project
    2Ô∏è‚É£ Unit
    3Ô∏è‚É£ Due Date
    4Ô∏è‚É£ Installment Number
  */
  return allInstallments.sort((a, b) => {

    // 1Ô∏è‚É£ Project separation (ABSOLUTE)
    if (a.projectId < b.projectId) return -1;
    if (a.projectId > b.projectId) return 1;

    // 2Ô∏è‚É£ Unit ordering within the SAME project
    if (a.unit < b.unit) return -1;
    if (a.unit > b.unit) return 1;

    // 3Ô∏è‚É£ Due date ordering within same unit
    const dateA = new Date(a.dueDate || '2100-01-01');
    const dateB = new Date(b.dueDate || '2100-01-01');

    if (dateA < dateB) return -1;
    if (dateA > dateB) return 1;

    // 4Ô∏è‚É£ Installment number
    return (a.number || 0) - (b.number || 0);
  });
}












function calculateBrokerFinancials(brokerId) {
  const brokeredProjects = db.projects.filter(p => p.brokerId === brokerId);
  
  let totalBrokeredSale = 0;
  let totalBrokeredReceived = 0;
  let totalCommission = 0;
  
  brokeredProjects.forEach(project => {
    const financials = calculateProjectFinancials(project);
    totalBrokeredSale += financials.totalSale;
    totalBrokeredReceived += financials.totalReceived;
    totalCommission += (financials.totalSale * (db.settings.commissionRate || 2.5)) / 100;
  });
  
  return {
    totalBrokeredSale,
    totalBrokeredReceived,
    totalCommission,
    commissionRate: db.settings.commissionRate || 1
  };
}

function calculateOverallFinancials() {
  const masterProjects = getMasterProjects();
  
  let totalSale = 0;
  let totalReceived = 0;
  let totalReceivable = 0;
  let totalOverdue = 0;
  let totalFuture = 0;
  
  masterProjects.forEach(master => {
    totalSale += master.totalSale;
    totalReceived += master.totalReceived;
    totalReceivable += master.totalReceivable;
    totalOverdue += master.totalOverdue;
    totalFuture += master.totalFuture;
  });
  
  return {
    totalSale,
    totalReceived,
    totalReceivable,
    totalOverdue,
    totalFuture,
    percentagePaid: totalSale > 0 ? ((totalReceived / totalSale) * 100) : 0,
    totalMasterProjects: masterProjects.length,
    totalUnits: masterProjects.reduce((sum, master) => sum + master.units.length, 0)
  };
}





function initializeInventoryFromProjects() {
  if (!db.inventory || db.inventory.length === 0) {
    const masterProjects = {};
    
    db.projects.forEach(project => {
      const key = `${project.name}|${project.unit}`;
      if (!masterProjects[key]) {
        db.inventory.push({
          id: generateId('inv'),
          projectName: project.name,
          unit: project.unit,
          unitType: 'shop', // default
          marlas: project.marlas || 0,
          rate: project.rate || 0,
          saleValue: project.sale || 0,
          status: project.status === 'active' ? 'sold' : 'available',
          customerId: project.customerId,
          notes: project.notes || '',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
        masterProjects[key] = true;
      }
    });
    
    saveToStorage();
  }
}

// Inventory functions
function openAddInventoryModal() {
  populateProjectSelects();
  document.getElementById('addInventoryModal').classList.add('show');
  
  // Add "Create New Project" option
  const projectSelect = document.getElementById('invProjectName');
  if (projectSelect) {
    const createNewOption = document.createElement('option');
    createNewOption.value = '__new__';
    createNewOption.textContent = '‚ûï Create New Project';
    projectSelect.appendChild(createNewOption);
  }
  
  updateUnitNumber();
}

function closeAddInventoryModal() {
  document.getElementById('addInventoryModal').classList.remove('show');
  document.getElementById('inventoryForm').reset();
}

function updateUnitNumber() {
  const projectName = document.getElementById('invProjectName').value;
  if (!projectName || projectName === '__new__') {
    document.getElementById('invUnit').value = '';
    return;
  }
  
  const existingUnits = db.inventory.filter(item => item.projectName === projectName);
  const nextUnit = existingUnits.length + 1;
  document.getElementById('invUnit').value = `Unit ${nextUnit}`;
}

function calculateInventoryValue() {
  const marlas = parseFloat(document.getElementById('invMarlas').value) || 0;
  const rate = parseFloat(document.getElementById('invRate').value) || 0;
  const saleValue = marlas * rate;
  document.getElementById('invSaleValue').value = saleValue.toFixed(2);
}

function submitInventoryForm() {
  const form = document.getElementById('inventoryForm');
  const formData = new FormData(form);
  
  try {
    let projectName = formData.get('projectName');
    
    // Handle new project creation
    if (projectName === '__new__') {
      const newProjectName = prompt('Enter new project name:');
      if (!newProjectName) {
        throw new Error('Project name is required');
      }
      
      // Check if project already exists
      if (db.masterProjects.find(mp => mp.name === newProjectName)) {
        throw new Error(`Project "${newProjectName}" already exists`);
      }
      
      const description = prompt('Enter project description (optional):', '');
      const location = prompt('Enter project location (optional):', '');
      
      // Create master project
      createMasterProject(newProjectName, description, location);
      projectName = newProjectName;
      
      // Update the form
      document.getElementById('invProjectName').value = newProjectName;
    }
    
    if (!projectName || !formData.get('unit')) {
      throw new Error('Project and Unit are required');
    }
    
    const marlas = parseFloat(formData.get('marlas')) || 0;
    const rate = parseFloat(formData.get('rate')) || 0;
    const saleValue = marlas * rate;
    
    // Check if unit already exists
    const existingUnit = db.inventory.find(item => 
      item.projectName === projectName && 
      item.unit === formData.get('unit')
    );
    
    if (existingUnit) {
      throw new Error(`Unit ${formData.get('unit')} already exists in ${projectName}`);
    }
    
    const inventoryItem = {
      id: generateId('inv'),
      projectName: projectName,
      unit: formData.get('unit'),
      unitType: formData.get('unitType'),
      marlas: marlas,
      rate: rate,
      saleValue: saleValue,
      status: formData.get('status'),
      customerId: null, // No customer initially
      projectId: null, // No sale project initially
      notes: formData.get('notes') || '',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    
    db.inventory.push(inventoryItem);
    
    // Update master project stats
    updateMasterProjectStats(projectName);
    
    saveToStorage();
    
    closeAddInventoryModal();
    refreshSection('inventory');
    
    showNotification('success', 'Inventory Added', 
      `${inventoryItem.unit} has been added to ${inventoryItem.projectName} inventory.`);
    
    return true;
  } catch (error) {
    showNotification('error', 'Error', error.message);
    return false;
  }
}

function renderInventoryTable() {
  const tbody = document.querySelector('#inventoryTable tbody');
  const pagination = document.getElementById('inventoryPagination');
  
  if (!tbody) return;
  
  // Get filters
  const searchTerm = document.getElementById('inventorySearch')?.value.toLowerCase() || '';
  const projectFilter = document.getElementById('inventoryProjectFilter')?.value || 'all';
  const statusFilter = document.getElementById('inventoryStatusFilter')?.value || 'all';
  
  // Filter inventory
  let filtered = db.inventory.filter(item => {
    // Search filter
    if (searchTerm) {
      const searchFields = [
        item.projectName,
        item.unit,
        item.unitType,
        item.notes
      ].join(' ').toLowerCase();
      
      if (!searchFields.includes(searchTerm)) return false;
    }
    
    // Project filter
    if (projectFilter !== 'all' && item.projectName !== projectFilter) return false;
    
    // Status filter
    if (statusFilter !== 'all' && item.status !== statusFilter) return false;
    
    return true;
  }).sort((a, b) => {
    // Sort by project, then unit
    if (a.projectName !== b.projectName) {
      return a.projectName.localeCompare(b.projectName);
    }
    return a.unit.localeCompare(b.unit);
  });
  
  // Calculate pagination
  const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
  const current = currentPage.inventory || 1;
  const startIdx = (current - 1) * ITEMS_PER_PAGE;
  const endIdx = startIdx + ITEMS_PER_PAGE;
  const pageItems = filtered.slice(startIdx, endIdx);
  
  // Render table
  const html = pageItems.map(item => {
    const customer = item.customerId ? db.customers.find(c => c.id === item.customerId) : null;
    
    const statusBadge = item.status === 'available' ? 'badge-success' :
                       item.status === 'sold' ? 'badge-primary' :
                       item.status === 'reserved' ? 'badge-warning' :
                       'badge-danger';
    
    // Check if unit is sold (has a project)
    const isSold = db.projects.some(p => 
      p.name === item.projectName && p.unit === item.unit
    );
    
    // Get project details if sold
    const project = db.projects.find(p => 
      p.name === item.projectName && p.unit === item.unit
    );
    
    return `
      <tr>
        <td><span class="text-muted">${item.id.substring(0, 8)}</span></td>
        <td><strong>${escapeHtml(item.projectName)}</strong></td>
        <td>${escapeHtml(item.unit)}</td>
        <td>${escapeHtml(item.unitType.replace('_', ' ').toUpperCase())}</td>
        <td>${item.marlas}</td>
        <td>${formatCurrency(item.rate)}</td>
        <td class="font-semibold">${formatCurrency(item.saleValue)}</td>
        <td>
          <span class="badge ${statusBadge}">
            ${item.status.toUpperCase()}
          </span>
          ${isSold ? '<span class="badge badge-success ml-1">SOLD</span>' : ''}
        </td>
        <td>
          ${customer ? 
            `<span class="cursor-pointer text-primary" 
                  onclick="openCustomerModal('${customer.id}')">
              ${escapeHtml(customer.name)}
            </span>` : 
            '<span class="text-muted">-</span>'
          }
        </td>
        <td>
          <div class="btn-group">
            ${item.status === 'available' ? `
              <button class="action-btn btn-primary" 
                      onclick="sellInventoryUnit('${item.id}')">
                Sell
              </button>
            ` : ''}
            <button class="action-btn btn-edit" 
                    onclick="editInventoryItem('${item.id}')">
              Edit
            </button>
            <button class="action-btn btn-danger" 
                    onclick="deleteInventoryItem('${item.id}')">
              Delete
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
  
  tbody.innerHTML = html || `
    <tr>
      <td colspan="10" style="text-align: center; color: var(--gray-400); padding: 40px;">
        No inventory items found
      </td>
    </tr>
  `;
  
  // Render pagination
  renderPagination(pagination, current, totalPages, 'inventory');
}

function filterInventoryTable() {
  currentPage.inventory = 1;
  renderInventoryTable();
}








function populateProjectSelects() {
  // Get master projects (projects without customers)
  const masterProjects = db.masterProjects || [];
  
  // Inventory project select
  const inventoryProjectSelect = document.getElementById('inventoryProjectFilter');
  if (inventoryProjectSelect) {
    inventoryProjectSelect.innerHTML = 
      '<option value="all">All Projects</option>' +
      masterProjects.map(mp => 
        `<option value="${escapeHtml(mp.name)}">
          ${escapeHtml(mp.name)} (${mp.availableUnits || 0} available)
        </option>`
      ).join('');
  }
  
  // Add inventory modal project select
  const invProjectSelect = document.getElementById('invProjectName');
  if (invProjectSelect) {
    invProjectSelect.innerHTML = 
      '<option value="">Select Project</option>' +
      masterProjects.map(mp => 
        `<option value="${escapeHtml(mp.name)}">${escapeHtml(mp.name)}</option>`
      ).join('');
  }
  
  // Also update the project select in Add Project modal
  const addProjectSelect = document.getElementById('projCust');
  if (addProjectSelect) {
    // This should only show customers, not projects
    const customers = db.customers.filter(c => c.type === 'customer' || c.type === 'both');
    addProjectSelect.innerHTML = customers.map(c => 
      `<option value="${c.id}">${escapeHtml(c.name)} - ${escapeHtml(c.phone)}</option>`
    ).join('');
  }
}





function sellInventoryUnit(inventoryId) {
  const inventoryItem = db.inventory.find(item => item.id === inventoryId);
  if (!inventoryItem) return;
  
  // Open customer selection modal first
  const customerSelect = document.createElement('select');
  customerSelect.className = 'form-control mb-3';
  customerSelect.innerHTML = `
    <option value="">Select Customer</option>
    ${db.customers.filter(c => c.type === 'customer' || c.type === 'both').map(c => 
      `<option value="${c.id}">${escapeHtml(c.name)} - ${escapeHtml(c.phone)}</option>`
    ).join('')}
  `;
  
  const modalContent = `
    <div class="mb-3">
      <label class="form-label">Select Customer *</label>
      ${customerSelect.outerHTML}
    </div>
    <div class="mb-3">
      <label class="form-label">Installments</label>
      <input type="number" id="installmentCount" class="form-control" value="2" min="1" max="36">
    </div>
    <div class="mb-3">
      <label class="form-label">First Due Date</label>
      <input type="date" id="firstDueDate" class="form-control" value="${getDateString()}">
    </div>
    <div class="mb-3">
      <label class="form-label">Payment Cycle</label>
      <select id="paymentCycle" class="form-control">
        <option value="monthly">Monthly</option>
        <option value="quarterly">Quarterly (3 months)</option>
        <option value="bi_annual" selected>Bi-Annual (6 months)</option>
        <option value="annual">Annual (12 months)</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Broker (Optional)</label>
      <select id="brokerSelect" class="form-control">
        <option value="">Select Broker</option>
        ${db.customers.filter(c => c.type === 'broker' || c.type === 'both').map(b => 
          `<option value="${b.id}">${escapeHtml(b.name)}</option>`
        ).join('')}
      </select>
    </div>
  `;
  
  if (confirm(`Sell ${inventoryItem.unit} from ${inventoryItem.projectName}?\n\nSale Value: ${formatCurrency(inventoryItem.saleValue)}\n\nClick OK to select customer and terms.`)) {
    // Create modal for customer selection and terms
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h3 class="modal-title">Sell Inventory Unit</h3>
          <button class="btn btn-sm btn-secondary" onclick="this.closest('.modal').remove()">‚úï</button>
        </div>
        <div class="modal-body">
          ${modalContent}
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
          <button class="btn btn-primary" onclick="completeSale('${inventoryId}')">Complete Sale</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
  }
}

function completeSale(inventoryId) {
  const inventoryItem = db.inventory.find(item => item.id === inventoryId);
  if (!inventoryItem) return;
  
  const customerSelect = document.querySelector('.modal.show select');
  const installmentCount = document.getElementById('installmentCount');
  const firstDueDate = document.getElementById('firstDueDate');
  const paymentCycle = document.getElementById('paymentCycle');
  const brokerSelect = document.getElementById('brokerSelect');
  
  if (!customerSelect || !customerSelect.value) {
    showNotification('error', 'Error', 'Please select a customer');
    return;
  }
  
  const customerId = customerSelect.value;
  const installments = parseInt(installmentCount?.value) || 2;
  const firstDue = firstDueDate?.value || getDateString();
  const cycle = paymentCycle?.value || 'bi_annual';
  const brokerId = brokerSelect?.value || null;
  
  // Create project
  const project = {
    id: generateId('proj'),
    customerId: customerId,
    brokerId: brokerId,
    name: inventoryItem.projectName,
    unit: inventoryItem.unit,
    marlas: inventoryItem.marlas,
    rate: inventoryItem.rate,
    sale: inventoryItem.saleValue,
    received: 0,
    status: 'active',
    cycle: cycle,
    notes: `Sold from inventory on ${new Date().toLocaleDateString()}`,
    installments: [],
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };
  
  // Create installments
  const baseAmount = Math.floor(project.sale / installments);
  let remainder = project.sale - (baseAmount * installments);
  
  for (let i = 0; i < installments; i++) {
    let amount = baseAmount + (remainder > 0 ? 1 : 0);
    if (remainder > 0) remainder--;
    
    const dueDate = new Date(firstDue);
    
    switch(cycle) {
      case 'monthly':
        dueDate.setMonth(dueDate.getMonth() + i);
        break;
      case 'quarterly':
        dueDate.setMonth(dueDate.getMonth() + (i * 3));
        break;
      case 'bi_annual':
        dueDate.setMonth(dueDate.getMonth() + (i * 6));
        break;
      case 'annual':
        dueDate.setFullYear(dueDate.getFullYear() + i);
        break;
      default:
        dueDate.setMonth(dueDate.getMonth() + (i * 6));
    }
    
    project.installments.push({
      id: generateId('inst'),
      number: i + 1,
      amount: amount,
      dueDate: dueDate.toISOString().split('T')[0],
      paid: false,
      partialPaid: 0,
      paidOn: null,
      receiptId: null
    });
  }
  
  db.projects.push(project);
  
  // Update inventory
  inventoryItem.status = 'sold';
  inventoryItem.customerId = customerId;
  inventoryItem.projectId = project.id;
  inventoryItem.updatedAt = new Date().toISOString();
  
  // Update master project stats
  updateMasterProjectStats(inventoryItem.projectName);
  
  saveToStorage();
  
  // Close modal
  document.querySelector('.modal.show').remove();
  
  // Refresh sections
  refreshSection('projects');
  refreshSection('inventory');
  
  const customer = db.customers.find(c => c.id === customerId);
  showNotification('success', 'Sale Completed', 
    `${inventoryItem.unit} sold to ${customer?.name || 'customer'}.`);
}

function editInventoryItem(inventoryId) {
  const item = db.inventory.find(i => i.id === inventoryId);
  if (!item) return;
  
  const newStatus = prompt('Enter new status (available/sold/reserved/blocked):', item.status);
  if (newStatus && ['available', 'sold', 'reserved', 'blocked'].includes(newStatus)) {
    item.status = newStatus;
    item.updatedAt = new Date().toISOString();
    
    // If status changed to sold, ensure there's a project
    if (newStatus === 'sold' && !db.projects.some(p => 
      p.name === item.projectName && p.unit === item.unit
    )) {
      showNotification('warning', 'Unit Not Sold', 
        'Unit marked as sold but no sale transaction exists. Please create a project.');
    }
    
    saveToStorage();
    refreshSection('inventory');
    
    showNotification('success', 'Inventory Updated', 
      `Status updated to ${newStatus}.`);
  }
}

function deleteInventoryItem(inventoryId) {
  if (!confirm('Are you sure you want to delete this inventory item?')) {
    return;
  }
  
  const item = db.inventory.find(i => i.id === inventoryId);
  if (!item) return;
  
  // Check if unit is sold
  const isSold = db.projects.some(p => 
    p.name === item.projectName && p.unit === item.unit
  );
  
  if (isSold) {
    showNotification('error', 'Cannot Delete', 
      'This unit has been sold and cannot be deleted. Mark as available instead.');
    return;
  }
  
  db.inventory = db.inventory.filter(i => i.id !== inventoryId);
  saveToStorage();
  refreshSection('inventory');
  
  showNotification('success', 'Inventory Deleted', 
    `${item.unit} has been removed from inventory.`);
}













// Navigation - FIXED VERSION
function showSection(sectionId) {
  console.log('Showing section:', sectionId);
  
  // Hide all sections
  document.querySelectorAll('.section').forEach(section => {
    section.classList.remove('active');
  });
  
  // Remove active class from all nav buttons
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Show selected section
  const sectionElement = document.getElementById(sectionId);
  if (sectionElement) {
    sectionElement.classList.add('active');
    
    // Find and activate the corresponding nav button
    const navButtons = document.querySelectorAll('.nav-btn');
    navButtons.forEach(btn => {
      if (btn.getAttribute('data-section') === sectionId) {
        btn.classList.add('active');
      }
    });
  } else {
    console.error('Section not found:', sectionId);
  }
  
  // Refresh section data
  refreshSection(sectionId);
}

function refreshSection(sectionId) {
  console.log('Refreshing section:', sectionId);
  
  switch(sectionId) {
    case 'dashboard':
      updateDashboard();
      break;
    case 'customers':
      renderCustomersTable();
      break;
    case 'projects':
      renderProjectsTable();
      break;
    case 'inventory': // Add this case
      renderInventoryTable();
      break;
    case 'interactions':
      renderInteractionsTable();
      renderLeadsDashboard();
      break;
    case 'receipts':
      renderReceiptsTable();
      break;
    case 'reports':
      updateReports();
      break;
  }
}

// Dashboard Functions
function updateDashboard() {
  const financials = calculateOverallFinancials();


  const totalInventory = db.inventory.length;
  const availableInventory = db.inventory.filter(item => item.status === 'available').length;
  const soldInventory = db.inventory.filter(item => item.status === 'sold').length;
  
  // Update stats
  document.getElementById('totalCustomers').textContent = db.customers.length;
  document.getElementById('totalProjects').textContent = db.projects.length;
  document.getElementById('totalSaleValue').textContent = formatCurrency(financials.totalSale);
  document.getElementById('totalReceived').textContent = formatCurrency(financials.totalReceived);
  document.getElementById('totalReceivable').textContent = formatCurrency(financials.totalReceivable);
  document.getElementById('totalOverdue').textContent = formatCurrency(financials.totalOverdue);
  document.getElementById('totalFuture').textContent = formatCurrency(financials.totalFuture);
  document.getElementById('totalBrokers').textContent = db.customers.filter(c => 
    c.type === 'broker' || c.type === 'both').length;
  
  // Render follow-up leads
  renderFollowUpLeads();
  
  // Render recent activities
  renderRecentActivities();
}

function renderFollowUpLeads() {
  const container = document.getElementById('followupLeads');
  if (!container) return;
  
  const today = new Date();
  const followUpInteractions = db.interactions.filter(i => 
    i.status === 'follow_up' && i.nextFollowUp
  ).sort((a, b) => new Date(a.nextFollowUp) - new Date(b.nextFollowUp));
  
  // Categorize by priority/urgency
  const categories = {
    urgent: [], // 1-2 days
    high: [],   // 3-7 days
    medium: [], // 8-14 days
    low: []     // 15+ days
  };
  
  followUpInteractions.forEach(interaction => {
    const followUpDate = new Date(interaction.nextFollowUp);
    const daysDiff = calculateDaysBetween(today, followUpDate);
    
    if (daysDiff <= 2) categories.urgent.push(interaction);
    else if (daysDiff <= 7) categories.high.push(interaction);
    else if (daysDiff <= 14) categories.medium.push(interaction);
    else categories.low.push(interaction);
  });
  
  // Update stats
  const total = followUpInteractions.length;
  const urgentCount = categories.urgent.length;
  const highCount = categories.high.length;
  
  const statsElement = document.getElementById('followupStats');
  if (statsElement) {
    statsElement.textContent = 
      `${total} follow-ups (${urgentCount} urgent, ${highCount} high)`;
  }
  
  // Render cards
  let html = '';
  
  // Show urgent and high priority first
  ['urgent', 'high', 'medium', 'low'].forEach(category => {
    const interactions = categories[category];
    
    if (interactions.length === 0) return;
    
    // Limit to 2 cards per category for better UI
    interactions.slice(0, 2).forEach(interaction => {
      const contact = db.customers.find(c => 
        c.id === (interaction.customerId || interaction.brokerId)
      );
      
      if (!contact) return;
      
      const followUpDate = new Date(interaction.nextFollowUp);
      const daysDiff = calculateDaysBetween(today, followUpDate);
      
      html += `
        <div class="followup-card ${category}" onclick="openCustomerModal('${contact.id}')">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <div>
              <div style="font-weight: 700; color: var(--gray-900); margin-bottom: 4px;">
                ${escapeHtml(contact.name)}
              </div>
              <div style="font-size: 0.85rem; color: var(--gray-600);">
                ${contact.type === 'broker' ? 'ü§ù Broker' : 'üë§ Customer'}
              </div>
            </div>
            <div style="font-size: 0.75rem; font-weight: 700; padding: 4px 12px; border-radius: 12px; 
                  background: ${category === 'urgent' ? '#fee2e2' : 
                             category === 'high' ? '#fef3c7' : 
                             category === 'medium' ? '#e0f2fe' : '#d1fae5'}; 
                  color: ${category === 'urgent' ? '#991b1b' : 
                          category === 'high' ? '#92400e' : 
                          category === 'medium' ? '#1e40af' : '#065f46'};">
              ${daysDiff === 0 ? 'Today' : daysDiff === 1 ? 'Tomorrow' : `${daysDiff} days`}
            </div>
          </div>
          <div style="font-size: 0.9rem; color: var(--gray-700); margin-bottom: 8px;">
            ${escapeHtml(interaction.type.replace('_', ' ').toUpperCase())}
          </div>
          <div style="font-size: 0.85rem; color: var(--gray-600); margin-bottom: 12px; 
                max-height: 40px; overflow: hidden; text-overflow: ellipsis;">
            ${escapeHtml(interaction.notes || 'No notes')}
          </div>
          <button class="btn btn-sm btn-primary" 
                  onclick="event.stopPropagation(); logFollowUp('${contact.id}', '${interaction.contactType || 'customer'}')" 
                  style="width: 100%;">
            Log Follow-up
          </button>
        </div>
      `;
    });
  });
  
  container.innerHTML = html || `
    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--gray-400);">
      <div style="font-size: 3rem; margin-bottom: 16px;">üéâ</div>
      <div style="font-size: 1.1rem; font-weight: 600; color: var(--gray-600);">
        No pending follow-ups
      </div>
      <div style="margin-top: 8px;">All interactions are up to date</div>
    </div>
  `;
}














function renderRecentActivities() {
  const container = document.getElementById('recentActivities');
  if (!container) return;
  
  // Combine recent activities from different sources
  const activities = [];
  
  // Recent interactions
  db.interactions
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .slice(0, 5)
    .forEach(interaction => {
      const contact = db.customers.find(c => 
        c.id === (interaction.customerId || interaction.brokerId)
      );
      
      if (contact) {
        activities.push({
          date: interaction.date,
          type: 'interaction',
          description: `${interaction.type.replace('_', ' ')} with ${contact.name}`,
          contact: contact.name,
          status: interaction.status
        });
      }
    });
  
  // Recent receipts
  db.receipts
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .slice(0, 3)
    .forEach(receipt => {
      const customer = db.customers.find(c => c.id === receipt.customerId);
      const project = db.projects.find(p => p.id === receipt.projectId);
      
      if (customer && project) {
        activities.push({
          date: receipt.date,
          type: 'receipt',
          description: `Payment received for ${project.name}`,
          contact: customer.name,
          status: 'completed'
        });
      }
    });
  
  // Sort by date and take top 10
  activities.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  const html = activities.slice(0, 10).map(activity => {
    const statusBadge = activity.status === 'follow_up' ? 'badge-warning' :
                       activity.status === 'completed' ? 'badge-success' :
                       'badge-primary';
    
    return `
      <tr>
        <td>${formatDateTime(activity.date)}</td>
        <td>
          <span class="badge ${activity.type === 'interaction' ? 'badge-primary' : 'badge-success'}">
            ${activity.type === 'interaction' ? 'üí¨' : 'üí∞'} 
            ${activity.type.toUpperCase()}
          </span>
        </td>
        <td>${escapeHtml(activity.description)}</td>
        <td>${escapeHtml(activity.contact)}</td>
        <td>
          <span class="badge ${statusBadge}">
            ${activity.status.replace('_', ' ').toUpperCase()}
          </span>
        </td>
      </tr>
    `;
  }).join('');
  
  container.innerHTML = html || `
    <tr>
      <td colspan="5" style="text-align: center; color: var(--gray-400); padding: 40px;">
        No recent activities
      </td>
    </tr>
  `;
}









// Table Rendering Functions
function renderCustomersTable() {
  const tbody = document.querySelector('#customersTable tbody');
  const pagination = document.getElementById('customerPagination');
  
  if (!tbody) return;
  
  // Get filters
  const searchTerm = document.getElementById('customerSearch')?.value.toLowerCase() || '';
  const typeFilter = document.getElementById('customerTypeFilter')?.value || 'all';
  const statusFilter = document.getElementById('customerStatusFilter')?.value || 'all';
  
  // Filter customers
  let filtered = db.customers.filter(customer => {
    // Search filter
    if (searchTerm) {
      const searchFields = [
        customer.name,
        customer.phone,
        customer.cnic,
        customer.email,
        customer.company,
        customer.address
      ].join(' ').toLowerCase();
      
      if (!searchFields.includes(searchTerm)) return false;
    }
    
    // Type filter
    if (typeFilter !== 'all' && customer.type !== typeFilter) return false;
    
    // Status filter
    if (statusFilter !== 'all' && customer.status !== statusFilter) return false;
    
    return true;
  });
  
  // Calculate pagination
  const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
  const current = currentPage.customers;
  const startIdx = (current - 1) * ITEMS_PER_PAGE;
  const endIdx = startIdx + ITEMS_PER_PAGE;
  const pageCustomers = filtered.slice(startIdx, endIdx);
  
  // Render table
  const html = pageCustomers.map(customer => {
    const customerProjects = db.projects.filter(p => p.customerId === customer.id);
    const financials = calculateCustomerFinancials(customer.id);
    
    const typeBadge = customer.type === 'customer' ? 'badge-primary' :
                     customer.type === 'broker' ? 'badge-success' :
                     'badge-warning';
    
    const statusBadge = customer.status === 'active' ? 'badge-success' : 'badge-danger';
    
    return `
      <tr>
        <td><span class="text-muted">${customer.id.substring(0, 8)}</span></td>
        <td>
  <span class="cursor-pointer text-primary font-semibold" 
        onclick="event.stopPropagation(); openCustomerModal('${customer.id}')">
    ${escapeHtml(customer.name)}
  </span>
</td>
        <td>${escapeHtml(customer.phone)}</td>
        <td>${escapeHtml(customer.cnic)}</td>
        <td><span class="badge ${typeBadge}">${customer.type.toUpperCase()}</span></td>
        <td><span class="font-semibold">${customerProjects.length}</span></td>
        <td><span class="badge ${statusBadge}">${customer.status.toUpperCase()}</span></td>
        <td>
          <div class="btn-group">
            <button class="action-btn btn-view" 
                    onclick="openCustomerModal('${customer.id}')">
              View
            </button>
            <button class="action-btn btn-edit" 
                    onclick="${customer.type === 'broker' || customer.type === 'both' ? 'editBroker' : 'editCustomer'}('${customer.id}')">
              Edit
            </button>
            <button class="action-btn btn-danger" 
                    onclick="deleteCustomer('${customer.id}')">
              Delete
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
  
  tbody.innerHTML = html || `
    <tr>
      <td colspan="8" style="text-align: center; color: var(--gray-400); padding: 40px;">
        No customers found
      </td>
    </tr>
  `;
  
  // Render pagination
  renderPagination(pagination, current, totalPages, 'customers');
}





function updateProjectBroker(projectId, newBrokerId) {
  const project = db.projects.find(p => p.id === projectId);
  if (!project) return;
  
  const oldBroker = project.brokerId ? db.customers.find(c => c.id === project.brokerId) : null;
  const newBroker = newBrokerId ? db.customers.find(c => c.id === newBrokerId) : null;
  
  project.brokerId = newBrokerId || null;
  project.updatedAt = new Date().toISOString();
  
  // Log the change as an interaction
  const interaction = {
    id: generateId('int'),
    contactType: 'customer',
    customerId: project.customerId,
    type: 'update',
    status: 'resolved',
    priority: 'medium',
    date: new Date().toISOString(),
    notes: `Broker updated: ${oldBroker ? oldBroker.name : 'None'} ‚Üí ${newBroker ? newBroker.name : 'None'}`,
    createdAt: new Date().toISOString()
  };
  
  db.interactions.push(interaction);
  saveToStorage();
  
  showNotification('success', 'Broker Updated', 
    `Project broker has been updated.`);
  
  refreshSection('projects');
}




function editProjectModal(projectId) {
  const project = db.projects.find(p => p.id === projectId);
  if (!project) return;
  
  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h3 class="modal-title">‚úèÔ∏è Edit Project Details</h3>
        <button class="btn btn-sm btn-secondary" onclick="this.closest('.modal').remove()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Project Name</label>
            <input type="text" id="editProjName" class="form-control" value="${escapeHtml(project.name)}">
          </div>
          <div class="form-group">
            <label class="form-label">Unit/Shop #</label>
            <input type="text" id="editProjUnit" class="form-control" value="${escapeHtml(project.unit)}">
          </div>
          <div class="form-group">
            <label class="form-label">Broker</label>
            <select id="editProjBroker" class="form-control">
              <option value="">Select Broker</option>
              ${db.customers.filter(c => c.type === 'broker' || c.type === 'both').map(b => 
                `<option value="${b.id}" ${b.id === project.brokerId ? 'selected' : ''}>
                  ${escapeHtml(b.name)} - ${escapeHtml(b.phone)}
                </option>`
              ).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Rate per Marla</label>
            <input type="number" step="0.01" id="editProjRate" class="form-control" 
                   value="${project.rate}" oninput="updateEditProjectValue()">
          </div>
          <div class="form-group">
            <label class="form-label">Marlas</label>
            <input type="number" step="0.01" id="editProjMarlas" class="form-control" 
                   value="${project.marlas}" oninput="updateEditProjectValue()">
          </div>
          <div class="form-group">
            <label class="form-label">Sale Value</label>
            <input type="number" step="0.01" id="editProjSale" class="form-control" 
                   value="${project.sale}" readonly style="background: var(--gray-100);">
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select id="editProjStatus" class="form-control">
              <option value="active" ${project.status === 'active' ? 'selected' : ''}>Active</option>
              <option value="completed" ${project.status === 'completed' ? 'selected' : ''}>Completed</option>
              <option value="cancelled" ${project.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
            </select>
          </div>
        </div>
        
        <h4 class="mt-4 mb-3">üìÖ Edit Installment Dates</h4>
        <div id="installmentEditContainer" style="max-height: 300px; overflow-y: auto;">
          <!-- Installments will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
        <button class="btn btn-primary" onclick="saveProjectEdit('${project.id}')">Save Changes</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Load installments
  const container = modal.querySelector('#installmentEditContainer');
  if (project.installments && project.installments.length > 0) {
    container.innerHTML = project.installments.map(inst => `
      <div class="form-grid mb-3" style="background: var(--gray-50); padding: 15px; border-radius: var(--radius);">
        <div class="form-group">
          <label class="form-label">Installment #${inst.number}</label>
          <div style="font-weight: bold;">${formatCurrency(inst.amount)}</div>
        </div>
        <div class="form-group">
          <label class="form-label">Due Date</label>
          <input type="date" class="form-control inst-due-date" 
                 data-inst-id="${inst.id}" value="${inst.dueDate}">
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <div>
            <span class="badge ${inst.paid ? 'badge-success' : 'badge-warning'}">
              ${inst.paid ? 'PAID' : 'PENDING'}
            </span>
          </div>
        </div>
      </div>
    `).join('');
  } else {
    container.innerHTML = '<p class="text-muted">No installments found</p>';
  }
}

function updateEditProjectValue() {
  const marlas = parseFloat(document.getElementById('editProjMarlas').value) || 0;
  const rate = parseFloat(document.getElementById('editProjRate').value) || 0;
  document.getElementById('editProjSale').value = (marlas * rate).toFixed(2);
}

function saveProjectEdit(projectId) {
  const project = db.projects.find(p => p.id === projectId);
  if (!project) return;
  
  // Update basic info
  project.name = document.getElementById('editProjName').value;
  project.unit = document.getElementById('editProjUnit').value;
  project.brokerId = document.getElementById('editProjBroker').value || null;
  project.rate = parseFloat(document.getElementById('editProjRate').value) || 0;
  project.marlas = parseFloat(document.getElementById('editProjMarlas').value) || 0;
  project.sale = parseFloat(document.getElementById('editProjSale').value) || 0;
  project.status = document.getElementById('editProjStatus').value;
  project.updatedAt = new Date().toISOString();
  
  // Update installment dates
  const dateInputs = document.querySelectorAll('.inst-due-date');
  dateInputs.forEach(input => {
    const instId = input.getAttribute('data-inst-id');
    const installment = project.installments.find(i => i.id === instId);
    if (installment) {
      installment.dueDate = input.value;
    }
  });
  
  // Update inventory if needed
  const inventoryItem = db.inventory.find(item => 
    item.projectName === project.name && item.unit === project.unit
  );
  
  if (inventoryItem) {
    inventoryItem.rate = project.rate;
    inventoryItem.marlas = project.marlas;
    inventoryItem.saleValue = project.sale;
    inventoryItem.updatedAt = new Date().toISOString();
  }
  
  saveToStorage();
  
  // Close modal
  document.querySelector('.modal.show').remove();
  
  refreshSection('projects');
  refreshSection('inventory');
  
  showNotification('success', 'Project Updated', 'Project details have been updated.');
}





function renderProjectsTable() {
  const tbody = document.querySelector('#projectsTable tbody');
  const pagination = document.getElementById('projectPagination');
  
  if (!tbody) return;
  
  // Get filters
  const searchTerm = document.getElementById('projectSearch')?.value.toLowerCase() || '';
  const statusFilter = document.getElementById('projectStatusFilter')?.value || 'all';
  
  // Filter projects
  let filtered = db.projects.filter(project => {
    // Search filter
    if (searchTerm) {
      const customer = db.customers.find(c => c.id === project.customerId);
      const searchFields = [
        project.name,
        project.unit,
        project.notes,
        customer?.name || ''
      ].join(' ').toLowerCase();
      
      if (!searchFields.includes(searchTerm)) return false;
    }
    
    // Status filter
    if (statusFilter !== 'all' && project.status !== statusFilter) return false;
    
    return true;
  });
  
  // Calculate pagination
  const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
  const current = currentPage.projects;
  const startIdx = (current - 1) * ITEMS_PER_PAGE;
  const endIdx = startIdx + ITEMS_PER_PAGE;
  const pageProjects = filtered.slice(startIdx, endIdx);
  
  // Render table
  const html = pageProjects.map(project => {
    const customer = db.customers.find(c => c.id === project.customerId);
    const broker = project.brokerId ? db.customers.find(c => c.id === project.brokerId) : null;
    const financials = calculateProjectFinancials(project);
    
    const statusBadge = project.status === 'active' ? 'badge-success' :
                       project.status === 'completed' ? 'badge-primary' :
                       'badge-danger';
    
    // In renderProjectsTable function, in the table row:
return `
  <tr>
    <td><span class="text-muted">${project.id.substring(0, 8)}</span></td>
    <td>
      <span class="cursor-pointer text-primary" 
            onclick="openCustomerModal('${project.customerId}')">
        ${escapeHtml(customer?.name || 'Unknown')}
      </span>
    </td>
    <td>
      ${broker ? `
        <span class="cursor-pointer text-success" 
              onclick="openCustomerModal('${project.brokerId}')">
          ${escapeHtml(broker.name)}
        </span>
      ` : '<span class="text-muted">-</span>'}
    </td>
    <td>
      <strong>${escapeHtml(project.name)}</strong>
      <div class="text-xs text-muted">Master Project</div>
    </td>
    <td>
      ${escapeHtml(project.unit)}
      ${inventoryItem ? '<div class="text-xs text-success">‚úì From Inventory</div>' : ''}
    </td>
    <td class="font-semibold">${formatCurrency(project.sale)}</td>
    <td class="text-success font-semibold">${formatCurrency(financials.totalReceived)}</td>
    <td class="font-semibold">${formatCurrency(financials.totalReceivable)}</td>
    <td class="text-danger font-semibold">${formatCurrency(financials.totalOverdue)}</td>
    <td>
      <div class="btn-group">
        <button class="action-btn btn-view" 
                onclick="viewProject('${project.id}')">
          View
        </button>
        <button class="action-btn btn-edit" 
                onclick="editProjectModal('${project.id}')">
          Edit
        </button>
        <button class="action-btn btn-danger" 
                onclick="deleteProject('${project.id}')">
          Delete
        </button>
      </div>
    </td>
  </tr>
`;
  }).join('');
  
  tbody.innerHTML = html || `
    <tr>
      <td colspan="10" style="text-align: center; color: var(--gray-400); padding: 40px;">
        No projects found
      </td>
    </tr>
  `;
  
  // Render pagination
  renderPagination(pagination, current, totalPages, 'projects');
}

function renderInteractionsTable() {
  const tbody = document.querySelector('#interactionsTable tbody');
  const pagination = document.getElementById('interactionPagination');
  
  if (!tbody) return;
  
  // Get filters
  const searchTerm = document.getElementById('interactionSearch')?.value.toLowerCase() || '';
  const typeFilter = document.getElementById('interactionTypeFilter')?.value || 'all';
  const statusFilter = document.getElementById('interactionStatusFilter')?.value || 'all';
  
  // Filter interactions
  let filtered = db.interactions.filter(interaction => {
    // Search filter
    if (searchTerm) {
      const contact = db.customers.find(c => 
        c.id === (interaction.customerId || interaction.brokerId)
      );
      const searchFields = [
        interaction.notes || '',
        interaction.type,
        contact?.name || ''
      ].join(' ').toLowerCase();
      
      if (!searchFields.includes(searchTerm)) return false;
    }
    
    // Type filter
    if (typeFilter !== 'all' && interaction.type !== typeFilter) return false;
    
    // Status filter
    if (statusFilter !== 'all' && interaction.status !== statusFilter) return false;
    
    return true;
  }).sort((a, b) => new Date(b.date) - new Date(a.date));
  
  // Calculate pagination
  const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
  const current = currentPage.interactions;
  const startIdx = (current - 1) * ITEMS_PER_PAGE;
  const endIdx = startIdx + ITEMS_PER_PAGE;
  const pageInteractions = filtered.slice(startIdx, endIdx);
  
  // Render table
  const html = pageInteractions.map(interaction => {
    const contact = db.customers.find(c => 
      c.id === (interaction.customerId || interaction.brokerId)
    );
    
    const priorityBadge = interaction.priority === 'urgent' ? 'badge-danger' :
                         interaction.priority === 'high' ? 'badge-warning' :
                         interaction.priority === 'medium' ? 'badge-primary' :
                         'badge-success';
    
    const statusBadge = interaction.status === 'follow_up' ? 'badge-warning' :
                       interaction.status === 'resolved' ? 'badge-success' :
                       'badge-primary';
    
    return `
      <tr>
        <td>${formatDateTime(interaction.date)}</td>
        <td>
          <span class="cursor-pointer text-primary" 
                onclick="openCustomerModal('${contact?.id || ''}')">
            ${escapeHtml(contact?.name || 'Unknown')}
          </span>
        </td>
        <td>
          <span class="badge badge-primary">
            ${interaction.type.replace('_', ' ').toUpperCase()}
          </span>
        </td>
        <td>
          <span class="badge ${statusBadge}">
            ${interaction.status.replace('_', ' ').toUpperCase()}
          </span>
        </td>
        <td>
          <span class="badge ${priorityBadge}">
            ${interaction.priority.toUpperCase()}
          </span>
        </td>
        <td style="max-width: 300px;">
          <div style="max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
            ${escapeHtml(interaction.notes || 'No notes')}
          </div>
        </td>
        <td>
          <div class="btn-group">
            <button class="action-btn btn-danger" 
                    onclick="deleteInteraction('${interaction.id}')">
              Delete
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
  
  tbody.innerHTML = html || `
    <tr>
      <td colspan="7" style="text-align: center; color: var(--gray-400); padding: 40px;">
        No interactions found
      </td>
    </tr>
  `;
  
  // Render pagination
  renderPagination(pagination, current, totalPages, 'interactions');
}

function renderReceiptsTable() {
  const tbody = document.querySelector('#receiptsTable tbody');
  const pagination = document.getElementById('receiptPagination');
  
  if (!tbody) return;
  
  // Get filters
  const searchTerm = document.getElementById('receiptSearch')?.value.toLowerCase() || '';
  const methodFilter = document.getElementById('receiptMethodFilter')?.value || 'all';
  const dateFilter = document.getElementById('receiptDateFilter')?.value || '';
  
  // Filter receipts
  let filtered = db.receipts.filter(receipt => {
    // Search filter
    if (searchTerm) {
      const customer = db.customers.find(c => c.id === receipt.customerId);
      const project = db.projects.find(p => p.id === receipt.projectId);
      const searchFields = [
        receipt.reference || '',
        receipt.notes || '',
        customer?.name || '',
        project?.name || ''
      ].join(' ').toLowerCase();
      
      if (!searchFields.includes(searchTerm)) return false;
    }
    
    // Method filter
    if (methodFilter !== 'all' && receipt.method !== methodFilter) return false;
    
    // Date filter
    if (dateFilter && receipt.date !== dateFilter) return false;
    
    return true;
  }).sort((a, b) => new Date(b.date) - new Date(a.date));
  
  // Calculate pagination
  const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
  const current = currentPage.receipts;
  const startIdx = (current - 1) * ITEMS_PER_PAGE;
  const endIdx = startIdx + ITEMS_PER_PAGE;
  const pageReceipts = filtered.slice(startIdx, endIdx);
  
  // Render table
  const html = pageReceipts.map(receipt => {
    const customer = db.customers.find(c => c.id === receipt.customerId);
    const project = db.projects.find(p => p.id === receipt.projectId);
    
    const methodBadge = receipt.method === 'cash' ? 'badge-success' :
                       receipt.method === 'bank_transfer' ? 'badge-primary' :
                       receipt.method === 'cheque' ? 'badge-warning' :
                       'badge-info';
    
    return `
      <tr>
        <td><span class="text-muted">${receipt.id.substring(0, 8)}</span></td>
        <td>${receipt.date}</td>
        <td>
          <span class="cursor-pointer text-primary" 
                onclick="openCustomerModal('${receipt.customerId}')">
            ${escapeHtml(customer?.name || 'Unknown')}
          </span>
        </td>
        <td>${escapeHtml(project?.name || 'Unknown')}</td>
        <td class="text-success font-semibold">${formatCurrency(receipt.amount)}</td>
        <td>
          <span class="badge ${methodBadge}">
            ${receipt.method.replace('_', ' ').toUpperCase()}
          </span>
        </td>
        <td>${escapeHtml(receipt.reference || '-')}</td>
        <td>
          <div class="btn-group">
            <button class="action-btn btn-danger" 
                    onclick="deleteReceipt('${receipt.id}')">
              Delete
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
  
  tbody.innerHTML = html || `
    <tr>
      <td colspan="8" style="text-align: center; color: var(--gray-400); padding: 40px;">
        No receipts found
      </td>
    </tr>
  `;
  
  // Render pagination
  renderPagination(pagination, current, totalPages, 'receipts');
}

function renderPagination(container, currentPage, totalPages, type) {
  if (!container) return;
  
  if (totalPages <= 1) {
    container.innerHTML = '';
    return;
  }
  
  let html = '<div class="btn-group">';
  
  // Previous button
  html += `
    <button class="btn btn-sm ${currentPage === 1 ? 'btn-secondary' : 'btn-primary'}" 
            ${currentPage === 1 ? 'disabled' : `onclick="changePage('${type}', ${currentPage - 1})"`}>
      ‚Üê Previous
    </button>
  `;
  
  // Page numbers
  const maxVisible = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
  let endPage = Math.min(totalPages, startPage + maxVisible - 1);
  
  if (endPage - startPage + 1 < maxVisible) {
    startPage = Math.max(1, endPage - maxVisible + 1);
  }
  
  for (let i = startPage; i <= endPage; i++) {
    html += `
      <button class="btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-secondary'}" 
              onclick="changePage('${type}', ${i})">
        ${i}
      </button>
    `;
  }
  
  // Next button
  html += `
    <button class="btn btn-sm ${currentPage === totalPages ? 'btn-secondary' : 'btn-primary'}" 
            ${currentPage === totalPages ? 'disabled' : `onclick="changePage('${type}', ${currentPage + 1})"`}>
      Next ‚Üí
    </button>
  `;
  
  html += '</div>';
  container.innerHTML = html;
}

function changePage(type, page) {
  currentPage[type] = page;
  refreshSection(type);
}

// Form Functions
function toggleContactSelection() {
  try {
    const contactType = document.getElementById('intContactType');
    if (!contactType) {
      console.error('Contact type element not found');
      return;
    }
    
    const value = contactType.value || 'customer';
    console.log('Toggling contact selection to:', value);
    
    const customerGroup = document.getElementById('customerSelectGroup');
    const brokerGroup = document.getElementById('brokerSelectGroup');
    
    if (customerGroup && brokerGroup) {
      customerGroup.style.display = value === 'customer' ? 'flex' : 'none';
      brokerGroup.style.display = value === 'broker' ? 'flex' : 'none';
      console.log('Contact groups toggled successfully');
    } else {
      console.error('Contact group elements not found');
    }
  } catch (error) {
    console.error('Error in toggleContactSelection:', error);
  }
}

function recalcSale() {
  const marlas = parseFloat(document.getElementById('marlas').value) || 0;
  const rate = parseFloat(document.getElementById('rate').value) || 0;
  const sale = marlas * rate;
  document.getElementById('sale').value = sale.toFixed(2);
}

function loadProjectsForReceipt() {
  const customerId = document.getElementById('recCust').value;
  const projectSelect = document.getElementById('recProj');
  const installmentSelect = document.getElementById('installmentSelect');
  
  const projects = db.projects.filter(p => p.customerId === customerId && p.status === 'active');
  
  projectSelect.innerHTML = projects.map(p => {
    const balance = p.sale - (p.received || 0);
    return `<option value="${p.id}">${escapeHtml(p.name)} - ${escapeHtml(p.unit)} (Balance: ${formatCurrency(balance)})</option>`;
  }).join('');
  
  // Load installments for first project
  if (projects.length > 0) {
    loadInstallmentsForProject(projects[0].id);
  } else {
    installmentSelect.innerHTML = '<option value="">Auto-allocate</option>';
  }
}

function loadInstallmentsForProject(projectId) {
  const project = db.projects.find(p => p.id === projectId);
  const installmentSelect = document.getElementById('installmentSelect');
  
  if (!project || !project.installments) {
    installmentSelect.innerHTML = '<option value="">Auto-allocate</option>';
    return;
  }
  
  const installments = project.installments
    .filter(i => !i.paid)
    .map(i => {
      const remaining = i.amount - (i.partialPaid || 0);
      return `<option value="${i.id}">Installment ${i.number} - Due: ${i.dueDate} (${formatCurrency(remaining)} remaining)</option>`;
    });
  
  installmentSelect.innerHTML = '<option value="">Auto-allocate</option>' + installments.join('');
}

function populateSelects() {
  const customers = db.customers.filter(c => c.type === 'customer' || c.type === 'both');
  const brokers = db.customers.filter(c => c.type === 'broker' || c.type === 'both');
  
  const customerOptions = customers.map(c => 
    `<option value="${c.id}">${escapeHtml(c.name)} - ${escapeHtml(c.phone)}</option>`
  ).join('');
  
  const brokerOptions = brokers.map(b => 
    `<option value="${b.id}">${escapeHtml(b.name)} - ${escapeHtml(b.phone)}</option>`
  ).join('');
  
  // Update all customer selects
  ['projCust', 'intCust', 'recCust'].forEach(id => {
    const select = document.getElementById(id);
    if (select) {
      select.innerHTML = customerOptions;
    }
  });
  
  // Update broker selects
  const projBrokerSelect = document.getElementById('projBroker');
  if (projBrokerSelect) {
    projBrokerSelect.innerHTML = '<option value="">Select Broker</option>' + brokerOptions;
  }
  
  const intBrokerSelect = document.getElementById('intBroker');
  if (intBrokerSelect) {
    intBrokerSelect.innerHTML = '<option value="">Select Broker</option>' + brokerOptions;
  }
}

// Modal Functions
function openAddCustomerModal() {
  document.getElementById('addCustomerModal').classList.add('show');
}

function closeAddCustomerModal() {
  document.getElementById('addCustomerModal').classList.remove('show');
  document.getElementById('customerForm').reset();
}

function openAddProjectModal() {
  populateSelects();
  document.getElementById('addProjectModal').classList.add('show');
}

function closeAddProjectModal() {
  document.getElementById('addProjectModal').classList.remove('show');
  document.getElementById('projectForm').reset();
}

function openAddInteractionModal() {
  populateSelects();
  document.getElementById('addInteractionModal').classList.add('show');
  
  // Set default date/time
  const now = new Date();
  document.querySelector('#addInteractionModal input[name="date"]').value = 
    getDateTimeString(now);
}

function closeAddInteractionModal() {
  document.getElementById('addInteractionModal').classList.remove('show');
  document.getElementById('interactionForm').reset();
  toggleContactSelection();
}




function renderLeadsDashboard() {

console.log('=== renderLeadsDashboard STARTED ===');
  
  // Make sure we're using the global db object
  if (typeof db === 'undefined' || !db.interactions) {
    console.log('ERROR: db is not defined or has no interactions array');
    return;
  }


  const dashboardContainer = document.getElementById('leadsDashboard');
  if (!dashboardContainer) return;
  
  const today = new Date();
  const sevenDaysAgo = new Date(today - 7 * 24 * 60 * 60 * 1000);
  const fourteenDaysAgo = new Date(today - 14 * 24 * 60 * 60 * 1000);
  
  // Categorize customers
  const categories = {
    notCalled7: [],
    notCalled14: [],
    notCalled14Plus: [],
    hasEmailNoContact: [],
    neverContacted: []
  };
  
  db.customers.forEach(customer => {
    const hasPhone = customer.phone && customer.phone.trim() !== '';
    const hasEmail = customer.email && customer.email.trim() !== '';
    
    // Get all interactions for this customer
    const customerInteractions = db.interactions.filter(i => i.customerId === customer.id);
    const allContactInteractions = db.interactions.filter(i => 
  (i.customerId === customer.id || i.brokerId === customer.id) &&
  (i.type === 'call' || i.type === 'whatsapp' || i.type === 'sms' || 
   i.type === 'email' || i.type === 'meeting' || i.type === 'site_visit')
);
    const emailInteractions = customerInteractions.filter(i => i.type === 'Email');
    
    console.log(`Customer: ${customer.name}, Interactions: ${allContactInteractions.length}`);
    


    // Never contacted at all
    if ((hasPhone || hasEmail) && allContactInteractions.length === 0) {
        console.log(`  ‚Üí Never contacted: ${customer.name}`);
      categories.neverContacted.push(customer);
      return;
    }
    
    // Has email but never sent email (but has been contacted via other methods)
    if (hasEmail && emailInteractions.length === 0 && allContactInteractions.length > 0) {
      categories.hasEmailNoContact.push(customer);
    }
    
    // Check last contact date (any interaction type)
    if (hasPhone || hasEmail) {
      if (allContactInteractions.length > 0) {
        const lastContactDate = new Date(Math.max(...allContactInteractions.map(i => new Date(i.date))));
        
        if (lastContactDate < fourteenDaysAgo) {
          categories.notCalled14Plus.push({ customer, lastContact: lastContactDate });
        } else if (lastContactDate < sevenDaysAgo) {
          categories.notCalled14.push({ customer, lastContact: lastContactDate });
        } else if (lastContactDate >= sevenDaysAgo) {
          categories.notCalled7.push({ customer, lastContact: lastContactDate });
        }
      }
    }
  });


  console.log('Categories:', {
    neverContacted: categories.neverContacted.length,
    notCalled14Plus: categories.notCalled14Plus.length,
    notCalled14: categories.notCalled14.length,
    notCalled7: categories.notCalled7.length,
    hasEmailNoContact: categories.hasEmailNoContact.length
  });
  console.log('=== renderLeadsDashboard COMPLETED ===');


  document.addEventListener('DOMContentLoaded', function() {
  // Listen for clicks on any element with data-tab="interactions"
  const interactionsTab = document.querySelector('[data-tab="interactions"]');
  if (interactionsTab) {
    interactionsTab.addEventListener('click', function() {
      setTimeout(renderLeadsDashboard, 100); // Small delay to ensure tab is visible
    });
  }
});
  
  // Helper function to render customer card
  function renderCustomerCard(customer, lastContact = null) {
    const daysSince = lastContact ? 
      Math.floor((today - lastContact) / (24 * 60 * 60 * 1000)) : null;
    
    return `
      <div class="lead-card" onclick="openCustomer('${customer.id}')">
        <div class="lead-card-header">
          <strong>${escapeHtml(customer.name)}</strong>
          ${daysSince ? `<span class="days-badge">${daysSince}d ago</span>` : ''}
        </div>
        <div class="lead-card-body">
          ${customer.phone ? `<div><span style="color:#3498db">üìû</span> ${escapeHtml(customer.phone)}</div>` : ''}
          ${customer.email ? `<div><span style="color:#e74c3c">üìß</span> ${escapeHtml(customer.email)}</div>` : ''}
          ${customer.company ? `<div style="font-size:12px;color:#7f8c8d">üè¢ ${escapeHtml(customer.company)}</div>` : ''}
        </div>
      </div>
    `;
  }
  
  dashboardContainer.innerHTML = `
    <div class="leads-grid">
      <!-- Never Contacted -->
      <div class="lead-category urgent">
        <div class="category-header">
          <div>
            <h4>üö® Never Contacted</h4>
            <p>Leads with contact info but no outreach</p>
          </div>
          <span class="count-badge">${categories.neverContacted.length}</span>
        </div>
        <div class="category-body">
          ${categories.neverContacted.length > 0 ? 
            categories.neverContacted.map(c => renderCustomerCard(c)).join('') :
            '<p class="empty-state">‚úì All leads have been contacted</p>'
          }
        </div>
      </div>
      
      <!-- Not Called 14+ Days -->
      <div class="lead-category danger">
        <div class="category-header">
          <div>
            <h4>üî¥ Not Called > 14 Days</h4>
            <p>High priority follow-ups needed</p>
          </div>
          <span class="count-badge">${categories.notCalled14Plus.length}</span>
        </div>
        <div class="category-body">
          ${categories.notCalled14Plus.length > 0 ? 
            categories.notCalled14Plus.map(item => renderCustomerCard(item.customer, item.lastContact)).join('') :
            '<p class="empty-state">‚úì No overdue follow-ups</p>'
          }
        </div>
      </div>
      
      <!-- Not Called 8-14 Days -->
      <div class="lead-category warning">
        <div class="category-header">
          <div>
            <h4>üü° Not Called 8-14 Days</h4>
            <p>Follow-up recommended</p>
          </div>
          <span class="count-badge">${categories.notCalled14.length}</span>
        </div>
        <div class="category-body">
          ${categories.notCalled14.length > 0 ? 
            categories.notCalled14.map(item => renderCustomerCard(item.customer, item.lastContact)).join('') :
            '<p class="empty-state">‚úì No pending follow-ups</p>'
          }
        </div>
      </div>
      
      <!-- Not Called 1-7 Days -->
      <div class="lead-category info">
        <div class="category-header">
          <div>
            <h4>üîµ Not Called 1-7 Days</h4>
            <p>Recent contacts to monitor</p>
          </div>
          <span class="count-badge">${categories.notCalled7.length}</span>
        </div>
        <div class="category-body">
          ${categories.notCalled7.length > 0 ? 
            categories.notCalled7.map(item => renderCustomerCard(item.customer, item.lastContact)).join('') :
            '<p class="empty-state">‚úì All recent contacts up to date</p>'
          }
        </div>
      </div>
      
      <!-- Has Email but Never Emailed -->
      <div class="lead-category email">
        <div class="category-header">
          <div>
            <h4>üìß Has Email - Not Contacted</h4>
            <p>Email outreach opportunity</p>
          </div>
          <span class="count-badge">${categories.hasEmailNoContact.length}</span>
        </div>
        <div class="category-body">
          ${categories.hasEmailNoContact.length > 0 ? 
            categories.hasEmailNoContact.map(c => renderCustomerCard(c)).join('') :
            '<p class="empty-state">‚úì All email leads contacted</p>'
          }
        </div>
      </div>
    </div>
    
    <style>
      .leads-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
      }
      
      .lead-category {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 2px solid #e0e0e0;
        transition: all 0.3s ease;
      }
      
      .lead-category:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        transform: translateY(-2px);
      }
      
      .lead-category.urgent { border-left: 5px solid #9b59b6; }
      .lead-category.danger { border-left: 5px solid #e74c3c; }
      .lead-category.warning { border-left: 5px solid #f39c12; }
      .lead-category.info { border-left: 5px solid #3498db; }
      .lead-category.email { border-left: 5px solid #1abc9c; }
      
      .category-header {
        padding: 16px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #dee2e6;
      }
      
      .category-header h4 {
        margin: 0 0 4px 0;
        font-size: 15px;
        color: #2c3e50;
        font-weight: 600;
      }
      
      .category-header p {
        margin: 0;
        font-size: 12px;
        color: #7f8c8d;
      }
      
      .count-badge {
        background: #2c3e50;
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 14px;
        min-width: 32px;
        text-align: center;
      }
      
      .category-body {
        padding: 12px;
        max-height: 400px;
        overflow-y: auto;
      }
      
      .lead-card {
        background: #ffffff;
        border: 1.5px solid #e8eef5;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .lead-card:hover {
        background: #f8f9fa;
        border-color: #3498db;
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(52, 152, 219, 0.15);
      }
      
      .lead-card:last-child {
        margin-bottom: 0;
      }
      
      .lead-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      
      .lead-card-header strong {
        color: #2c3e50;
        font-size: 14px;
      }
      
      .days-badge {
        background: #fee;
        color: #e74c3c;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
      }
      
      .lead-card-body {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 13px;
        color: #555;
      }
      
      .empty-state {
        text-align: center;
        padding: 32px 16px;
        color: #95a5a6;
        font-size: 14px;
        font-style: italic;
      }
      
      /* Custom scrollbar */
      .category-body::-webkit-scrollbar {
        width: 6px;
      }
      
      .category-body::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      
      .category-body::-webkit-scrollbar-thumb {
        background: #bdc3c7;
        border-radius: 10px;
      }
      
      .category-body::-webkit-scrollbar-thumb:hover {
        background: #95a5a6;
      }
      
      @media (max-width: 768px) {
        .leads-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  `;
}













function openAddReceiptModal() {
  populateSelects();
  document.getElementById('addReceiptModal').classList.add('show');
  
  // Set default date
  document.querySelector('#addReceiptModal input[name="date"]').value = 
    getDateString();
}

function closeAddReceiptModal() {
  document.getElementById('addReceiptModal').classList.remove('show');
  document.getElementById('receiptForm').reset();
  document.getElementById('recProj').innerHTML = '';
  document.getElementById('installmentSelect').innerHTML = '<option value="">Auto-allocate</option>';
}

function openCustomerModal(customerId) {
  console.log('Opening customer modal for ID:', customerId);
  
  try {
    const customer = db.customers.find(c => c.id === customerId);
    if (!customer) {
      console.error('Customer not found:', customerId);
      showNotification('error', 'Error', 'Customer not found.');
      return;
    }
    
    console.log('Customer found:', customer.name);
    
    // Calculate financials safely
    let financials;
    try {
      financials = calculateCustomerFinancials(customerId);
      console.log('Financials calculated:', financials);
    } catch (e) {
      console.error('Error calculating financials:', e);
      financials = {
        totalSale: 0,
        totalReceived: 0,
        totalReceivable: 0,
        totalOverdue: 0,
        totalFuture: 0,
        percentagePaid: 0
      };
    }
    
    const customerProjects = db.projects.filter(p => p.customerId === customerId);
    console.log('Customer projects:', customerProjects.length);
    
    const brokerProjects = db.projects.filter(p => p.brokerId === customerId);
    console.log('Broker projects:', brokerProjects.length);
    
    const customerInteractions = db.interactions
      .filter(i => i.customerId === customerId || i.brokerId === customerId)
      .sort((a, b) => new Date(b.date) - new Date(a.date))
      .slice(0, 10);
    console.log('Customer interactions:', customerInteractions.length);
    
    // Prepare modal content
    let html = `
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <!-- Customer Details -->
        <div>
          <h4 style="margin-bottom: 16px;">Customer Information</h4>
          <div style="background: var(--gray-50); padding: 20px; border-radius: var(--radius); margin-bottom: 20px;">
            <div style="display: grid; gap: 12px;">
              <div><strong>Name:</strong> ${escapeHtml(customer.name || 'Unknown')}</div>
    `;
    
    const customerType = customer.type || 'customer';
    html += `<div><strong>Type:</strong> <span class="badge ${customerType === 'customer' ? 'badge-primary' : customerType === 'broker' ? 'badge-success' : 'badge-warning'}">${customerType.toUpperCase()}</span></div>`;
    
    html += `
              <div><strong>Phone:</strong> ${escapeHtml(customer.phone || '')}</div>
              <div><strong>Email:</strong> ${escapeHtml(customer.email || '-')}</div>
              <div><strong>CNIC:</strong> ${escapeHtml(customer.cnic || '')}</div>
              <div><strong>Company:</strong> ${escapeHtml(customer.company || '-')}</div>
              <div><strong>Address:</strong> ${escapeHtml(customer.address || '-')}</div>
    `;
    
    const customerStatus = customer.status || 'active';
    html += `<div><strong>Status:</strong> <span class="badge ${customerStatus === 'active' ? 'badge-success' : 'badge-danger'}">${customerStatus.toUpperCase()}</span></div>`;
    
    html += `
              <div><strong>Created:</strong> ${formatDate(customer.createdAt || new Date().toISOString())}</div>
              <div><strong>Last Updated:</strong> ${formatDate(customer.updatedAt || customer.createdAt || new Date().toISOString())}</div>
            </div>
          </div>
          
          <!-- Financial Summary -->
          <h4 style="margin-bottom: 16px;">Financial Summary</h4>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
            <div style="background: white; padding: 16px; border-radius: var(--radius); border: 1px solid var(--gray-200);">
              <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: 4px;">Total Sale Value</div>
              <div style="font-size: 1.25rem; font-weight: 700;">${formatCurrency(financials.totalSale)}</div>
            </div>
            <div style="background: white; padding: 16px; border-radius: var(--radius); border: 1px solid var(--gray-200);">
              <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: 4px;">Total Received</div>
              <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">${formatCurrency(financials.totalReceived)}</div>
            </div>
            <div style="background: white; padding: 16px; border-radius: var(--radius); border: 1px solid var(--gray-200);">
              <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: 4px;">Total Receivable</div>
              <div style="font-size: 1.25rem; font-weight: 700;">${formatCurrency(financials.totalReceivable)}</div>
            </div>
            <div style="background: white; padding: 16px; border-radius: var(--radius); border: 1px solid var(--gray-200);">
              <div style="font-size: 0.75rem; color: var(--gray-600); margin-bottom: 4px;">Total Overdue</div>
              <div style="font-size: 1.25rem; font-weight: 700; color: var(--danger);">${formatCurrency(financials.totalOverdue)}</div>
            </div>
          </div>
          
          <!-- Quick Actions -->
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-sm btn-primary" onclick="logInteractionForCustomer('${customerId}', '${customerType}')">
              üí¨ Log Interaction
            </button>
            <button class="btn btn-sm btn-success" onclick="openAddReceiptForCustomer('${customerId}')">
              üí∞ Add Receipt
            </button>
          </div>
        </div>
        
        <!-- Projects & Interactions -->
        <div>
          <!-- Customer Projects -->
          <h4 style="margin-bottom: 16px;">Projects (${customerProjects.length})</h4>
          <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
    `;
    
    if (customerProjects.length === 0) {
      html += '<p class="text-muted">No projects found</p>';
    } else {
      customerProjects.forEach(project => {
        let projFinancials;
        try {
          projFinancials = calculateProjectFinancials(project);
        } catch (e) {
          projFinancials = {
            totalSale: 0,
            totalReceived: 0,
            totalReceivable: 0,
            totalOverdue: 0
          };
        }
        
        const projectStatus = project.status || 'active';
        
        // Build installment details
        let installmentDetails = '';
        if (project.installments && project.installments.length > 0) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          installmentDetails = `
            <div style="margin-top: 12px; padding: 12px; background: var(--gray-50); border-radius: var(--radius-sm); border: 1px solid var(--gray-200);">
              <div style="font-weight: 600; margin-bottom: 8px; color: var(--gray-700); font-size: 0.85rem; display: flex; align-items: center; gap: 6px;">
                üìÖ <span>Installment Schedule</span>
              </div>
              <div style="max-height: 200px; overflow-y: auto;">
          `;
          
          project.installments.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)).forEach(inst => {
            const dueDate = new Date(inst.dueDate);
            dueDate.setHours(0, 0, 0, 0);
            const isOverdue = dueDate < today && !inst.paid;
            const remaining = inst.amount - (inst.partialPaid || 0);
            const status = inst.paid ? 'Paid' : 
                         (inst.partialPaid > 0 ? 'Partial' : 
                         (isOverdue ? 'Overdue' : 'Pending'));
            
            const statusColor = inst.paid ? 'var(--success)' : 
                              (inst.partialPaid > 0 ? 'var(--warning)' : 
                              (isOverdue ? 'var(--danger)' : 'var(--primary)'));
            
            const dueDateFormatted = inst.dueDate ? formatDate(inst.dueDate) : 'No date';
            
            installmentDetails += `
              <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; padding: 8px; background: white; border-radius: 6px; border: 1px solid var(--gray-200); margin-bottom: 6px;">
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 40px;">
                  <div style="font-weight: 700; color: var(--gray-600); font-size: 0.85rem;">#${inst.number}</div>
                  <div style="font-size: 0.7rem; color: var(--gray-500);">of ${project.installments.length}</div>
                </div>
                <div>
                  <div style="font-weight: 600; color: var(--gray-900); font-size: 0.85rem;">${dueDateFormatted}</div>
                  <div style="font-size: 0.75rem; color: var(--gray-600); display: flex; gap: 8px; margin-top: 2px;">
                    <span><strong>Amount:</strong> ${formatCurrency(inst.amount)}</span>
                    <span><strong>Paid:</strong> ${formatCurrency(inst.partialPaid || 0)}</span>
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 0.75rem; padding: 4px 8px; border-radius: 12px; background: ${status === 'Paid' ? '#d1fae5' : status === 'Partial' ? '#fef3c7' : status === 'Overdue' ? '#fee2e2' : '#e0f2fe'}; color: ${status === 'Paid' ? '#065f46' : status === 'Partial' ? '#92400e' : status === 'Overdue' ? '#991b1b' : '#1e40af'}; font-weight: 600;">
                    ${status}
                  </div>
                  ${remaining > 0 && !inst.paid ? `
                    <div style="font-size: 0.7rem; color: var(--gray-600); margin-top: 2px;">
                      Balance: ${formatCurrency(remaining)}
                    </div>
                  ` : ''}
                </div>
              </div>
            `;
          });
          
          // Calculate installment summary
          const totalInstallments = project.installments.length;
          const paidInstallments = project.installments.filter(i => i.paid).length;
          const partialInstallments = project.installments.filter(i => !i.paid && (i.partialPaid || 0) > 0).length;
          const overdueInstallments = project.installments.filter(i => {
            if (i.paid) return false;
            const dueDate = new Date(i.dueDate);
            dueDate.setHours(0, 0, 0, 0);
            return dueDate < today;
          }).length;
          
          installmentDetails += `
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--gray-600); margin-top: 10px; padding-top: 8px; border-top: 1px solid var(--gray-200);">
                  <div><strong>Total:</strong> ${totalInstallments}</div>
                  <div style="color: var(--success);"><strong>Paid:</strong> ${paidInstallments}</div>
                  <div style="color: var(--warning);"><strong>Partial:</strong> ${partialInstallments}</div>
                  <div style="color: var(--danger);"><strong>Overdue:</strong> ${overdueInstallments}</div>
                </div>
              </div>
          `;
        }
        
        html += `
          <div style="background: white; padding: 16px; border-radius: var(--radius); border: 1px solid var(--gray-200); margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div style="font-weight: 700; color: var(--gray-900);">
                ${escapeHtml(project.name || 'Unnamed')} - ${escapeHtml(project.unit || '')}
              </div>
              <span class="badge ${projectStatus === 'active' ? 'badge-success' : projectStatus === 'completed' ? 'badge-primary' : 'badge-danger'}">
                ${projectStatus.toUpperCase()}
              </span>
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 0.9rem; margin-bottom: 12px;">
              <div><strong>Sale:</strong> ${formatCurrency(projFinancials.totalSale)}</div>
              <div><strong>Received:</strong> ${formatCurrency(projFinancials.totalReceived)}</div>
              <div><strong>Balance:</strong> ${formatCurrency(projFinancials.totalReceivable)}</div>
              <div><strong>Overdue:</strong> ${formatCurrency(projFinancials.totalOverdue)}</div>
            </div>
            ${installmentDetails}
          </div>
        `;
      });
    }
    
    html += `
          </div>
    `;
    
    // Brokered Projects with installment details
    if (brokerProjects.length > 0) {
      html += `
        <h4 style="margin-bottom: 16px;">Brokered Projects (${brokerProjects.length})</h4>
        <div style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;">
      `;
      
      brokerProjects.forEach(project => {
        const customer = db.customers.find(c => c.id === project.customerId);
        const projectStatus = project.status || 'active';
        
        let installmentSummary = '';
        if (project.installments && project.installments.length > 0) {
          const totalInstallments = project.installments.length;
          const paidInstallments = project.installments.filter(i => i.paid).length;
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const overdueInstallments = project.installments.filter(i => {
            if (i.paid) return false;
            const dueDate = new Date(i.dueDate);
            dueDate.setHours(0, 0, 0, 0);
            return dueDate < today;
          }).length;
          
          installmentSummary = `
            <div style="display: flex; gap: 8px; font-size: 0.75rem; color: var(--gray-600); margin-top: 6px; padding-top: 6px; border-top: 1px dashed var(--gray-200);">
              <div>Installments: ${totalInstallments}</div>
              <div style="color: var(--success);">‚úì ${paidInstallments} paid</div>
              ${overdueInstallments > 0 ? `<div style="color: var(--danger);">‚ö† ${overdueInstallments} overdue</div>` : ''}
            </div>
          `;
        }
        
        html += `
          <div style="background: white; padding: 12px; border-radius: var(--radius); border: 1px solid var(--gray-200); margin-bottom: 8px;">
            <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 4px;">
              ${escapeHtml(project.name || 'Unnamed')} - ${escapeHtml(project.unit || '')}
            </div>
            <div style="font-size: 0.85rem; color: var(--gray-600);">
              <div>Customer: <span class="link" onclick="openCustomerModal('${project.customerId}')" style="color: var(--primary); cursor: pointer;">${escapeHtml(customer?.name || 'Unknown')}</span></div>
              <div>Status: <span class="badge ${projectStatus === 'active' ? 'badge-success' : projectStatus === 'completed' ? 'badge-primary' : 'badge-danger'}" style="font-size: 0.7rem;">${projectStatus.toUpperCase()}</span></div>
              ${installmentSummary}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
    }
    
    // Recent Interactions
    html += `
      <h4 style="margin-bottom: 16px;">Recent Interactions</h4>
      <div style="max-height: 300px; overflow-y: auto;">
    `;
    
    if (customerInteractions.length === 0) {
      html += '<p class="text-muted">No interactions found</p>';
    } else {
      customerInteractions.forEach(interaction => {
        const intType = interaction.type || 'call';
        const intStatus = interaction.status || 'follow_up';
        const intPriority = interaction.priority || 'medium';
        const typeIcon = intType === 'call' ? 'üìû' : 
                        intType === 'whatsapp' ? 'üí¨' : 
                        intType === 'sms' ? '‚úâÔ∏è' : 
                        intType === 'email' ? 'üìß' : 
                        intType === 'meeting' ? 'ü§ù' : 
                        intType === 'site_visit' ? 'üèóÔ∏è' : 'üìù';
        
        html += `
          <div style="background: white; padding: 12px; border-radius: var(--radius); border: 1px solid var(--gray-200); margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
              <div style="font-weight: 600; color: var(--gray-900); display: flex; align-items: center; gap: 6px;">
                ${typeIcon} ${intType.replace('_', ' ').toUpperCase()}
              </div>
              <div style="font-size: 0.75rem; color: var(--gray-500);">
                ${formatDate(interaction.date)}
              </div>
            </div>
            <div style="font-size: 0.85rem; color: var(--gray-600); margin-bottom: 4px;">
              ${escapeHtml(interaction.notes || 'No notes')}
            </div>
            <div style="display: flex; gap: 6px;">
              <span class="badge ${intStatus === 'follow_up' ? 'badge-warning' : 'badge-success'}" style="font-size: 0.7rem;">
                ${intStatus.replace('_', ' ').toUpperCase()}
              </span>
              <span class="badge ${intPriority === 'urgent' ? 'badge-danger' : intPriority === 'high' ? 'badge-warning' : 'badge-primary'}" style="font-size: 0.7rem;">
                ${intPriority.toUpperCase()}
              </span>
              ${interaction.nextFollowUp ? `
                <span style="font-size: 0.7rem; color: var(--gray-500);">
                  Next: ${formatDate(interaction.nextFollowUp)}
                </span>
              ` : ''}
            </div>
          </div>
        `;
      });
    }
    
    html += `
        </div>
      </div>
    </div>
    `;
    
    document.getElementById('viewCustomerTitle').textContent = customer.name;
    document.getElementById('viewCustomerContent').innerHTML = html;
    document.getElementById('viewCustomerModal').classList.add('show');
    
    console.log('Customer modal opened successfully');
    
  } catch (error) {
    console.error('Error opening customer modal:', error);
    console.error('Error stack:', error.stack);
    showNotification('error', 'Error', 'Failed to open customer details. Check console for details.');
  }
}

function closeViewCustomerModal() {
  document.getElementById('viewCustomerModal').classList.remove('show');
}

function openAddReceiptForCustomer(customerId) {
  closeViewCustomerModal();
  openAddReceiptModal();
  document.getElementById('recCust').value = customerId;
  loadProjectsForReceipt();
}

function logInteractionForCustomer(customerId, contactType) {
  try {
    closeViewCustomerModal();
    openAddInteractionModal();
    
    // Debug logging
    console.log('Logging interaction for customer:', customerId, 'Contact type:', contactType);
    
    // Ensure contactType is valid
    const validContactType = (contactType === 'broker') ? 'broker' : 'customer';
    console.log('Valid contact type set to:', validContactType);
    
    // Update the select element
    const contactTypeSelect = document.getElementById('intContactType');
    if (contactTypeSelect) {
      contactTypeSelect.value = validContactType;
      console.log('Contact type select set to:', contactTypeSelect.value);
    } else {
      console.error('Contact type select element not found!');
    }
    
    // Trigger the toggle function
    toggleContactSelection();
    
    // Find the customer to verify their type
    const customer = db.customers.find(c => c.id === customerId);
    console.log('Customer found:', customer ? customer.name : 'Not found');
    console.log('Customer type from DB:', customer ? customer.type : 'N/A');
    
    // Set the appropriate select value
    if (validContactType === 'customer') {
      const customerSelect = document.getElementById('intCust');
      if (customerSelect) {
        customerSelect.value = customerId;
        console.log('Customer select set to:', customerId);
      }
    } else {
      const brokerSelect = document.getElementById('intBroker');
      if (brokerSelect) {
        brokerSelect.value = customerId;
        console.log('Broker select set to:', customerId);
      }
    }
    
    const now = new Date();
    const dateInput = document.querySelector('#addInteractionModal input[name="date"]');
    if (dateInput) {
      dateInput.value = getDateTimeString(now);
      console.log('Date set to:', dateInput.value);
    }
    
  } catch (error) {
    console.error('Error in logInteractionForCustomer:', error);
    console.error('Error stack:', error.stack);
    showNotification('error', 'Interaction Error', 
      `Failed to open interaction form: ${error.message}`);
  }
}

function logFollowUp(contactId, contactType) {
  try {
    console.log('Logging follow-up for contact:', contactId, 'Type:', contactType);
    
    openAddInteractionModal();
    
    // Validate and set contact type
    const validContactType = (contactType === 'broker') ? 'broker' : 'customer';
    console.log('Using contact type:', validContactType);
    
    const contactTypeSelect = document.getElementById('intContactType');
    if (contactTypeSelect) {
      contactTypeSelect.value = validContactType;
    }
    
    toggleContactSelection();
    
    // Set the contact
    if (validContactType === 'customer') {
      const customerSelect = document.getElementById('intCust');
      if (customerSelect) {
        customerSelect.value = contactId;
      }
    } else {
      const brokerSelect = document.getElementById('intBroker');
      if (brokerSelect) {
        brokerSelect.value = contactId;
      }
    }
    
    const now = new Date();
    const nextWeek = new Date();
    nextWeek.setDate(nextWeek.getDate() + 7);
    
    // Set form values
    const dateInput = document.querySelector('#addInteractionModal input[name="date"]');
    const followupInput = document.querySelector('#addInteractionModal input[name="nextFollowUp"]');
    const statusSelect = document.querySelector('#addInteractionModal select[name="status"]');
    const prioritySelect = document.querySelector('#addInteractionModal select[name="priority"]');
    
    if (dateInput) dateInput.value = getDateTimeString(now);
    if (followupInput) followupInput.value = getDateString(nextWeek);
    if (statusSelect) statusSelect.value = 'follow_up';
    if (prioritySelect) prioritySelect.value = 'high';
    
    console.log('Follow-up form pre-filled successfully');
    
    showNotification('info', 'Follow-up', 'Follow-up form pre-filled. Please add notes and save.');
    
  } catch (error) {
    console.error('Error in logFollowUp:', error);
    console.error('Error stack:', error.stack);
    showNotification('error', 'Follow-up Error', 
      `Failed to open follow-up form: ${error.message}`);
  }
}

function editCustomer(customerId) {
  const customer = db.customers.find(c => c.id === customerId);
  if (!customer) return;
  
  // Populate edit form
  document.getElementById('editCustomerId').value = customer.id;
  document.getElementById('editCustomerName').value = customer.name;
  document.getElementById('editCustomerCnic').value = customer.cnic;
  document.getElementById('editCustomerPhone').value = customer.phone;
  document.getElementById('editCustomerEmail').value = customer.email || '';
  document.getElementById('editCustomerCompany').value = customer.company || '';
  document.getElementById('editCustomerAddress').value = customer.address || '';
  document.getElementById('editCustomerType').value = customer.type;
  document.getElementById('editCustomerStatus').value = customer.status;
  
  document.getElementById('editCustomerModal').classList.add('show');
}

function closeEditCustomerModal() {
  document.getElementById('editCustomerModal').classList.remove('show');
  document.getElementById('editCustomerForm').reset();
}

function editCustomerFromView() {
  const customerId = document.getElementById('editCustomerId').value;
  if (!customerId) return;
  
  closeViewCustomerModal();
  editCustomer(customerId);
}

function viewProject(projectId) {
  const project = db.projects.find(p => p.id === projectId);
  if (!project) return;
  
  const customer = db.customers.find(c => c.id === project.customerId);
  const broker = project.brokerId ? db.customers.find(c => c.id === project.brokerId) : null;
  const financials = calculateProjectFinancials(project);
  
  let html = `
    <div style="max-width: 800px; margin: 0 auto;">
      <h4 style="margin-bottom: 20px;">Project Details</h4>
      
      <!-- Project Info -->
      <div style="background: var(--gray-50); padding: 20px; border-radius: var(--radius); margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
          <div><strong>Project Name:</strong> ${escapeHtml(project.name)}</div>
          <div><strong>Unit/Shop #:</strong> ${escapeHtml(project.unit)}</div>
          <div><strong>Customer:</strong> ${escapeHtml(customer?.name || 'Unknown')}</div>
          <div><strong>Broker:</strong> ${broker ? escapeHtml(broker.name) : 'None'}</div>
          <div><strong>Marlas:</strong> ${project.marlas}</div>
          <div><strong>Rate per Marla:</strong> ${formatCurrency(project.rate)}</div>
          <div><strong>Status:</strong> <span class="badge ${project.status === 'active' ? 'badge-success' : project.status === 'completed' ? 'badge-primary' : 'badge-danger'}">${project.status.toUpperCase()}</span></div>
          <div><strong>Payment Cycle:</strong> ${project.cycle.replace('_', ' ').toUpperCase()}</div>
        </div>
        ${project.notes ? `<div style="margin-top: 12px;"><strong>Notes:</strong> ${escapeHtml(project.notes)}</div>` : ''}
      </div>
      
      <!-- Financial Summary -->
      <h5 style="margin-bottom: 16px;">Financial Summary</h5>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
        <div style="text-align: center; background: white; padding: 16px; border-radius: var(--radius); border: 1px solid var(--gray-200);">
          <div style="font-size: 0.75rem; color: var(--gray-600);">Total Sale</div>
          <div style="font-size: 1.25rem; font-weight: 700;">${formatCurrency(financials.totalSale)}</div>
        </div>
        <div style="text-align: center; background: white; padding: 16px; border-radius: var(--radius); border: 1px solid var(--gray-200);">
          <div style="font-size: 0.75rem; color: var(--gray-600);">Received</div>
          <div style="font-size: 1.25rem; font-weight: 700; color: var(--success);">${formatCurrency(financials.totalReceived)}</div>
          <div style="font-size: 0.75rem; color: var(--success);">${financials.percentagePaid.toFixed(1)}%</div>
        </div>
        <div style="text-align: center; background: white; padding: 16px; border-radius: var(--radius); border: 1px solid var(--gray-200);">
          <div style="font-size: 0.75rem; color: var(--gray-600);">Balance</div>
          <div style="font-size: 1.25rem; font-weight: 700;">${formatCurrency(financials.totalReceivable)}</div>
        </div>
        <div style="text-align: center; background: white; padding: 16px; border-radius: var(--radius); border: 1px solid var(--gray-200);">
          <div style="font-size: 0.75rem; color: var(--gray-600);">Overdue</div>
          <div style="font-size: 1.25rem; font-weight: 700; color: var(--danger);">${formatCurrency(financials.totalOverdue)}</div>
        </div>
      </div>
      
      <!-- Installments -->
      <h5 style="margin-bottom: 16px;">Installment Schedule</h5>
      <div style="background: white; border-radius: var(--radius); border: 1px solid var(--gray-200); overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead style="background: var(--gray-50);">
            <tr>
              <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--gray-200);">#</th>
              <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--gray-200);">Due Date</th>
              <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--gray-200);">Amount</th>
              <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--gray-200);">Paid</th>
              <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--gray-200);">Balance</th>
              <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--gray-200);">Status</th>
            </tr>
          </thead>
          <tbody>
            ${project.installments && project.installments.length > 0 ? project.installments.map(installment => {
              const remaining = installment.amount - (installment.partialPaid || 0);
              const isOverdue = isOverdue(installment.dueDate);
              const status = installment.paid ? 'Paid' : 
                           (installment.partialPaid > 0 ? 'Partial' : 
                           (isOverdue ? 'Overdue' : 'Pending'));
              
              return `
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid var(--gray-100);">${installment.number}</td>
                  <td style="padding: 12px; border-bottom: 1px solid var(--gray-100); ${isOverdue ? 'color: var(--danger);' : ''}">${installment.dueDate}</td>
                  <td style="padding: 12px; border-bottom: 1px solid var(--gray-100);">${formatCurrency(installment.amount)}</td>
                  <td style="padding: 12px; border-bottom: 1px solid var(--gray-100); color: var(--success);">${formatCurrency(installment.partialPaid || 0)}</td>
                  <td style="padding: 12px; border-bottom: 1px solid var(--gray-100);">${formatCurrency(remaining)}</td>
                  <td style="padding: 12px; border-bottom: 1px solid var(--gray-100);">
                    <span class="badge ${status === 'Paid' ? 'badge-success' : status === 'Partial' ? 'badge-warning' : status === 'Overdue' ? 'badge-danger' : 'badge-info'}">
                      ${status}
                    </span>
                  </td>
                </tr>
              `;
            }).join('') : `
              <tr>
                <td colspan="6" style="padding: 20px; text-align: center; color: var(--gray-400);">
                  No installments found
                </td>
              </tr>
            `}
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  // Show in modal
  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h3 class="modal-title">üèó Project Details: ${escapeHtml(project.name)}</h3>
        <button class="btn btn-sm btn-secondary" onclick="this.closest('.modal').remove()">‚úï</button>
      </div>
      <div class="modal-body">
        ${html}
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
        <button class="btn btn-primary" onclick="editProject('${project.id}')">Edit Project</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// Data Management Functions
function submitCustomerForm() {
  const form = document.getElementById('customerForm');
  const formData = new FormData(form);
  
  try {
    // Validation
        
    
    if (!validateEmail(formData.get('email'))) {
      throw new Error('Invalid email format');
    }
    
    const customer = {
      id: generateId('cust'),
      name: formData.get('name'),
      cnic: formData.get('cnic'),
      phone: formData.get('phone'),
      email: formData.get('email'),
      company: formData.get('company'),
      address: formData.get('address'),
      type: formData.get('type'),
      status: formData.get('status') || 'active',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    
    db.customers.push(customer);
    saveToStorage();
    
    closeAddCustomerModal();
    refreshSection('customers');
    populateSelects();
    
    showNotification('success', 'Customer Added', 
      `${customer.name} has been added successfully as a ${customer.type}.`);
    
    return true;
  } catch (error) {
    showNotification('error', 'Error', error.message);
    return false;
  }
}

function saveCustomerEdit() {
  const form = document.getElementById('editCustomerForm');
  const formData = new FormData(form);
  
  try {
    const customerId = formData.get('id');
    const customer = db.customers.find(c => c.id === customerId);
    
    if (!customer) {
      throw new Error('Customer not found');
    }
    
    // Validation
    
    
    if (!validateEmail(formData.get('email'))) {
      throw new Error('Invalid email format');
    }
    
    // Update customer
    customer.name = formData.get('name');
    customer.cnic = formData.get('cnic');
    customer.phone = formData.get('phone');
    customer.email = formData.get('email');
    customer.company = formData.get('company');
    customer.address = formData.get('address');
    customer.type = formData.get('type');
    customer.status = formData.get('status');
    customer.updatedAt = new Date().toISOString();
    
    saveToStorage();
    
    closeEditCustomerModal();
    refreshSection('customers');
    populateSelects();
    
    showNotification('success', 'Customer Updated', 
      `${customer.name} has been updated successfully.`);
    
    return true;
  } catch (error) {
    showNotification('error', 'Error', error.message);
    return false;
  }
}

function submitProjectForm() {
  const form = document.getElementById('projectForm');
  const formData = new FormData(form);
  
  try {
    // Validation
    if (!formData.get('customerId') || !formData.get('project') || !formData.get('unit')) {
      throw new Error('Customer, Project Name, and Unit are required');
    }
    
    const projectName = formData.get('project');
    const unit = formData.get('unit');
    const marlas = parseFloat(formData.get('marlas')) || 0;
    const rate = parseFloat(formData.get('rate')) || 0;
    const saleValue = marlas * rate;
    
    // Check if unit is in inventory and available
    const inventoryItem = db.inventory.find(item => 
      item.projectName === projectName && item.unit === unit
    );
    
    if (inventoryItem && inventoryItem.status !== 'available') {
      throw new Error(`Unit ${unit} in ${projectName} is ${inventoryItem.status}.`);
    }
    
    const installments = parseInt(formData.get('installments')) || 2;
    if (installments < 1 || installments > 36) {
      throw new Error('Installments must be between 1 and 36');
    }
    
    const project = {
      id: generateId('proj'),
      customerId: formData.get('customerId'),
      brokerId: formData.get('brokerId') || null,
      name: projectName,
      unit: unit,
      marlas: marlas,
      rate: rate,
      sale: saleValue,
      received: 0,
      status: 'active',
      cycle: formData.get('cycle'),
      notes: formData.get('notes') || '',
      installments: [],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    
    // Create installments
    const baseAmount = Math.floor(saleValue / installments);
    let remainder = saleValue - (baseAmount * installments);
    const firstDue = formData.get('firstDue');
    
    for (let i = 0; i < installments; i++) {
      let amount = baseAmount + (remainder > 0 ? 1 : 0);
      if (remainder > 0) remainder--;
      
      const dueDate = new Date(firstDue);
      
      // Calculate next due date based on cycle
      switch(project.cycle) {
        case 'monthly':
          dueDate.setMonth(dueDate.getMonth() + i);
          break;
        case 'quarterly':
          dueDate.setMonth(dueDate.getMonth() + (i * 3));
          break;
        case 'bi_annual':
          dueDate.setMonth(dueDate.getMonth() + (i * 6));
          break;
        case 'annual':
          dueDate.setFullYear(dueDate.getFullYear() + i);
          break;
        default:
          dueDate.setMonth(dueDate.getMonth() + (i * 6)); // Default to bi-annual
      }
      
      project.installments.push({
        id: generateId('inst'),
        number: i + 1,
        amount: amount,
        dueDate: dueDate.toISOString().split('T')[0],
        paid: false,
        partialPaid: 0,
        paidOn: null,
        receiptId: null
      });
    }
    
    db.projects.push(project);
    
    // Update inventory status
    if (inventoryItem) {
      inventoryItem.status = 'sold';
      inventoryItem.customerId = project.customerId;
      inventoryItem.updatedAt = new Date().toISOString();
    } else {
      // Add to inventory if not already there
      db.inventory.push({
        id: generateId('inv'),
        projectName: projectName,
        unit: unit,
        unitType: 'shop', // default
        marlas: marlas,
        rate: rate,
        saleValue: saleValue,
        status: 'sold',
        customerId: project.customerId,
        notes: project.notes || '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });
    }
    
    saveToStorage();
    
    closeAddProjectModal();
    refreshSection('projects');
    refreshSection('inventory');
    
    showNotification('success', 'Project Created', 
      `${project.name} - ${project.unit} has been sold and added to projects.`);
    
    return true;
  } catch (error) {
    showNotification('error', 'Error', error.message);
    return false;
  }
}





function submitInteractionForm() {
  const form = document.getElementById('interactionForm');
  const formData = new FormData(form);
  
  try {
    console.log('Submitting interaction form...');
    
    // Validation
    const contactType = formData.get('contactType');
    const customerId = formData.get('customerId');
    const brokerId = formData.get('brokerId');
    
    console.log('Form data - Contact type:', contactType);
    console.log('Form data - Customer ID:', customerId);
    console.log('Form data - Broker ID:', brokerId);
    
    if (contactType === 'customer' && !customerId) {
      throw new Error('Please select a customer');
    }
    
    if (contactType === 'broker' && !brokerId) {
      throw new Error('Please select a broker');
    }
    
    const contactId = contactType === 'customer' ? customerId : brokerId;
    
    // Final check for DNC status (in case warning was ignored)
    const existingDoNotContact = db.interactions.find(i => 
      ((i.customerId === contactId) || (i.brokerId === contactId)) && 
      i.status === 'do_not_contact'
    );
    
    if (existingDoNotContact && formData.get('status') !== 'do_not_contact') {
      const contact = db.customers.find(c => c.id === contactId);
      if (!confirm(`‚ö†Ô∏è FINAL WARNING: ${contact?.name || 'This contact'} is on the DO NOT CONTACT list!\n\nProceed only if you have explicit authorization.\n\nClick OK to confirm and submit this interaction.`)) {
        return false;
      }
    }
    
    const interaction = {
      id: generateId('int'),
      contactType: contactType,
      customerId: contactType === 'customer' ? customerId : null,
      brokerId: contactType === 'broker' ? brokerId : null,
      type: formData.get('type'),
      status: formData.get('status'),
      priority: formData.get('priority') || 'medium',
      date: formData.get('date'),
      notes: formData.get('notes') || '',
      nextFollowUp: formData.get('nextFollowUp') || null,
      createdAt: new Date().toISOString()
    };
    
    console.log('Interaction object created:', interaction);
    
    db.interactions.push(interaction);
    saveToStorage();
    renderLeadsDashboard();
    
    closeAddInteractionModal();
    refreshSection('interactions');
    
    // Get contact name for notification
    const contact = db.customers.find(c => 
      c.id === (interaction.customerId || interaction.brokerId)
    );
    
    console.log('Contact found for notification:', contact);
    
    showNotification('success', 'Interaction Logged', 
      `Interaction logged with ${contact?.name || 'contact'}.`);
    
    return true;
  } catch (error) {
    console.error('Error in submitInteractionForm:', error);
    showNotification('error', 'Error', error.message);
    return false;
  }
}

function submitReceiptForm() {
  const form = document.getElementById('receiptForm');
  const formData = new FormData(form);
  
  try {
    // Validation
    if (!formData.get('customerId') || !formData.get('projectId') || !formData.get('amount')) {
      throw new Error('Customer, Project, and Amount are required');
    }
    
    const amount = parseFloat(formData.get('amount')) || 0;
    if (amount <= 0) {
      throw new Error('Amount must be greater than 0');
    }
    
    const projectId = formData.get('projectId');
    const project = db.projects.find(p => p.id === projectId);
    
    if (!project) {
      throw new Error('Project not found');
    }
    
    // Check if amount exceeds remaining balance
    const financials = calculateProjectFinancials(project);
    if (amount > financials.totalReceivable) {
      throw new Error(`Amount exceeds remaining balance of ${formatCurrency(financials.totalReceivable)}`);
    }
    
    const receipt = {
      id: generateId('rcpt'),
      customerId: formData.get('customerId'),
      projectId: projectId,
      installmentId: formData.get('installmentId') || null,
      amount: amount,
      date: formData.get('date'),
      method: formData.get('method'),
      reference: formData.get('ref') || '',
      notes: formData.get('notes') || '',
      createdAt: new Date().toISOString()
    };
    
    db.receipts.push(receipt);
    
    // Update project received amount
    project.received = (project.received || 0) + amount;
    project.updatedAt = new Date().toISOString();
    
    // Allocate to installment if specified
    const installmentId = formData.get('installmentId');
    if (installmentId) {
      const installment = project.installments.find(i => i.id === installmentId);
      if (installment) {
        installment.partialPaid = (installment.partialPaid || 0) + amount;
        if (installment.partialPaid >= installment.amount) {
          installment.paid = true;
          installment.paidOn = receipt.date;
          installment.receiptId = receipt.id;
        }
      }
    } else {
      // Auto-allocate to oldest due installments
      let remaining = amount;
      const sortedInstallments = project.installments
        .filter(i => !i.paid)
        .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
      
      for (const installment of sortedInstallments) {
        if (remaining <= 0) break;
        
        const dueAmount = installment.amount - (installment.partialPaid || 0);
        const toPay = Math.min(remaining, dueAmount);
        
        installment.partialPaid = (installment.partialPaid || 0) + toPay;
        remaining -= toPay;
        
        if (installment.partialPaid >= installment.amount) {
          installment.paid = true;
          installment.paidOn = receipt.date;
          installment.receiptId = receipt.id;
        }
      }
    }
    
    saveToStorage();
    
    closeAddReceiptModal();
    refreshSection('receipts');
    
    // Get customer name for notification
    const customer = db.customers.find(c => c.id === receipt.customerId);
    
    showNotification('success', 'Receipt Recorded', 
      `Payment of ${formatCurrency(amount)} recorded from ${customer?.name || 'customer'}.`);
    
    return true;
  } catch (error) {
    showNotification('error', 'Error', error.message);
    return false;
  }
}

// Delete Functions
function deleteCustomer(customerId) {
  if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
    return;
  }
  
  const customer = db.customers.find(c => c.id === customerId);
  if (!customer) return;
  
  // Check if customer has projects
  const customerProjects = db.projects.filter(p => p.customerId === customerId);
  if (customerProjects.length > 0) {
    if (!confirm(`This customer has ${customerProjects.length} project(s). Deleting will also remove these projects. Continue?`)) {
      return;
    }
    
    // Delete customer's projects
    db.projects = db.projects.filter(p => p.customerId !== customerId);
    
    // Delete receipts for these projects
    const projectIds = customerProjects.map(p => p.id);
    db.receipts = db.receipts.filter(r => !projectIds.includes(r.projectId));
  }
  
  // Delete customer
  db.customers = db.customers.filter(c => c.id !== customerId);
  
  // Delete interactions with this customer
  db.interactions = db.interactions.filter(i => 
    i.customerId !== customerId && i.brokerId !== customerId
  );
  
  saveToStorage();
  renderLeadsDashboard();
  refreshSection('customers');
  
  showNotification('success', 'Customer Deleted', 
    `${customer.name} has been deleted.`);
}

function deleteProject(projectId) {
  if (!confirm('Are you sure you want to delete this project? All associated receipts will also be deleted.')) {
    return;
  }
  
  const project = db.projects.find(p => p.id === projectId);
  if (!project) return;
  
  db.projects = db.projects.filter(p => p.id !== projectId);
  db.receipts = db.receipts.filter(r => r.projectId !== projectId);
  
  saveToStorage();
  refreshSection('projects');
  
  showNotification('success', 'Project Deleted', 
    `${project.name} - ${project.unit} has been deleted.`);
}

function deleteInteraction(interactionId) {
  if (!confirm('Are you sure you want to delete this interaction?')) {
    return;
  }
  
  db.interactions = db.interactions.filter(i => i.id !== interactionId);
  saveToStorage();
  renderLeadsDashboard();
  refreshSection('interactions');
  
  showNotification('success', 'Interaction Deleted', 
    'Interaction has been deleted.');
}

function deleteReceipt(receiptId) {
  if (!confirm('Are you sure you want to delete this receipt? This will adjust the project balance.')) {
    return;
  }
  
  const receipt = db.receipts.find(r => r.id === receiptId);
  if (!receipt) return;
  
  const project = db.projects.find(p => p.id === receipt.projectId);
  if (project) {
    // Adjust project received amount
    project.received = Math.max(0, (project.received || 0) - receipt.amount);
    project.updatedAt = new Date().toISOString();
    
    // Adjust installment allocation
    if (receipt.installmentId) {
      const installment = project.installments.find(i => i.id === receipt.installmentId);
      if (installment) {
        installment.partialPaid = Math.max(0, (installment.partialPaid || 0) - receipt.amount);
        if (installment.partialPaid < installment.amount) {
          installment.paid = false;
          installment.paidOn = null;
          installment.receiptId = null;
        }
      }
    }
  }
  
  db.receipts = db.receipts.filter(r => r.id !== receiptId);
  saveToStorage();
  refreshSection('receipts');
  
  showNotification('success', 'Receipt Deleted', 
    `Receipt #${receiptId.substring(0, 8)} has been deleted.`);
}



// Report Functions
function updateReports() {
  const financials = calculateOverallFinancials();
  
  document.getElementById('reportTotalSale').textContent = formatCurrency(financials.totalSale);
  document.getElementById('reportTotalReceived').textContent = formatCurrency(financials.totalReceived);
  document.getElementById('reportTotalReceivable').textContent = formatCurrency(financials.totalReceivable);
  document.getElementById('reportTotalOverdue').textContent = formatCurrency(financials.totalOverdue);
  document.getElementById('reportTotalFuture').textContent = formatCurrency(financials.totalFuture);
  
  // Populate select dropdowns
  populateReportSelects();
}

function populateReportSelects() {
  // Customer report select - include ALL customers
  const customers = db.customers.filter(c => 
    c.type === 'customer' || c.type === 'both'
  );
  
  document.getElementById('customerReportSelect').innerHTML = 
    '<option value="">Select Customer</option>' +
    customers.map(c => {
      const typeIcon = 'üë§ ';
      return `<option value="${c.id}">${typeIcon}${escapeHtml(c.name)} - ${escapeHtml(c.phone)}</option>`;
    }).join('');




  
  // Broker report select - only brokers and both
  const brokers = db.customers.filter(c => 
    c.type === 'broker' || c.type === 'both'
  );
  
  document.getElementById('brokerReportSelect').innerHTML = 
    '<option value="">Select Broker</option>' +
    brokers.map(b => {
      const typeIcon = 'ü§ù ';
      return `<option value="${b.id}">${typeIcon}${escapeHtml(b.name)} - ${escapeHtml(b.phone)}</option>`;
    }).join('');



  
  // Project report select
  document.getElementById('projectReportSelect').innerHTML = 
    '<option value="">Select Project</option>' +
    db.projects.map(p => {
      const customer = db.customers.find(c => c.id === p.customerId);
      return `<option value="${p.id}">üèó ${escapeHtml(p.name)} - ${escapeHtml(p.unit)} (${escapeHtml(customer?.name || 'Unknown')})</option>`;
    }).join('');
}







function debugCurrentData() {
  const customerId = document.getElementById('customerReportSelect').value;
  const brokerId = document.getElementById('brokerReportSelect').value;
  const projectId = document.getElementById('projectReportSelect').value;
  
  console.log('=== CURRENT SELECTIONS ===');
  console.log('Customer ID:', customerId);
  console.log('Broker ID:', brokerId);
  console.log('Project ID:', projectId);
  
  if (customerId) {
    debugProjectData(customerId);
  }
  
  // Show overall stats
  const overall = calculateOverallFinancials();
  console.log('Overall Financials:', overall);
  
  showNotification('info', 'Debug Complete', 'Check browser console for details.');
}







// Filter Functions
function filterCustomersTable() {
  currentPage.customers = 1;
  renderCustomersTable();
}

function filterProjectsTable() {
  currentPage.projects = 1;
  renderProjectsTable();
}

function filterInteractionsTable() {
  currentPage.interactions = 1;
  renderInteractionsTable();
}

function filterReceiptsTable() {
  currentPage.receipts = 1;
  renderReceiptsTable();
}

// Export Functions
function exportTable(tableId, fileName) {
  try {
    const table = document.getElementById(tableId);
    const ws = XLSX.utils.table_to_sheet(table);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Data');
    XLSX.writeFile(wb, `${fileName}_${getDateString()}.xlsx`);
    
    showNotification('success', 'Export Successful', 
      `${fileName} exported successfully.`);
  } catch (error) {
    showNotification('error', 'Export Failed', error.message);
  }
}

function exportAllData() {
  try {
    const dataStr = JSON.stringify(db, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `sitara_crm_backup_${getDateString()}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    showNotification('success', 'Backup Created', 
      'All data has been exported successfully.');
  } catch (error) {
    showNotification('error', 'Export Failed', error.message);
  }
}




// Helper function to estimate text height
function estimateTextHeight(text, maxWidth, fontSize = 8.5) {
  // Rough estimate: 3.5 units per line
  const avgCharsPerLine = maxWidth / (fontSize * 0.5);
  const lines = Math.ceil(text.length / avgCharsPerLine);
  return lines * 3.5;
}













function exportFinancialSummary() {
  try {
    const financials = calculateOverallFinancials();
    
    const data = [
      ['SITARA BUILDERS CRM - FINANCIAL SUMMARY', ''],
      ['Generated on', new Date().toLocaleDateString()],
      [''],
      ['Financial Overview', 'Amount (PKR)'],
      ['Total Sale Value', financials.totalSale],
      ['Total Received', financials.totalReceived],
      ['Total Receivable', financials.totalReceivable],
      ['Total Overdue', financials.totalOverdue],
      ['Future Receivable', financials.totalFuture],
      ['Percentage Paid', `${financials.percentagePaid.toFixed(1)}%`],
      [''],
      ['Summary Statistics', 'Count'],
      ['Total Customers', db.customers.length],
      ['Total Projects', db.projects.length],
      ['Total Brokers', db.customers.filter(c => c.type === 'broker' || c.type === 'both').length],
      ['Total Interactions', db.interactions.length],
      ['Total Receipts', db.receipts.length]
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Financial Summary');
    XLSX.writeFile(wb, `financial_summary_${getDateString()}.xlsx`);
    
    showNotification('success', 'Export Successful', 
      'Financial summary exported successfully.');
  } catch (error) {
    showNotification('error', 'Export Failed', error.message);
  }
}

function exportFollowUpReport() {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Title
    doc.setFontSize(16);
    doc.setTextColor(30, 58, 138);
    doc.text('SITARA BUILDERS CRM - FOLLOW-UP REPORT', 20, 20);
    
    doc.setFontSize(10);
    doc.setTextColor(100, 116, 139);
    doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 30);
    
    let yPos = 45;
    
    // Follow-up Interactions
    const followUpInteractions = db.interactions
      .filter(i => i.status === 'follow_up' && i.nextFollowUp)
      .sort((a, b) => new Date(a.nextFollowUp) - new Date(b.nextFollowUp));
    
    if (followUpInteractions.length === 0) {
      doc.setFontSize(12);
      doc.text('No pending follow-ups.', 20, yPos);
    } else {
      // Summary
      doc.setFontSize(12);
      doc.setTextColor(30, 41, 59);
      doc.text(`Total Follow-ups: ${followUpInteractions.length}`, 20, yPos);
      yPos += 10;
      
      // Table headers
      doc.setFontSize(10);
      doc.setTextColor(255, 255, 255);
      doc.setFillColor(59, 130, 246);
      doc.rect(20, yPos, 170, 8, 'F');
      doc.text('Contact', 22, yPos + 6);
      doc.text('Type', 70, yPos + 6);
      doc.text('Next Follow-up', 100, yPos + 6);
      doc.text('Priority', 140, yPos + 6);
      doc.text('Status', 170, yPos + 6);
      
      yPos += 12;
      
      // Table rows
      doc.setTextColor(30, 41, 59);
      followUpInteractions.forEach(interaction => {
        const contact = db.customers.find(c => 
          c.id === (interaction.customerId || interaction.brokerId)
        );
        
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        
        doc.setFontSize(9);
        doc.text(contact?.name || 'Unknown', 22, yPos);
        doc.text(interaction.type.replace('_', ' ').toUpperCase(), 70, yPos);
        doc.text(interaction.nextFollowUp, 100, yPos);
        doc.text(interaction.priority.toUpperCase(), 140, yPos);
        doc.text(interaction.status.replace('_', ' ').toUpperCase(), 170, yPos);
        
        yPos += 8;
        
        // Add notes if available
        if (interaction.notes) {
          const notes = doc.splitTextToSize(interaction.notes, 150);
          doc.setFontSize(8);
          doc.setTextColor(100, 116, 139);
          doc.text(notes, 22, yPos);
          yPos += notes.length * 4;
        }
        
        doc.setTextColor(30, 41, 59);
        yPos += 4;
      });
    }
    
    doc.save(`follow_up_report_${getDateString()}.pdf`);
    showNotification('success', 'Report Generated', 
      'Follow-up report exported successfully.');
  } catch (error) {
    showNotification('error', 'Export Failed', error.message);
  }
}

function exportOverdueReport() {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Title
    doc.setFontSize(16);
    doc.setTextColor(220, 38, 38);
    doc.text('SITARA BUILDERS CRM - OVERDUE PAYMENTS REPORT', 20, 20);
    
    doc.setFontSize(10);
    doc.setTextColor(100, 116, 139);
    doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 30);
    
    let yPos = 45;
    
    // Overdue installments
    let totalOverdue = 0;
    const overdueData = [];
    
    db.projects.forEach(project => {
      if (project.installments) {
        project.installments.forEach(installment => {
          if (!installment.paid && isOverdue(installment.dueDate)) {
            const customer = db.customers.find(c => c.id === project.customerId);
            const remaining = installment.amount - (installment.partialPaid || 0);
            totalOverdue += remaining;
            
            overdueData.push({
              customer: customer?.name || 'Unknown',
              project: project.name,
              unit: project.unit,
              installment: installment.number,
              dueDate: installment.dueDate,
              amount: formatCurrency(remaining),
              daysOverdue: calculateDaysBetween(installment.dueDate, new Date())
            });
          }
        });
      }
    });
    
    overdueData.sort((a, b) => b.daysOverdue - a.daysOverdue);
    
    if (overdueData.length === 0) {
      doc.setFontSize(12);
      doc.text('No overdue payments found.', 20, yPos);
    } else {
      // Summary
      doc.setFontSize(12);
      doc.setTextColor(30, 41, 59);
      doc.text(`Total Overdue: ${formatCurrency(totalOverdue)}`, 20, yPos);
      yPos += 10;
      
      // Table headers
      doc.setFontSize(10);
      doc.setTextColor(255, 255, 255);
      doc.setFillColor(220, 38, 38);
      doc.rect(20, yPos, 170, 8, 'F');
      doc.text('Customer', 22, yPos + 6);
      doc.text('Project', 70, yPos + 6);
      doc.text('Due Date', 110, yPos + 6);
      doc.text('Days', 140, yPos + 6);
      doc.text('Amount', 160, yPos + 6);
      
      yPos += 12;
      
      // Table rows
      doc.setTextColor(30, 41, 59);
      overdueData.forEach(item => {
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        
        doc.setFontSize(9);
        doc.text(item.customer.substring(0, 20), 22, yPos);
        doc.text(`${item.project} - ${item.unit}`, 70, yPos);
        doc.text(item.dueDate, 110, yPos);
        doc.text(item.daysOverdue.toString(), 140, yPos);
        doc.text(item.amount, 160, yPos);
        
        yPos += 8;
      });
    }
    
    doc.save(`overdue_report_${getDateString()}.pdf`);
    showNotification('success', 'Report Generated', 
      'Overdue payments report exported successfully.');
  } catch (error) {
    showNotification('error', 'Export Failed', error.message);
  }
}

// NEW CODE (fixed scoping - move to top with other utility functions):
// Move this function ABOVE the generateCustomerReportPDF function
function isOverdue(dateStr) {
  try {
    if (!dateStr) return false;
    const dueDate = new Date(dateStr);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    dueDate.setHours(0, 0, 0, 0);
    return dueDate < today;
  } catch (error) {
    console.error('Error in isOverdue:', error);
    return false;
  }
}






function generateCustomerReport() {
  const customerId = document.getElementById('customerReportSelect').value;
  if (!customerId) {
    showNotification('warning', 'Selection Required', 'Please select a customer.');
    return;
  }
  
  generateCustomerReportPDF(customerId);
}






function generateCustomerReportPDF(customerId) {
  try {
    const customer = db.customers.find(c => c.id === customerId);
    if (!customer) {
      showNotification('error', 'Error', 'Customer not found.');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // ===== IMPROVED STYLING WITH BETTER LAYOUT =====
    const colors = {
      primary: [26, 86, 219],
      secondary: [4, 120, 87],
      accent: [220, 38, 38],
      dark: [31, 41, 55],
      light: [249, 250, 251],
      border: [229, 231, 235],
      purple: [142, 68, 173],
      orange: [245, 158, 11]
    };
    
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    const margin = 20;
    const contentWidth = pageWidth - (2 * margin);
    const footerHeight = 25;
    const maxY = pageHeight - footerHeight; // Maximum Y before footer
    let yPos = 25;
    
    // Helper: Check if we need a new page
    function checkPageBreak(neededHeight = 10) {
      if (yPos + neededHeight > pageHeight - margin - 20) { // Reserve space for footer
        doc.addPage();
        yPos = 20;
        return true;
      }
      return false;
    }
    
    // Helper: Add section
    function addSection(title, bgColor = colors.primary) {
      checkPageBreak(20);
      
      doc.setFillColor(...bgColor);
      doc.rect(margin, yPos, contentWidth, 8, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.text(title, margin + 4, yPos + 5.5);
      doc.setTextColor(...colors.dark);
      doc.setFont(undefined, 'normal');
      yPos += 12;
    }
    
    // Helper: Add info row
    function addInfoRow(label, value, isBold = false) {
      checkPageBreak(7);
      
      doc.setFontSize(9);
      doc.setTextColor(100, 100, 100);
      doc.text(label, margin, yPos);
      doc.setTextColor(...colors.dark);
      doc.setFont(undefined, isBold ? 'bold' : 'normal');
      doc.setFontSize(isBold ? 10 : 9);
      
      // Truncate long values
      const maxWidth = contentWidth - 60;
      const valueStr = String(value);
      const truncated = doc.splitTextToSize(valueStr, maxWidth);
      
      if (truncated.length === 1) {
        doc.text(valueStr, margin + 60, yPos);
        yPos += 7;
      } else {
        doc.text(truncated[0], margin + 60, yPos);
        yPos += (truncated.length - 1) * 3 + 4;
      }
    }
    
    // ===== HEADER =====
    doc.setFillColor(...colors.primary);
    doc.rect(0, 0, pageWidth, 40, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text('SITARA BUILDERS CRM', margin, 20);
    doc.setFontSize(12);
    doc.text('CUSTOMER REPORT', margin, 28);
    doc.setFontSize(9);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, margin, 35);
    doc.setTextColor(...colors.dark);
    yPos = 50;
    
    // ===== CUSTOMER INFORMATION =====
    addSection('CUSTOMER INFORMATION');
    addInfoRow('Full Name:', customer.name || 'N/A', true);
    addInfoRow('CNIC:', customer.cnic || 'N/A');
    addInfoRow('Phone:', customer.phone || 'N/A');
    if (customer.email) addInfoRow('Email:', customer.email);
    if (customer.company) addInfoRow('Company:', customer.company);
    if (customer.address) addInfoRow('Address:', customer.address);
    addInfoRow('Type:', (customer.type || 'customer').toUpperCase());
    addInfoRow('Status:', (customer.status || 'active').toUpperCase());
    
    // Add divider
    checkPageBreak(15);
    doc.setDrawColor(...colors.border);
    doc.line(margin, yPos, pageWidth - margin, yPos);
    yPos += 10;
    
    // ===== COMMUNICATION HISTORY =====
    const interactions = db.interactions.filter(i => 
      i.customerId === customerId || i.brokerId === customerId
    ).sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10); // Limit to 10
    
    if (interactions.length > 0) {
      addSection('COMMUNICATION HISTORY', colors.purple);
      
      interactions.forEach((int, idx) => {
        checkPageBreak(25);
        
        const dateObj = new Date(int.date);
        const formattedDate = dateObj.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        // Draw interaction card
        doc.setDrawColor(...colors.border);
        doc.setLineWidth(0.5);
        doc.rect(margin, yPos - 5, contentWidth, 20, 'S');
        
        // Date and Type
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(...colors.primary);
        doc.text(`${formattedDate} - ${int.type.replace('_', ' ').toUpperCase()}`, margin + 5, yPos);
        
        // Status badge
        const status = int.status.replace('_', ' ').toUpperCase();
        doc.setTextColor(255, 255, 255);
        const statusColor = int.status === 'follow_up' ? colors.accent : 
                           int.status === 'resolved' ? colors.secondary : 
                           int.status === 'do_not_contact' ? colors.accent : colors.primary;
        doc.setFillColor(...statusColor);
        const statusWidth = doc.getStringUnitWidth(status) * 4.5;
        doc.rect(pageWidth - margin - statusWidth - 5, yPos - 3.5, statusWidth, 5, 'F');
        doc.setFontSize(8);
        doc.text(status, pageWidth - margin - statusWidth - 3, yPos);
        
        // Notes
        yPos += 7;
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(...colors.dark);
        
        const notes = int.notes || 'No notes';
        const noteLines = doc.splitTextToSize(notes, contentWidth - 10);
        
        if (noteLines.length > 1) {
          doc.rect(margin, yPos - 12, contentWidth, 10 + (noteLines.length * 4), 'S');
        }
        
        noteLines.forEach((line, lineIdx) => {
          doc.text(line, margin + 5, yPos + (lineIdx * 4));
        });
        
        yPos += Math.max(10, noteLines.length * 4) + 5;
      });
      
      checkPageBreak(10);
      doc.setDrawColor(...colors.border);
      doc.line(margin, yPos, pageWidth - margin, yPos);
      yPos += 10;
    }
    
    // ===== PROJECTS SUMMARY =====
    const customerMasterProjects = getCustomerMasterProjects(customerId);
    
    if (customerMasterProjects.length > 0) {
      addSection('PROJECTS SUMMARY');
      
      // Ensure we have space before starting table
      checkPageBreak(50);
      
      const headers = ['Project', 'Units', 'Sale', 'Received', 'Balance', 'Due'];
      const colWidths = [40, 15, 29, 29, 29, 27];
      
      // Table header
      doc.setFillColor(240, 242, 245);
      doc.rect(margin, yPos, contentWidth, 8, 'F');
      doc.setFontSize(9);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(70, 70, 70);
      
      let xPos = margin + 2;
  headers.forEach((header, idx) => {
    if (idx === 0) {
      // Left align "Project" header
      doc.text(header, xPos, yPos + 5);
    } else {
      // Right align numeric headers
      doc.text(header, xPos + colWidths[idx] - 4, yPos + 5, { align: 'right' });
    }
    xPos += colWidths[idx];
  });
      
      doc.setFont(undefined, 'normal');
      doc.setTextColor(...colors.dark);
      yPos += 10;
      
      let totalSale = 0;
      let totalReceived = 0;
      let totalBalance = 0;
      let totalDue = 0;
      
      // Table rows
      customerMasterProjects.forEach((master, idx) => {
        checkPageBreak(15);
        
        totalSale += master.totalSale;
        totalReceived += master.totalReceived;
        totalBalance += master.totalReceivable;
        totalDue += master.totalOverdue;
        
        if (idx % 2 === 1) {
          doc.setFillColor(248, 249, 250);
          doc.rect(margin, yPos - 1, contentWidth, 8, 'F');
        }
        
        xPos = margin + 2;
        doc.setFontSize(9);
        
        // Project name (truncated)
        const projName = master.name.length > 15 ? master.name.substring(0, 15) + '...' : master.name;
        doc.text(projName, xPos, yPos + 5);
        xPos += colWidths[0];
        
        // Units
        doc.text(master.units.length.toString(), xPos + colWidths[1] - 4, yPos + 5, { align: 'right' });
        xPos += colWidths[1];
        
        // Sale
        doc.text(formatCurrency(master.totalSale), xPos + colWidths[2] - 4, yPos + 5, { align: 'right' });
        xPos += colWidths[2];
        
        // Received
        doc.text(formatCurrency(master.totalReceived), xPos + colWidths[3] - 4, yPos + 5, { align: 'right' });
    xPos += colWidths[3];
    
    // Balance (right-aligned)
    doc.text(formatCurrency(master.totalReceivable), xPos + colWidths[4] - 4, yPos + 5, { align: 'right' });
    xPos += colWidths[4];
        
        // Due
        doc.text(formatCurrency(master.totalOverdue), xPos + colWidths[5] - 4, yPos + 5, { align: 'right' });
    
    yPos += 10;
  });
      
      // Add space before totals
      checkPageBreak(30);
      yPos += 5;




    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);
  doc.line(margin, yPos, margin + contentWidth, yPos);
  yPos += 8;
  
  // Totals row
  doc.setFont(undefined, 'bold');
  doc.setFillColor(245, 245, 245);
  doc.rect(margin, yPos - 1, contentWidth, 8, 'F');
  
  xPos = margin + 2;
  doc.text('TOTAL', xPos, yPos + 5);
  xPos += colWidths[0];
  
  doc.text(customerMasterProjects.reduce((sum, m) => sum + m.units.length, 0).toString(), 
           xPos + colWidths[1] - 4, yPos + 5, { align: 'right' });
  xPos += colWidths[1];
  
  doc.text(formatCurrency(totalSale), xPos + colWidths[2] - 4, yPos + 5, { align: 'right' });
  xPos += colWidths[2];
  
  doc.text(formatCurrency(totalReceived), xPos + colWidths[3] - 4, yPos + 5, { align: 'right' });
  xPos += colWidths[3];
  
  doc.text(formatCurrency(totalBalance), xPos + colWidths[4] - 4, yPos + 5, { align: 'right' });
  xPos += colWidths[4];
  
  doc.text(formatCurrency(totalDue), xPos + colWidths[5] - 4, yPos + 5, { align: 'right' });
  
  doc.setFont(undefined, 'normal');
  yPos += 15;
      


  doc.addPage();
  yPos = margin + 10;

      // ===== FINANCIAL TOTALS (SEPARATE SECTION) =====
      addSection('FINANCIAL TOTALS', colors.orange);
      
      // Totals in a clean layout
      doc.setFontSize(10);
      doc.setTextColor(...colors.dark);
      
      const totals = [
        ['Total Sale Value:', formatCurrency(totalSale), colors.primary],
        ['Total Received:', formatCurrency(totalReceived), colors.secondary],
        ['Total Balance:', formatCurrency(totalBalance), colors.orange],
        ['Amount Due Now:', formatCurrency(totalDue), colors.accent],
        ['Future Receivable:', formatCurrency(totalBalance - totalDue), [59, 130, 246]]
      ];
      
      totals.forEach(([label, value, color], idx) => {
        checkPageBreak(10);
        
        doc.setTextColor(100, 100, 100);
        doc.text(label, margin + 10, yPos + 3);
        doc.setTextColor(...color);
        doc.setFont(undefined, 'bold');
        doc.text(value, margin + 100, yPos + 3);
        doc.setFont(undefined, 'normal');
        
        yPos += 8;
      });
      
      // Add separator before installment schedule
      checkPageBreak(20);
      doc.setDrawColor(...colors.border);
      doc.setLineWidth(1);
      doc.line(margin, yPos, pageWidth - margin, yPos);
      yPos += 15;
    }
    
    // ===== INSTALLMENT SCHEDULE (SEPARATE SECTION) =====
    if (customerMasterProjects.length > 0) {
      // Force new page for installment schedule if needed
      if (yPos > pageHeight - 150) {
        doc.addPage();
        yPos = 20;
      }
      
      addSection('INSTALLMENT SCHEDULE', [100, 116, 139]);
      
      // Process each master project separately
      customerMasterProjects.forEach((master, masterIdx) => {
        const allInstallments = getMasterProjectInstallments(master);
        
        if (allInstallments.length === 0) return;
        
        // Master project header for installment schedule
        checkPageBreak(25);
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(...colors.primary);
        doc.text(`Project: ${master.name}`, margin, yPos);
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(100, 100, 100);
        doc.text(`${master.units.length} units, ${allInstallments.length} installments`, margin, yPos + 5);
        yPos += 12;
        
        // Installment table with proper column widths
        const instHeaders = ['Unit', '#', 'Due Date', 'Amount', 'Paid', 'Balance', 'Status'];
        const instCols = [25, 12, 25, 30, 30, 30, 20];
        
        // Table header
        doc.setFillColor(240, 242, 245);
        doc.rect(margin, yPos, contentWidth, 8, 'F');
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(70, 70, 70);
        
        let xPos = margin + 2;
        instHeaders.forEach((header, idx) => {
          doc.text(header, xPos, yPos + 5);
          xPos += instCols[idx];
        });
        
        doc.setFont(undefined, 'normal');
        doc.setTextColor(...colors.dark);
        yPos += 10;
        
        // Group installments by unit for better readability
        const installmentsByUnit = {};
        allInstallments.forEach(inst => {
          if (!installmentsByUnit[inst.unit]) {
            installmentsByUnit[inst.unit] = [];
          }
          installmentsByUnit[inst.unit].push(inst);
        });
        
        // Process each unit's installments
        Object.keys(installmentsByUnit).sort().forEach((unitName, unitIdx) => {
          const unitInstallments = installmentsByUnit[unitName].sort((a, b) => 
            new Date(a.dueDate) - new Date(b.dueDate)
          );
          
          unitInstallments.forEach((inst, instIdx) => {
            checkPageBreak(10);
            
            const rowIdx = (unitIdx * unitInstallments.length) + instIdx;
            if (rowIdx % 2 === 1) {
              doc.setFillColor(248, 249, 250);
              doc.rect(margin, yPos - 1, contentWidth, 8, 'F');
            }
            
            const remaining = inst.amount - (inst.partialPaid || 0);
            const overdue = isOverdue(inst.dueDate);
            const status = inst.paid ? 'Paid' : 
                         (inst.partialPaid > 0 ? 'Partial' : 
                         (overdue ? 'Overdue' : 'Pending'));
            
            xPos = margin + 2;
            doc.setFontSize(8.5);
            
            // Unit (only show for first installment in unit)
            if (instIdx === 0) {
              doc.text(unitName, xPos, yPos + 5);
            }
            xPos += instCols[0];
            
            // Installment number
            doc.text(`#${inst.number}`, xPos, yPos + 5);
            xPos += instCols[1];
            
            // Due Date
            doc.text(inst.dueDate, xPos, yPos + 5);
            xPos += instCols[2];
            
            // Amount
            doc.text(formatCurrency(inst.amount), xPos, yPos + 5);
            xPos += instCols[3];
            
            // Paid
            doc.text(formatCurrency(inst.partialPaid || 0), xPos, yPos + 5);
            xPos += instCols[4];
            
            // Balance
            doc.text(formatCurrency(remaining), xPos, yPos + 5);
            xPos += instCols[5];
            
            // Status with color
            const statusColor = status === 'Paid' ? colors.secondary : 
                              status === 'Partial' ? colors.orange : 
                              status === 'Overdue' ? colors.accent : colors.primary;
            doc.setTextColor(...statusColor);
            doc.text(status, xPos, yPos + 5);
            doc.setTextColor(...colors.dark);
            
            yPos += 10;
          });
          
          // Add small space between units
          if (unitIdx < Object.keys(installmentsByUnit).length - 1) {
            yPos += 5;
          }
        });
        
        // Add space between master projects
        if (masterIdx < customerMasterProjects.length - 1) {
          checkPageBreak(15);
          doc.setDrawColor(...colors.border);
          doc.setLineWidth(0.5);
          doc.line(margin, yPos, pageWidth - margin, yPos);
          yPos += 10;
        }
      });
    }
    
    // ===== FOOTER ON EVERY PAGE =====
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      
      // Footer background
      doc.setFillColor(...colors.light);
      doc.rect(0, pageHeight - 20, pageWidth, 20, 'F');
      
      // Footer text
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text(`Sitara Builders Recovery CRM ‚Ä¢ Page ${i} of ${pageCount}`, margin, pageHeight - 12);
      doc.text(`Customer: ${customer.name}`, pageWidth - margin, pageHeight - 12, { align: 'right' });
      
      // Add border to footer
      doc.setDrawColor(...colors.border);
      doc.setLineWidth(0.5);
      doc.line(margin, pageHeight - 20, pageWidth - margin, pageHeight - 20);
    }
    
    // Save PDF
    doc.save(`customer_report_${customer.name.replace(/\s+/g, '_')}_${getDateString()}.pdf`);
    
    showNotification('success', 'Report Generated', 
      `Customer report for ${customer.name} has been generated.`);
  } catch (error) {
    console.error('Error generating customer report:', error);
    showNotification('error', 'Error', error.message);
  }
}




function generateBrokerReport() {
  const brokerId = document.getElementById('brokerReportSelect').value;
  if (!brokerId) {
    showNotification('warning', 'Selection Required', 'Please select a broker.');
    return;
  }
  
  generateBrokerReportPDF(brokerId);
}

function generateBrokerReportPDF(brokerId) {
  try {
    console.log('Starting broker report generation for ID:', brokerId);
    
    const broker = db.customers.find(c => c.id === brokerId);
    if (!broker) {
      console.error('Broker not found:', brokerId);
      showNotification('error', 'Error', 'Broker not found.');
      return;
    }

    console.log('Broker found:', broker.name);
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    // ===== DIMENSIONS & SETTINGS =====
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;
    const margin = 15;
    const contentWidth = pageWidth - (2 * margin);
    let yPos = 20;
    let currentPage = 1;
    
    // ===== COLORS =====
    const colors = {
      primary: [26, 86, 219],
      secondary: [4, 120, 87],
      accent: [220, 38, 38],
      dark: [31, 41, 55],
      light: [249, 250, 251],
      border: [200, 200, 200],
      purple: [142, 68, 173],
      gold: [245, 158, 11],
      teal: [13, 148, 136]
    };
    
    // ===== HELPER FUNCTIONS =====
    function addNewPage() {
      doc.addPage();
      currentPage++;
      yPos = 20;
      addFooter();
    }
    
    function checkSpace(neededHeight) {
      if (yPos + neededHeight > pageHeight - 20) {
        addNewPage();
        return true;
      }
      return false;
    }
    
    function addFooter() {
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text(`Page ${currentPage}`, margin, pageHeight - 10);
      doc.text(`Broker: ${broker.name}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
      doc.text('CONFIDENTIAL', pageWidth - margin, pageHeight - 10, { align: 'right' });
    }
    
    function addSectionHeader(title, bgColor = colors.primary) {
      checkSpace(15);
      
      doc.setFillColor(...bgColor);
      doc.rect(margin, yPos, contentWidth, 6, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.text(title, margin + 2, yPos + 4);
      doc.setTextColor(...colors.dark);
      doc.setFont('helvetica', 'normal');
      yPos += 8;
    }
    
    function addKeyValue(label, value, x = margin, labelWidth = 40) {
      checkSpace(6);
      
      doc.setFontSize(9);
      doc.setTextColor(100, 100, 100);
      doc.text(label, x, yPos);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...colors.dark);
      
      // Ensure value fits
      const maxValueWidth = contentWidth - labelWidth - 10;
      const valueLines = doc.splitTextToSize(String(value), maxValueWidth);
      
      if (valueLines.length === 1) {
        doc.text(value, x + labelWidth, yPos);
        yPos += 6;
      } else {
        doc.text(valueLines[0], x + labelWidth, yPos);
        yPos += 4;
        for (let i = 1; i < valueLines.length; i++) {
          doc.text(valueLines[i], x + labelWidth, yPos);
          yPos += 4;
        }
        yPos += 2;
      }
      doc.setFont('helvetica', 'normal');
    }
    
    // ===== HEADER =====
    try {
      // Company Header
      doc.setFillColor(...colors.primary);
      doc.rect(0, 0, pageWidth, 25, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('SITARA BUILDERS', pageWidth / 2, 10, { align: 'center' });
      
      doc.setFontSize(11);
      doc.text('ENTERPRISE RECOVERY CRM', pageWidth / 2, 16, { align: 'center' });
      
      // Report Title
      doc.setFontSize(14);
      doc.text('BROKER PERFORMANCE REPORT', pageWidth / 2, 22, { align: 'center' });
      
      // Report Details
      doc.setFontSize(8);
      doc.setTextColor(200, 200, 200);
      doc.text(`Generated: ${new Date().toLocaleDateString()}`, margin, 33);
      doc.text(`Broker: ${broker.name}`, pageWidth - margin, 33, { align: 'right' });
      
      doc.setTextColor(...colors.dark);
      yPos = 40;
    } catch (headerError) {
      console.error('Header error:', headerError);
      yPos = 30;
    }
    
    // ===== BROKER PROFILE =====
    addSectionHeader('BROKER PROFILE', colors.purple);
    
    const profileData = [
      ['Full Name:', broker.name || 'N/A'],
      ['Contact:', broker.phone || 'N/A'],
      ['CNIC:', broker.cnic || 'N/A'],
      ['Email:', broker.email || 'N/A'],
      ['Company:', broker.company || 'N/A'],
      ['Status:', (broker.status || 'active').toUpperCase()]
    ];
    
    // Two-column layout for profile
    const colWidth = contentWidth / 2;
    profileData.forEach(([label, value], idx) => {
      const col = idx % 2;
      const row = Math.floor(idx / 2);
      const x = margin + (col * colWidth);
      
      addKeyValue(label, value, x, 30);
      
      // Reset yPos for next row
      if (col === 1 && row < Math.floor(profileData.length / 2)) {
        yPos -= 6;
      }
    });
    
    // Ensure yPos is at the end of profile section
    yPos += 10;
    
    // ===== FINANCIAL OVERVIEW =====
    addSectionHeader('FINANCIAL OVERVIEW', colors.gold);
    
    const brokeredProjects = db.projects.filter(p => p.brokerId === brokerId);
    
    // Calculate totals
    let totalSale = 0;
    let totalReceived = 0;
    let totalOutstanding = 0;
    let totalCurrentDue = 0;
    
    brokeredProjects.forEach(project => {
      const financials = calculateProjectFinancials(project);
      totalSale += financials.totalSale;
      totalReceived += financials.totalReceived;
      totalOutstanding += financials.totalReceivable;
      
      // Calculate current due (overdue installments)
      if (project.installments) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        project.installments.forEach(inst => {
          if (!inst.paid) {
            const dueDate = new Date(inst.dueDate);
            dueDate.setHours(0, 0, 0, 0);
            if (dueDate <= today) {
              const remaining = inst.amount - (inst.partialPaid || 0);
              totalCurrentDue += remaining;
            }
          }
        });
      }
    });
    
    const financialData = [
      ['Total Brokered Value:', formatCurrency(totalSale)],
      ['Total Received:', formatCurrency(totalReceived)],
      ['Total Outstanding:', formatCurrency(totalOutstanding)],
      ['Total Current Due:', formatCurrency(totalCurrentDue)]
    ];
    
    // Simple vertical list for financial data
    financialData.forEach(([label, value], idx) => {
      addKeyValue(label, value, margin, 50);
    });
    
    yPos += 10;
    
    // ===== DEAL BREAKDOWN =====
    if (brokeredProjects.length > 0) {
      addSectionHeader(`DEAL BREAKDOWN (${brokeredProjects.length} Projects)`, colors.teal);
      
      // SIMPLIFIED TABLE - Only essential columns that fit
      checkSpace(20);
      
      // Table header - SIMPLIFIED VERSION
      doc.setFillColor(240, 240, 240);
      doc.rect(margin, yPos, contentWidth, 6, 'F');
      
      doc.setFontSize(8);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(70, 70, 70);
      
      // Simplified columns that will fit
      const colPositions = {
        project: margin + 2,
        customer: margin + 50,
        sale: margin + 100,
        due: margin + 150
      };
      
      doc.text('Project', colPositions.project, yPos + 4);
      doc.text('Customer', colPositions.customer, yPos + 4);
      doc.text('Sale', colPositions.sale, yPos + 4);
      doc.text('Due', colPositions.due, yPos + 4);
      
      yPos += 8;
      
      // Table rows
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      
      brokeredProjects.forEach((project, idx) => {
        checkSpace(10);
        
        const customer = db.customers.find(c => c.id === project.customerId);
        const financials = calculateProjectFinancials(project);
        
        // Calculate current due for this project
        let projectCurrentDue = 0;
        if (project.installments) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          project.installments.forEach(inst => {
            if (!inst.paid) {
              const dueDate = new Date(inst.dueDate);
              dueDate.setHours(0, 0, 0, 0);
              if (dueDate <= today) {
                const remaining = inst.amount - (inst.partialPaid || 0);
                projectCurrentDue += remaining;
              }
            }
          });
        }
        
        // Alternate row background
        if (idx % 2 === 0) {
          doc.setFillColor(250, 250, 250);
          doc.rect(margin, yPos - 1, contentWidth, 8, 'F');
        }
        
        // Project name (truncated)
        let projectName = (project.name || 'Unnamed');
        if (projectName.length > 15) {
          projectName = projectName.substring(0, 15) + '...';
        }
        
        // Customer name (truncated)
        let customerName = (customer?.name || 'Unknown');
        if (customerName.length > 12) {
          customerName = customerName.substring(0, 12) + '...';
        }
        
        doc.setTextColor(...colors.dark);
        doc.text(projectName, colPositions.project, yPos + 5);
        doc.text(customerName, colPositions.customer, yPos + 5);
        doc.text(formatCurrency(financials.totalSale), colPositions.sale, yPos + 5);
        
        // Current due in red if > 0
        if (projectCurrentDue > 0) {
          doc.setTextColor(...colors.accent);
        }
        doc.text(formatCurrency(projectCurrentDue), colPositions.due, yPos + 5);
        
        yPos += 8;
      });
      
      // Totals row
      checkSpace(15);
      doc.setDrawColor(...colors.border);
      doc.setLineWidth(0.5);
      doc.line(margin, yPos, pageWidth - margin, yPos);
      yPos += 5;
      
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(9);
      doc.setTextColor(...colors.dark);
      
      doc.text('TOTALS:', colPositions.project, yPos + 5);
      doc.text(formatCurrency(totalSale), colPositions.sale, yPos + 5);
      
      // Total current due in red
      doc.setTextColor(...colors.accent);
      doc.text(formatCurrency(totalCurrentDue), colPositions.due, yPos + 5);
      
      yPos += 12;
    }
    
    // ===== OVERDUE INSTALLMENT DETAILS =====
    const projectsWithOverdue = brokeredProjects.filter(project => {
      if (!project.installments) return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      return project.installments.some(inst => {
        if (inst.paid) return false;
        const dueDate = new Date(inst.dueDate);
        dueDate.setHours(0, 0, 0, 0);
        return dueDate <= today;
      });
    });
    
    if (projectsWithOverdue.length > 0) {
      addSectionHeader('OVERDUE INSTALLMENTS', colors.accent);
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      projectsWithOverdue.forEach((project, projIdx) => {
        checkSpace(25);
        
        const customer = db.customers.find(c => c.id === project.customerId);
        
        // Project header
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...colors.dark);
        
        const projectTitle = `${project.name} - ${project.unit}`;
        const projectTitleLines = doc.splitTextToSize(projectTitle, contentWidth - 10);
        
        projectTitleLines.forEach((line, lineIdx) => {
          doc.text(line, margin, yPos + (lineIdx * 4));
        });
        yPos += (projectTitleLines.length * 4) + 2;
        
        if (customer) {
          doc.setFontSize(8);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(100, 100, 100);
          doc.text(`Customer: ${customer.name}`, margin, yPos);
          yPos += 5;
        }
        
        // Overdue installments
        const overdueInstallments = project.installments ? 
          project.installments.filter(inst => {
            if (inst.paid) return false;
            const dueDate = new Date(inst.dueDate);
            dueDate.setHours(0, 0, 0, 0);
            return dueDate <= today;
          }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)) : [];
        
        if (overdueInstallments.length > 0) {
          // Simple table for overdue installments
          const instColPositions = {
            number: margin + 5,
            dueDate: margin + 20,
            amount: margin + 60,
            paid: margin + 100,
            due: margin + 140
          };
          
          // Table header
          doc.setFillColor(255, 230, 230);
          doc.rect(margin, yPos, contentWidth, 5, 'F');
          
          doc.setFontSize(7);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(150, 50, 50);
          
          doc.text('#', instColPositions.number, yPos + 3.5);
          doc.text('Due Date', instColPositions.dueDate, yPos + 3.5);
          doc.text('Amount', instColPositions.amount, yPos + 3.5);
          doc.text('Paid', instColPositions.paid, yPos + 3.5);
          doc.text('Due', instColPositions.due, yPos + 3.5);
          
          yPos += 6;
          
          // Table rows
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(...colors.dark);
          
          let projectTotalDue = 0;
          
          overdueInstallments.forEach((inst, idx) => {
            checkSpace(8);
            
            if (idx % 2 === 0) {
              doc.setFillColor(255, 245, 245);
              doc.rect(margin, yPos - 1, contentWidth, 5, 'F');
            }
            
            const remaining = inst.amount - (inst.partialPaid || 0);
            projectTotalDue += remaining;
            const daysLate = Math.floor((today - new Date(inst.dueDate)) / (1000 * 60 * 60 * 24));
            
            doc.setFontSize(7);
            doc.text(`#${inst.number}`, instColPositions.number, yPos + 3.5);
            doc.text(inst.dueDate, instColPositions.dueDate, yPos + 3.5);
            doc.text(formatCurrency(inst.amount), instColPositions.amount, yPos + 3.5);
            doc.text(formatCurrency(inst.partialPaid || 0), instColPositions.paid, yPos + 3.5);
            doc.text(formatCurrency(remaining), instColPositions.due, yPos + 3.5);
            
            // Add days late in smaller text
            doc.setFontSize(6);
            doc.setTextColor(150, 150, 150);
            doc.text(`${daysLate} days`, instColPositions.due + 25, yPos + 3.5);
            doc.setTextColor(...colors.dark);
            
            yPos += 6;
          });
          
          // Project total
          checkSpace(8);
          doc.setFontSize(8);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(...colors.accent);
          doc.text(`Project Total Current Due: ${formatCurrency(projectTotalDue)}`, 
                  margin + 5, yPos + 3.5);
          
          yPos += 10;
        }
        
        // Add separator between projects
        if (projIdx < projectsWithOverdue.length - 1) {
          checkSpace(10);
          doc.setDrawColor(...colors.border);
          doc.setLineWidth(0.3);
          doc.line(margin, yPos, pageWidth - margin, yPos);
          yPos += 5;
        }
      });
    }
    
    // ===== COMMUNICATION HISTORY =====
    try {
      const brokerInteractions = db.interactions
        .filter(i => i.brokerId === brokerId)
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 3); // Only 3 most recent
      
      if (brokerInteractions.length > 0) {
        addSectionHeader('RECENT COMMUNICATIONS', colors.primary);
        
        brokerInteractions.forEach((interaction, idx) => {
          checkSpace(25);
          
          const date = new Date(interaction.date);
          const formattedDate = date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          // Interaction box
          doc.setDrawColor(...colors.border);
          doc.setLineWidth(0.5);
          doc.rect(margin, yPos, contentWidth, 20, 'S');
          
          // Date and Type
          doc.setFontSize(9);
          doc.setFont('helvetica', 'bold');
          doc.setTextColor(...colors.primary);
          doc.text(`${formattedDate} - ${interaction.type.toUpperCase()}`, margin + 5, yPos + 6);
          
          // Status
          const status = interaction.status.toUpperCase();
          doc.setFontSize(8);
          const statusColor = interaction.status === 'follow_up' ? colors.accent : 
                            interaction.status === 'resolved' ? colors.secondary : colors.primary;
          doc.setFillColor(...statusColor);
          doc.setTextColor(255, 255, 255);
          const statusWidth = doc.getTextWidth(status) + 4;
          doc.rect(margin + contentWidth - statusWidth - 5, yPos + 2, statusWidth, 4, 'F');
          doc.text(status, margin + contentWidth - statusWidth - 3, yPos + 4.5);
          
          // Notes
          yPos += 10;
          doc.setFontSize(8);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(...colors.dark);
          
          const notes = interaction.notes || 'No notes';
          const noteLines = doc.splitTextToSize(notes, contentWidth - 10);
          
          noteLines.forEach((line, lineIdx) => {
            doc.text(line, margin + 5, yPos + (lineIdx * 4));
          });
          
          yPos += Math.max(8, noteLines.length * 4) + 5;
        });
      }
    } catch (commsError) {
      console.error('Communications section error:', commsError);
    }
    
    // ===== FINAL FOOTER =====
    addFooter();
    
    // ===== SAVE PDF =====
    try {
      const dateStr = getDateString();
      const brokerNameSafe = broker.name ? 
        broker.name.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20) : 'broker';
      const filename = `broker_report_${brokerNameSafe}_${dateStr}.pdf`;
      
      console.log('Saving PDF as:', filename);
      doc.save(filename);
      
      showNotification('success', 'Report Generated', 
        `Broker report for ${broker.name} has been generated.`);
    } catch (saveError) {
      console.error('Save error:', saveError);
      showNotification('error', 'Save Error', 'Could not save the PDF file.');
    }
    
  } catch (error) {
    console.error('Fatal error generating broker report:', error);
    console.error('Error stack:', error.stack);
    showNotification('error', 'Fatal Error', 
      'Failed to generate broker report. Check browser console for details.');
  }
}







function generateProjectReport() {
  const projectId = document.getElementById('projectReportSelect').value;
  if (!projectId) {
    showNotification('warning', 'Selection Required', 'Please select a project.');
    return;
  }
  
  generateProjectReportPDF(projectId);
}

function generateProjectReportPDF(projectId) {
  try {
    const project = db.projects.find(p => p.id === projectId);
    if (!project) {
      showNotification('error', 'Error', 'Project not found.');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // ===== IMPROVED STYLING =====
    const colors = {
      primary: [26, 86, 219],
      secondary: [4, 120, 87],
      accent: [220, 38, 38],
      dark: [31, 41, 55],
      light: [249, 250, 251],
      border: [229, 231, 235],
      orange: [245, 158, 11] // For project-specific sections
    };
    
    const pageWidth = doc.internal.pageSize.width;
    const margin = 20;
    const contentWidth = pageWidth - (2 * margin);
    let yPos = 25;
    
    // Helper functions
    function addSection(title, bgColor = colors.orange) {
      if (yPos > 260) {
        doc.addPage();
        yPos = 20;
      }
      
      doc.setFillColor(...bgColor);
      doc.rect(margin, yPos, contentWidth, 8, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.text(title, margin + 4, yPos + 5.5);
      doc.setTextColor(...colors.dark);
      doc.setFont(undefined, 'normal');
      yPos += 12;
    }
    
    function addInfoRow(label, value, isBold = false) {
      if (yPos > 280) {
        doc.addPage();
        yPos = 20;
      }
      
      doc.setFontSize(9);
      doc.setTextColor(100, 100, 100);
      doc.text(label, margin, yPos);
      doc.setTextColor(...colors.dark);
      doc.setFont(undefined, isBold ? 'bold' : 'normal');
      doc.setFontSize(isBold ? 10 : 9);
      doc.text(String(value), margin + 60, yPos);
      yPos += 7;
    }
    
    // ===== HEADER =====
    doc.setFillColor(...colors.orange);
    doc.rect(0, 0, pageWidth, 40, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text('SITARA BUILDERS CRM', margin, 20);
    doc.setFontSize(12);
    doc.text('PROJECT REPORT', margin, 28);
    doc.setFontSize(9);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, margin, 35);
    doc.setTextColor(...colors.dark);
    yPos = 50;
    
    // ===== PROJECT INFORMATION =====
    const customer = db.customers.find(c => c.id === project.customerId);
    const broker = project.brokerId ? db.customers.find(c => c.id === project.brokerId) : null;
    const financials = calculateProjectFinancials(project);
    
    addSection('PROJECT INFORMATION');
    addInfoRow('Project Name:', project.name || 'N/A', true);
    addInfoRow('Unit/Shop #:', project.unit || 'N/A');
    addInfoRow('Customer:', customer?.name || 'Unknown');
    if (broker) addInfoRow('Broker:', broker.name);
    addInfoRow('Marlas:', project.marlas || 'N/A');
    addInfoRow('Rate per Marla:', formatCurrency(project.rate) || 'N/A');
    addInfoRow('Payment Cycle:', (project.cycle || 'bi_annual').replace('_', ' ').toUpperCase());
    addInfoRow('Status:', (project.status || 'active').toUpperCase());
    addInfoRow('Created:', formatDate(project.createdAt) || 'N/A');
    
    yPos += 10;
    
    // ===== FINANCIAL SUMMARY =====
    addSection('FINANCIAL SUMMARY');
    
    // Financial boxes
    const boxWidth = (contentWidth - 20) / 4;
    const boxes = [
      { label: 'Total Sale', value: formatCurrency(financials.totalSale), color: colors.primary },
      { label: 'Total Received', value: formatCurrency(financials.totalReceived), color: colors.secondary },
      { label: 'Total Balance', value: formatCurrency(financials.totalReceivable), color: colors.orange },
      { label: 'Total Overdue', value: formatCurrency(financials.totalOverdue), color: colors.accent }
    ];
    
    boxes.forEach((box, idx) => {
      const x = margin + (idx % 4) * (boxWidth + 10);
      
      const lighterColor = [
        Math.min(255, box.color[0] + 100),
        Math.min(255, box.color[1] + 100),
        Math.min(255, box.color[2] + 100)
      ];
      doc.setFillColor(...lighterColor);
      doc.rect(x, yPos, boxWidth, 20, 'F');
      
      doc.setDrawColor(...box.color);
      doc.rect(x, yPos, boxWidth, 20);
      
      doc.setFontSize(8);
      doc.setTextColor(100, 100, 100);
      doc.text(box.label, x + 5, yPos + 8);
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(...box.color);
      const valueLines = doc.splitTextToSize(box.value, boxWidth - 10);
      doc.text(valueLines, x + 5, yPos + 15);
    });
    
    yPos += 30;
    
    // Additional financial info
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    doc.text(`Percentage Paid: ${financials.percentagePaid.toFixed(1)}%`, margin, yPos);
    yPos += 7;
    doc.text(`Future Receivable: ${formatCurrency(financials.totalFuture)}`, margin, yPos);
    yPos += 10;
    
    // ===== INSTALLMENT SCHEDULE =====
    if (project.installments && project.installments.length > 0) {
      addSection('INSTALLMENT SCHEDULE', [100, 116, 139]);
      
      // Table headers
      doc.setFillColor(240, 242, 245);
      doc.rect(margin, yPos - 1.5, contentWidth, 7, 'F');
      doc.setFontSize(8.5);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(70, 70, 70);
      
      const headers = ['#', 'Due Date', 'Amount', 'Paid', 'Remaining', 'Status'];
      const colWidths = [15, 30, 35, 35, 35, 30];
      let xPos = margin + 2;
      
      headers.forEach((header, idx) => {
        doc.text(header, xPos, yPos + 3.5);
        xPos += colWidths[idx];
      });
      
      doc.setFont(undefined, 'normal');
      doc.setTextColor(...colors.dark);
      yPos += 9;
      
      // Table rows
      project.installments.forEach((inst, idx) => {
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        
        const remaining = inst.amount - (inst.partialPaid || 0);
        const overdue = isOverdue(inst.dueDate);
        const status = inst.paid ? 'Paid' : 
                     (inst.partialPaid > 0 ? 'Partial' : 
                     (overdue ? 'Overdue' : 'Pending'));
        
        const statusColor = inst.paid ? colors.secondary : 
                          (inst.partialPaid > 0 ? colors.orange : 
                          (overdue ? colors.accent : colors.primary));
        
        if (idx % 2 === 1) {
          doc.setFillColor(248, 249, 250);
          doc.rect(margin, yPos - 1.5, contentWidth, 7, 'F');
        }
        
        doc.setFontSize(8.5);
        xPos = margin + 2;
        
        // Number
        doc.text(String(inst.number), xPos, yPos + 3);
        xPos += colWidths[0];
        
        // Due Date
        doc.text(inst.dueDate || '-', xPos, yPos + 3);
        xPos += colWidths[1];
        
        // Amount
        doc.text(formatCurrency(inst.amount), xPos, yPos + 3);
        xPos += colWidths[2];
        
        // Paid
        doc.text(formatCurrency(inst.partialPaid || 0), xPos, yPos + 3);
        xPos += colWidths[3];
        
        // Remaining
        doc.text(formatCurrency(remaining), xPos, yPos + 3);
        xPos += colWidths[4];
        
        // Status
        doc.setTextColor(...statusColor);
        doc.text(status, xPos, yPos + 3);
        doc.setTextColor(...colors.dark);
        
        yPos += 7;
      });
      
      // Installment summary
      yPos += 5;
      doc.setFontSize(9);
      doc.setTextColor(100, 100, 100);
      
      const totalInstallments = project.installments.length;
      const paidInstallments = project.installments.filter(i => i.paid).length;
      const partialInstallments = project.installments.filter(i => !i.paid && (i.partialPaid || 0) > 0).length;
      const overdueInstallments = project.installments.filter(i => {
        if (i.paid) return false;
        return isOverdue(i.dueDate);
      }).length;
      
      doc.text(`Installment Summary:`, margin, yPos);
      yPos += 7;
      doc.text(`Total: ${totalInstallments} ‚Ä¢ Paid: ${paidInstallments} ‚Ä¢ Partial: ${partialInstallments} ‚Ä¢ Overdue: ${overdueInstallments}`, margin + 10, yPos);
    }
    
    // ===== FOOTER =====
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text(`Sitara Builders Recovery CRM ‚Ä¢ Page ${i} of ${pageCount}`, margin, 285);
      doc.text(`Project: ${project.name}`, pageWidth - margin - 60, 285, { align: 'right' });
    }
    
    doc.save(`project_report_${project.name.replace(/\s+/g, '_')}_${getDateString()}.pdf`);
    
    showNotification('success', 'Report Generated', 
      `Project report for ${project.name} has been generated.`);
  } catch (error) {
    showNotification('error', 'Error', error.message);
  }
}




// Debug function to check project data
function debugProjectData(customerId) {
  console.log('=== DEBUG: Project Data Analysis ===');
  
  const customer = db.customers.find(c => c.id === customerId);
  console.log('Customer:', customer?.name);
  
  const customerProjects = db.projects.filter(p => p.customerId === customerId);
  console.log('Total projects found:', customerProjects.length);
  
  customerProjects.forEach((project, idx) => {
    console.log(`Project ${idx + 1}:`, {
      name: project.name,
      unit: project.unit,
      sale: project.sale,
      received: project.received,
      installments: project.installments?.length || 0
    });
    
    if (project.installments) {
      project.installments.forEach((inst, i) => {
        console.log(`  Installment ${i + 1}:`, {
          amount: inst.amount,
          partialPaid: inst.partialPaid,
          paid: inst.paid,
          dueDate: inst.dueDate
        });
      });
    }
  });
  
  const masterProjects = getCustomerMasterProjects(customerId);
  console.log('Master Projects:', masterProjects);
  
  masterProjects.forEach((master, idx) => {
    console.log(`Master Project ${idx + 1}:`, {
      name: master.name,
      units: master.units.length,
      totalSale: master.totalSale,
      totalReceived: master.totalReceived
    });
  });
}









function generateConsolidatedReport() {
  const reportType = document.getElementById('consolidatedReportType').value;
  generateConsolidatedReportPDF(reportType);
}

function generateConsolidatedReportPDF(reportType) {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Title
    doc.setFontSize(18);
    doc.setTextColor(30, 58, 138);
    doc.text('SITARA BUILDERS CRM', 20, 20);
    
    const reportTitle = reportType === 'overdue' ? 'OVERDUE REPORT' :
                       reportType === 'follow_up' ? 'FOLLOW-UP REPORT' :
                       reportType === 'receivables' ? 'RECEIVABLES REPORT' :
                       'CONSOLIDATED REPORT';
    
    doc.setFontSize(14);
    doc.text(reportTitle.toUpperCase(), 20, 30);
    
    doc.setFontSize(10);
    doc.setTextColor(100, 116, 139);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 40);
    doc.text(`Report Type: ${reportType.replace('_', ' ').toUpperCase()}`, 150, 40);
    
    let yPos = 55;
    
    // Overall Financial Summary
    const financials = calculateOverallFinancials();
    
    doc.setFontSize(12);
    doc.setTextColor(30, 41, 59);
    doc.text('OVERALL FINANCIAL SUMMARY', 20, yPos);
    yPos += 10;
    
    doc.setFontSize(10);
    const tableData = [
      ['Total Sale Value', formatCurrency(financials.totalSale)],
      ['Total Received', formatCurrency(financials.totalReceived)],
      ['Total Receivable', formatCurrency(financials.totalReceivable)],
      ['Total Overdue', formatCurrency(financials.totalOverdue)],
      ['Future Receivable', formatCurrency(financials.totalFuture)],
      ['Percentage Paid', `${financials.percentagePaid.toFixed(1)}%`]
    ];
    
    tableData.forEach(row => {
      doc.text(row[0], 25, yPos);
      doc.text(row[1], 120, yPos, { align: 'right' });
      yPos += 7;
    });
    
    yPos += 10;
    
    // Customer Summary
    doc.setFontSize(12);
    doc.text('CUSTOMER SUMMARY', 20, yPos);
    yPos += 10;
    
    const customers = db.customers.filter(c => {
      if (c.type === 'broker') return false;
      
      if (reportType === 'overdue') {
        const financials = calculateCustomerFinancials(c.id);
        return financials.totalOverdue > 0;
      }
      
      if (reportType === 'follow_up') {
        const hasFollowUp = db.interactions.some(i => 
          (i.customerId === c.id) && i.status === 'follow_up'
        );
        return hasFollowUp;
      }
      
      return true;
    });
    
    if (customers.length === 0) {
      doc.setFontSize(10);
      doc.text('No customers match the selected criteria.', 25, yPos);
      yPos += 10;
    } else {
      customers.forEach(customer => {
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        
        const customerFinancials = calculateCustomerFinancials(customer.id);
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text(customer.name, 25, yPos);
        doc.setFont(undefined, 'normal');
        yPos += 7;
        
        doc.text(`Phone: ${customer.phone}`, 30, yPos);
        doc.text(`Sale: ${formatCurrency(customerFinancials.totalSale)}`, 100, yPos);
        yPos += 6;
        doc.text(`Balance: ${formatCurrency(customerFinancials.totalReceivable)}`, 30, yPos);
        doc.text(`Overdue: ${formatCurrency(customerFinancials.totalOverdue)}`, 100, yPos);
        yPos += 10;
      });
    }
    
    // Footer
    doc.setFontSize(8);
    doc.setTextColor(100, 116, 139);
    doc.text('Sitara Builders Recovery CRM | Enterprise Edition v3.0', 105, 285, { align: 'center' });
    
    doc.save(`${reportType}_report_${getDateString()}.pdf`);
    
    showNotification('success', 'Report Generated', 
      `${reportTitle} has been generated.`);
  } catch (error) {
    showNotification('error', 'Error', error.message);
  }
}

// Backup/Restore Functions
function openBackupModal() {
  const modal = document.getElementById('backupModal');
  const content = document.getElementById('backupContent');
  
  try {
    const backups = JSON.parse(localStorage.getItem(BACKUP_KEY) || '[]');
    
    if (backups.length === 0) {
      content.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--gray-400);">
          <div style="font-size: 3rem; margin-bottom: 16px;">üìÇ</div>
          <div style="font-size: 1.1rem; font-weight: 600; color: var(--gray-600);">
            No backups available
          </div>
          <div style="margin-top: 8px;">Create a backup first using the Export feature</div>
        </div>
      `;
    } else {
      let html = `
        <h4 style="margin-bottom: 20px;">Available Backups (${backups.length})</h4>
        <div style="max-height: 400px; overflow-y: auto;">
      `;
      
      backups.forEach((backup, index) => {
        const date = new Date(backup.timestamp);
        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        
        html += `
          <div style="border: 1px solid var(--gray-200); padding: 16px; border-radius: var(--radius); margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 600; color: var(--gray-900);">Backup ${index + 1}</div>
                <div style="font-size: 0.85rem; color: var(--gray-600); margin-top: 4px;">
                  ${formattedDate}
                </div>
                <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 4px;">
                  üìä ${backup.summary?.customers || 0} customers, 
                  üèó ${backup.summary?.projects || 0} projects,
                  üí¨ ${backup.summary?.interactions || 0} interactions
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-sm btn-primary" 
                        onclick="restoreBackup(${index})">
                  Restore
                </button>
                <button class="btn btn-sm btn-secondary" 
                        onclick="downloadBackup(${index})">
                  Download
                </button>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      content.innerHTML = html;
    }
  } catch (error) {
    content.innerHTML = `
      <div style="text-align: center; padding: 40px; color: var(--danger);">
        <div style="font-size: 3rem; margin-bottom: 16px;">‚ùå</div>
        <div style="font-size: 1.1rem; font-weight: 600;">
          Error loading backups
        </div>
      </div>
    `;
  }
  
  modal.classList.add('show');
}

function closeBackupModal() {
  document.getElementById('backupModal').classList.remove('show');
}

function restoreBackup(index) {
  if (!confirm('Restoring this backup will replace all current data. Are you sure?')) {
    return;
  }
  
  try {
    const backups = JSON.parse(localStorage.getItem(BACKUP_KEY) || '[]');
    const backup = backups[index];
    
    if (backup && backup.data) {
      db = backup.data;
      saveToStorage();
      refreshAll();
      closeBackupModal();
      
      showNotification('success', 'Restore Complete', 
        'Backup has been restored successfully.');
    } else {
      showNotification('error', 'Restore Failed', 'Backup data is invalid.');
    }
  } catch (error) {
    showNotification('error', 'Restore Failed', error.message);
  }
}

function downloadBackup(index) {
  try {
    const backups = JSON.parse(localStorage.getItem(BACKUP_KEY) || '[]');
    const backup = backups[index];
    
    if (backup) {
      const dataStr = JSON.stringify(backup.data, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const date = new Date(backup.timestamp);
      const filename = `sitara_backup_${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}_${date.getHours()}-${date.getMinutes()}.json`;
      
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      showNotification('success', 'Download Complete', 
        'Backup file has been downloaded.');
    }
  } catch (error) {
    showNotification('error', 'Download Failed', error.message);
  }
}

// Import Function
function handleImport(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      
      if (!confirm('Importing data will replace current data. Are you sure you want to continue?')) {
        event.target.value = '';
        return;
      }
      
      if (importedData.customers && Array.isArray(importedData.customers)) {
        db = importedData;
        saveToStorage();
        refreshAll();
        
        showNotification('success', 'Import Successful', 
          'Data has been imported successfully.');
      } else {
        showNotification('error', 'Import Failed', 'Invalid data format.');
      }
    } catch (error) {
      showNotification('error', 'Import Failed', error.message);
    }
    event.target.value = '';
  };
  reader.readAsText(file);
}

// Initialize the application
function init() {
  // Load data from storage
  loadFromStorage();
  initializeMasterProjects();



  if (!db.inventory || db.inventory.length === 0) {
    initializeInventoryFromProjects();  // Call the function you created
  }
  // Set up event listeners
  setupEventListeners();
  
  // Populate initial UI
  populateSelects();
  populateProjectSelects();
  updateDashboard();
  
  // Set default dates
  setDefaultDates();
  
  // Auto-save every 30 seconds
  setInterval(() => {
      if (document.getElementById('interactions').classList.contains('active')) {
    renderLeadsDashboard();
  }
    saveToStorage();
  }, 30000);
  
  // Show welcome notification
  setTimeout(() => {
    showNotification('success', 'Welcome to Sitara Builders CRM', 
      'Enterprise Recovery CRM v3.0 loaded successfully.');
  }, 1000);
}

function setupEventListeners() {
  // Set default dates for date inputs
  const today = getDateString();
  const now = getDateTimeString();
  
  document.querySelectorAll('input[type="date"]').forEach(input => {
    if (!input.value && !input.hasAttribute('data-no-default')) {
      input.value = today;
    }
  });
  
  document.querySelectorAll('input[type="datetime-local"]').forEach(input => {
    if (!input.value) {
      input.value = now;
    }
  });
  
  // Set filter dates to today
  const dateFilter = document.getElementById('receiptDateFilter');
  if (dateFilter) {
    dateFilter.value = today;
  }
}

function setDefaultDates() {
  const today = getDateString();
  const now = getDateTimeString();
  
  // Set today's date for date inputs in modals
  document.querySelectorAll('input[type="date"]:not([data-no-default])').forEach(input => {
    if (!input.value) {
      input.value = today;
    }
  });
  
  document.querySelectorAll('input[type="datetime-local"]').forEach(input => {
    if (!input.value) {
      input.value = now;
    }
  });
}

function refreshAll() {
  updateDashboard();
  renderCustomersTable();
  renderProjectsTable();
  renderInventoryTable(); // Add this line
  renderInteractionsTable();
  renderReceiptsTable();
  updateReports();
  populateSelects();
  populateProjectSelects(); // Add this line
  renderLeadsDashboard();
}

// Initialize on load
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>


